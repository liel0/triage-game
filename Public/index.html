<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>AI Triage Drone 2040 – Desktop</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    :root {
      --bg-main: #040715;
      --bg-panel: #0c1022;
      --bg-panel-soft: #10152b;
      --bg-chip: #151b32;
      --accent-blue: #3aa9ff;
      --accent-blue-soft: rgba(58, 169, 255, 0.18);
      --accent-green: #43e5a2;
      --accent-red: #ff6b81;
      --accent-yellow: #ffd86b;
      --accent-purple: #a58cff;
      --text-main: #f5f7ff;
      --text-soft: #b7c0e5;
      --text-muted: #6b7296;
      --border-soft: #212845;
      --danger: #ff4b6e;
      --success: #43e5a2;
      --chip-radius: 32px;
      --transition-fast: 0.2s ease-out;
      --transition-med: 0.35s ease-out;
      --shadow-soft: 0 12px 40px rgba(0, 0, 0, 0.7);
      --shadow-inner: 0 0 0 1px rgba(255, 255, 255, 0.02),
        0 0 40px rgba(0, 0, 0, 0.85);
      --font-sans: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI",
        sans-serif;
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: var(--font-sans);
      background: radial-gradient(circle at 20% 0, #1a2440 0, #040715 45%)
        fixed;
      color: var(--text-main);
      min-height: 100vh;
      padding: 18px 18px 26px;
      overflow-x: hidden;
    }

    /* ---------- LAYOUT ---------- */

    .app-shell {
      display: grid;
      grid-template-rows: auto 1fr;
      gap: 12px;
      max-width: 1920px;
      margin: 0 auto;
      height: calc(100vh - 36px);
    }

    header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 10px 16px;
      border-radius: 999px;
      background: linear-gradient(90deg, #0c1022, #141a36);
      box-shadow: var(--shadow-soft);
      border: 1px solid rgba(136, 175, 255, 0.12);
    }

    .brand {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .brand-mark {
      width: 28px;
      height: 28px;
      border-radius: 10px;
      background: radial-gradient(circle at 30% 20%, #ffffff, #20b4ff 35%, #3459ff 70%);
      box-shadow: 0 0 20px rgba(88, 180, 255, 0.7);
      position: relative;
    }

    .brand-mark::after {
      content: "";
      position: absolute;
      inset: 7px;
      border-radius: 6px;
      border: 2px solid rgba(4, 7, 21, 0.9);
    }

    .brand-title {
      display: flex;
      flex-direction: column;
      gap: 1px;
    }

    .brand-title span:first-child {
      font-size: 14px;
      letter-spacing: 0.16em;
      text-transform: uppercase;
      color: var(--accent-blue);
    }

    .brand-title span:last-child {
      font-size: 11px;
      color: var(--text-muted);
    }

    .header-right {
      display: flex;
      align-items: center;
      gap: 14px;
      font-size: 11px;
      color: var(--text-muted);
    }

    .operator-pill {
      padding: 4px 10px;
      border-radius: 999px;
      background: rgba(9, 205, 144, 0.08);
      border: 1px solid rgba(67, 229, 162, 0.35);
      color: var(--success);
    }

    .grid-main {
      display: grid;
      grid-template-columns: minmax(0, 1.2fr) minmax(0, 1fr);
      grid-template-rows: minmax(0, 1.1fr) minmax(0, 1fr);
      gap: 12px;
      height: 100%;
    }

    .card {
      background: radial-gradient(circle at 0 0, #1c2545 0, #070a17 32%, #050716 100%);
      border-radius: 22px;
      border: 1px solid rgba(128, 160, 255, 0.12);
      box-shadow: var(--shadow-soft);
      padding: 14px 16px;
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }

    .card-header {
      display: flex;
      align-items: baseline;
      justify-content: space-between;
      margin-bottom: 10px;
      gap: 12px;
    }

    .card-title {
      font-size: 14px;
      letter-spacing: 0.08em;
      text-transform: uppercase;
      color: var(--text-soft);
    }

    .card-subtitle {
      font-size: 11px;
      color: var(--text-muted);
    }

    /* ---------- PATIENT BODY MAP + SILHOUETTE ---------- */

    .body-map {
      display: grid;
      grid-template-columns: minmax(0, 1.2fr) minmax(0, 0.8fr);
      gap: 16px;
      flex: 1;
      min-height: 0;
    }

    .scan-list {
      display: flex;
      flex-direction: column;
      gap: 8px;
      overflow-y: auto;
      padding-right: 4px;
    }

    .scan-row {
      position: relative;
      padding: 8px 14px 10px;
      border-radius: var(--chip-radius);
      border: 1px solid rgba(141, 164, 255, 0.16);
      background: radial-gradient(circle at 0 0, #1d2645 0, #050716 65%);
      box-shadow: var(--shadow-inner);
      cursor: default;
      overflow: hidden;
      transition: border-color var(--transition-fast),
        box-shadow var(--transition-fast),
        transform var(--transition-fast),
        background var(--transition-med);
    }

    .scan-row::before {
      content: "";
      position: absolute;
      inset: 0;
      background: linear-gradient(90deg, rgba(80, 150, 255, 0.18), transparent);
      opacity: 0;
      transition: opacity var(--transition-med);
      pointer-events: none;
    }

    .scan-row.scanned {
      border-color: rgba(67, 229, 162, 0.55);
      background: radial-gradient(circle at 10% 0, #16344c 0, #050716 72%);
      transform: translateY(-1px);
      box-shadow: 0 0 0 1px rgba(32, 247, 179, 0.15),
        0 18px 40px rgba(0, 0, 0, 0.85);
    }

    .scan-row.scanned::before {
      opacity: 1;
    }

    .scan-row-label {
      font-size: 13px;
      color: var(--text-soft);
    }

    .scan-row-status {
      font-size: 11px;
      color: var(--text-muted);
      margin-top: 2px;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .status-dot {
      width: 7px;
      height: 7px;
      border-radius: 999px;
      background: #424a73;
    }

    .scan-row.scanned .status-dot {
      background: var(--success);
      box-shadow: 0 0 10px rgba(67, 229, 162, 0.8);
    }

    .scan-row-tag {
      position: absolute;
      right: 12px;
      top: 9px;
      font-size: 10px;
      text-transform: uppercase;
      letter-spacing: 0.1em;
      padding: 2px 8px;
      border-radius: 999px;
      background: rgba(15, 216, 199, 0.08);
      color: #8df5e4;
      border: 1px solid rgba(55, 247, 208, 0.32);
    }

    .scan-row-tag span {
      font-weight: 600;
    }

    .body-silhouette-wrapper {
      position: relative;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 8px 4px 8px 8px;
    }

    .body-silhouette-shell {
      position: relative;
      width: 260px;
      max-width: 100%;
      aspect-ratio: 1 / 2.3;
      border-radius: 999px;
      background: radial-gradient(circle at 30% 0, #283a67 0, #050716 55%, #000 100%);
      padding: 16px 18px;
      box-shadow: 0 22px 60px rgba(0, 0, 0, 0.9);
      border: 1px solid rgba(132, 168, 255, 0.25);
    }

    .body-silhouette-base {
      position: absolute;
      inset: 12px 20px;
      background: url("images/body-silhouette-base.png") center/contain
        no-repeat;
      opacity: 0.35;
      filter: drop-shadow(0 0 18px rgba(71, 111, 190, 0.7));
      pointer-events: none;
    }

    .body-segments {
      position: absolute;
      inset: 12px 24px;
      display: flex;
      flex-direction: column;
      justify-content: stretch;
      gap: 4px;
    }

    .body-segment {
      flex: 1;
      border-radius: 999px;
      background: radial-gradient(circle at 50% 0, rgba(72, 125, 255, 0.0), rgba(4, 7, 21, 0.9));
      border: 1px solid rgba(80, 115, 210, 0.35);
      box-shadow: inset 0 0 20px rgba(0, 0, 0, 0.85);
      overflow: hidden;
      position: relative;
    }

    .body-segment-fill {
      position: absolute;
      inset: 0;
      background: radial-gradient(circle at 20% 0, rgba(90, 200, 255, 0.22), rgba(32, 247, 179, 0.28));
      opacity: 0;
      transform: translateY(18%);
      transition: opacity 0.5s ease-out, transform 0.55s cubic-bezier(0.15, 0.8, 0.25, 1);
      pointer-events: none;
    }

    .body-segment.filled .body-segment-fill {
      opacity: 1;
      transform: translateY(0);
    }

    .body-silhouette-outline {
      position: absolute;
      inset: 22px 32px;
      background: url("images/body-silhouette-fill.png") center/contain
        no-repeat;
      mix-blend-mode: screen;
      opacity: 0.0;
      pointer-events: none;
      transition: opacity 0.4s ease-out;
    }

    .body-silhouette-shell.all-filled .body-silhouette-outline {
      opacity: 0.32;
    }

    .body-silhouette-footer {
      position: absolute;
      left: 50%;
      bottom: 12px;
      transform: translateX(-50%);
      font-size: 10px;
      color: var(--text-muted);
      text-align: center;
      max-width: 90%;
    }

    /* ENVELOPES VIEW */

    .envelope-layer {
      position: absolute;
      inset: 18px 24px;
      pointer-events: none;
      opacity: 0;
      transition: opacity 0.35s ease-out;
    }

    .body-silhouette-shell.envelope-mode .envelope-layer {
      pointer-events: auto;
      opacity: 1;
    }

    .envelope-hotspot {
      position: absolute;
      left: 56%;
      transform: translateX(-50%);
      width: 32px;
      height: 22px;
      border-radius: 6px;
      background: rgba(7, 213, 186, 0.12);
      border: 1px solid rgba(67, 229, 162, 0.75);
      box-shadow: 0 0 10px rgba(6, 214, 176, 0.7);
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
    }

    .envelope-hotspot svg {
      width: 18px;
      height: 18px;
      fill: #9ff9dd;
    }

    .envelope-hotspot[data-index="0"] { top: 4%; }
    .envelope-hotspot[data-index="1"] { top: 16%; }
    .envelope-hotspot[data-index="2"] { top: 29%; }
    .envelope-hotspot[data-index="3"] { top: 42%; }
    .envelope-hotspot[data-index="4"] { top: 55%; }
    .envelope-hotspot[data-index="5"] { top: 69%; }
    .envelope-hotspot[data-index="6"] { top: 82%; }

    /* ---------- LIVE VITALS & TIMER ---------- */

    .vitals-list {
      list-style: none;
      margin-top: 4px;
      border-radius: 16px;
      border: 1px solid rgba(141, 164, 255, 0.25);
      overflow: hidden;
    }

    .vitals-row {
      padding: 6px 10px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 11px;
      background: radial-gradient(circle at 0 0, #181f3c 0, #050716 65%);
      border-bottom: 1px solid rgba(45, 55, 104, 0.85);
    }

    .vitals-row:last-child {
      border-bottom: none;
    }

    .vitals-label {
      color: var(--text-soft);
    }

    .vitals-value {
      color: var(--accent-blue);
    }

    .timer-panel {
      margin-top: 10px;
      padding: 10px 12px;
      border-radius: 18px;
      border: 1px solid rgba(250, 184, 81, 0.8);
      background: radial-gradient(circle at 0 0, #3b2733 0, #100912 60%);
      color: #ffe7b9;
      font-size: 11px;
      position: relative;
      overflow: hidden;
    }

    .timer-title-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 4px;
    }

    .timer-title {
      font-size: 12px;
      letter-spacing: 0.14em;
      text-transform: uppercase;
    }

    .timer-value {
      font-size: 16px;
      font-variant-numeric: tabular-nums;
    }

    .timer-panel small {
      color: rgba(253, 228, 176, 0.85);
    }

    .timer-panel::after {
      content: "";
      position: absolute;
      inset: -30%;
      background: radial-gradient(circle at 0 0, rgba(255, 180, 92, 0.5), transparent 60%);
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.4s ease-out;
    }

    .timer-panel.running::after {
      opacity: 0.4;
    }

    /* ---------- HUMAN TRIAGE DECISION ---------- */

    .triage-layout {
      display: grid;
      grid-template-columns: minmax(0, 0.8fr) minmax(0, 1.2fr);
      gap: 16px;
      flex: 1;
      min-height: 0;
    }

    .triage-column {
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .section-label {
      font-size: 11px;
      letter-spacing: 0.18em;
      text-transform: uppercase;
      color: var(--text-muted);
      margin-bottom: 4px;
    }

    .triage-badges {
      display: flex;
      gap: 10px;
    }

    .triage-badge {
      flex: 1;
      padding: 9px 10px;
      border-radius: 14px;
      border: 1px solid rgba(255, 255, 255, 0.05);
      background: radial-gradient(circle at 0 0, #262746 0, #050716 65%);
      color: var(--text-soft);
      font-size: 11px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      cursor: pointer;
      transition: background var(--transition-med),
        border-color var(--transition-med),
        transform var(--transition-fast),
        box-shadow var(--transition-fast);
    }

    .triage-badge:hover {
      transform: translateY(-1px);
      box-shadow: 0 10px 26px rgba(0, 0, 0, 0.85);
    }

    .triage-badge-dot {
      width: 14px;
      height: 14px;
      border-radius: 999px;
      border: 2px solid rgba(255, 255, 255, 0.08);
      margin-right: 6px;
    }

    .triage-badge[data-color="red"] .triage-badge-dot {
      background: var(--accent-red);
    }

    .triage-badge[data-color="yellow"] .triage-badge-dot {
      background: var(--accent-yellow);
    }

    .triage-badge[data-color="green"] .triage-badge-dot {
      background: var(--accent-green);
    }

    .triage-badge[data-color="black"] .triage-badge-dot {
      background: #bbbbbb;
    }

    .triage-badge.active {
      border-color: rgba(255, 255, 255, 0.55);
      background: radial-gradient(circle at 10% 0, rgba(255, 255, 255, 0.18), #050716 72%);
    }

    .triage-badge-label {
      display: flex;
      align-items: center;
      gap: 3px;
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 0.1em;
    }

    .triage-badge-desc {
      font-size: 10px;
      color: var(--text-muted);
    }

    .hospital-list {
      border-radius: 16px;
      border: 1px solid rgba(141, 164, 255, 0.2);
      overflow: hidden;
    }

    .hospital-row {
      padding: 8px 12px;
      background: radial-gradient(circle at 0 0, #1b2140 0, #050716 68%);
      border-bottom: 1px solid rgba(44, 55, 100, 0.85);
      cursor: pointer;
      transition: background var(--transition-med);
    }

    .hospital-row:hover {
      background: radial-gradient(circle at 0 0, #28325a 0, #050716 72%);
    }

    .hospital-row:last-child {
      border-bottom: none;
    }

    .hospital-name {
      font-size: 12px;
      color: var(--text-soft);
    }

    .hospital-desc {
      font-size: 10px;
      color: var(--text-muted);
    }

    .hospital-row.active {
      background: radial-gradient(circle at 0 0, #324174 0, #050716 72%);
      border-left: 2px solid var(--accent-blue);
    }

    .er-tests-list {
      border-radius: 16px;
      border: 1px solid rgba(141, 164, 255, 0.2);
      padding: 6px 10px 8px;
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
    }

    .er-test-chip {
      padding: 4px 9px;
      border-radius: 999px;
      border: 1px solid rgba(143, 167, 255, 0.4);
      background: radial-gradient(circle at 0 0, rgba(72, 110, 206, 0.35), #050716 68%);
      font-size: 11px;
      color: var(--text-soft);
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 4px;
      transition: background var(--transition-med), transform var(--transition-fast),
        box-shadow var(--transition-fast), border-color var(--transition-fast);
    }

    .er-test-chip span.dot {
      width: 8px;
      height: 8px;
      border-radius: 999px;
      background: rgba(111, 136, 255, 0.73);
    }

    .er-test-chip.active {
      background: radial-gradient(circle at 0 0, rgba(67, 229, 162, 0.35), #050716 68%);
      border-color: rgba(71, 242, 184, 0.8);
      box-shadow: 0 0 0 1px rgba(56, 241, 183, 0.3),
        0 12px 32px rgba(0, 0, 0, 0.9);
    }

    .er-test-chip.active span.dot {
      background: var(--success);
    }

    .triage-footer {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-top: 10px;
      gap: 12px;
      font-size: 11px;
      color: var(--text-muted);
    }

    .triage-footer-buttons {
      display: flex;
      gap: 10px;
    }

    .btn {
      border-radius: 999px;
      border: 1px solid rgba(140, 164, 255, 0.5);
      padding: 7px 16px;
      font-size: 11px;
      font-weight: 500;
      letter-spacing: 0.08em;
      text-transform: uppercase;
      background: radial-gradient(circle at 0 0, #354782 0, #050716 68%);
      color: var(--text-main);
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      transition: background var(--transition-med),
        transform var(--transition-fast),
        box-shadow var(--transition-fast),
        border-color var(--transition-fast),
        color var(--transition-fast),
        opacity 0.2s;
    }

    .btn:hover:not(:disabled) {
      transform: translateY(-1px);
      box-shadow: 0 12px 32px rgba(0, 0, 0, 0.85);
      border-color: rgba(170, 190, 255, 0.9);
    }

    .btn:disabled {
      opacity: 0.4;
      cursor: default;
    }

    .btn-primary {
      background: radial-gradient(circle at 0 0, #45b2ff 0, #1b7cff 50%, #021744 100%);
      border-color: rgba(105, 189, 255, 0.95);
    }

    .btn-ghost {
      background: transparent;
      border-color: rgba(151, 170, 255, 0.4);
      color: var(--text-soft);
    }

    .btn-danger {
      background: radial-gradient(circle at 0 0, #ff5b7a 0, #7f1730 65%, #21040d 100%);
      border-color: rgba(255, 143, 164, 0.85);
    }

    /* ---------- HUMAN vs AI RESULTS + LEADERBOARD ---------- */

    .results-grid {
      display: grid;
      grid-template-rows: auto 1fr;
      gap: 10px;
      flex: 1;
      min-height: 0;
    }

    .match-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 11px;
      margin-top: 4px;
    }

    .match-table th,
    .match-table td {
      padding: 4px 6px;
      text-align: left;
    }

    .match-table thead {
      background: radial-gradient(circle at 0 0, #202b53 0, #050716 65%);
    }

    .match-table tbody tr {
      background: radial-gradient(circle at 0 0, #11172e 0, #050716 68%);
    }

    .match-table tbody tr + tr {
      border-top: 1px solid rgba(45, 57, 105, 0.8);
    }

    .match-table th {
      font-weight: 600;
      letter-spacing: 0.14em;
      text-transform: uppercase;
      color: var(--text-muted);
    }

    .match-table td {
      color: var(--text-soft);
    }

    .match-tag-ok {
      color: var(--success);
    }

    .match-tag-bad {
      color: var(--danger);
    }

    .score-row {
      font-size: 11px;
      margin-top: 6px;
      color: var(--text-soft);
      display: flex;
      justify-content: space-between;
    }

    .score-row strong {
      color: var(--accent-blue);
    }

    /* LEADERBOARD */

    .leaderboard-card {
      margin-top: 6px;
      padding: 8px 10px;
      border-radius: 16px;
      border: 1px solid rgba(141, 164, 255, 0.25);
      background: radial-gradient(circle at 0 0, #1a203e 0, #050716 72%);
      display: flex;
      flex-direction: column;
      gap: 4px;
      height: 100%;
      min-height: 0;
    }

    .leaderboard-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .leaderboard-title {
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 0.14em;
      color: var(--text-muted);
    }

    .leaderboard-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 11px;
      margin-top: 4px;
    }

    .leaderboard-table th,
    .leaderboard-table td {
      padding: 3px 4px;
      text-align: left;
      white-space: nowrap;
    }

    .leaderboard-table thead {
      border-bottom: 1px solid rgba(68, 80, 135, 0.8);
      color: var(--text-muted);
    }

    .leaderboard-table tbody tr {
      border-bottom: 1px solid rgba(24, 30, 60, 0.9);
    }

    .leaderboard-table tbody tr:last-child {
      border-bottom: none;
    }

    .leaderboard-table th:nth-child(1),
    .leaderboard-table td:nth-child(1) {
      width: 4%;
    }

    .leaderboard-table th:nth-child(2),
    .leaderboard-table td:nth-child(2) {
      width: 20%;
    }

    .leaderboard-table th:nth-child(3),
    .leaderboard-table td:nth-child(3) {
      width: 9%;
    }

    .leaderboard-table th:nth-child(4),
    .leaderboard-table td:nth-child(4) {
      width: 32%;
    }

    .leaderboard-table th:nth-child(5),
    .leaderboard-table td:nth-child(5) {
      width: 9%;
      text-align: right;
    }

    .leaderboard-table th:nth-child(6),
    .leaderboard-table td:nth-child(6) {
      width: 9%;
      text-align: right;
    }

    .leaderboard-table tbody td:nth-child(5),
    .leaderboard-table tbody td:nth-child(6) {
      color: var(--accent-blue);
      font-variant-numeric: tabular-nums;
    }

    .lb-buttons {
      display: flex;
      gap: 8px;
    }

    .btn-small {
      padding: 5px 10px;
      font-size: 10px;
    }

    /* ---------- MODAL ---------- */

    .modal-backdrop {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.78);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 40;
    }

    .modal-backdrop.active {
      display: flex;
    }

    .modal {
      background: #050716;
      border-radius: 16px;
      border: 1px solid rgba(135, 168, 255, 0.6);
      box-shadow: 0 26px 60px rgba(0, 0, 0, 0.95);
      max-width: 960px;
      width: 90%;
      max-height: 90vh;
      padding: 10px 12px 12px;
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 12px;
    }

    .modal-header span {
      color: var(--text-soft);
    }

    .modal-body {
      flex: 1;
      min-height: 0;
      border-radius: 12px;
      background: #02030a;
      padding: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .modal-body img {
      max-width: 100%;
      max-height: 72vh;
      border-radius: 10px;
    }

    .modal-close {
      cursor: pointer;
      font-size: 18px;
      line-height: 1;
      padding: 4px 8px;
      border-radius: 999px;
      border: 1px solid rgba(151, 168, 255, 0.6);
      background: radial-gradient(circle at 0 0, #202853 0, #050716 68%);
    }

    /* ---------- RESPONSIVE (desktop-focused, minimal) ---------- */
    @media (max-width: 1100px) {
      body {
        padding: 10px;
      }
      .grid-main {
        grid-template-columns: 1fr;
        grid-template-rows: auto auto auto auto;
      }
      .body-map {
        grid-template-columns: minmax(0, 1.1fr) minmax(0, 0.9fr);
      }
    }

    @media (max-width: 900px) {
      .body-map {
        grid-template-columns: 1fr;
      }
      .triage-layout {
        grid-template-columns: 1fr;
      }
    }
  </style>
</head>
<body>
<div class="app-shell">
  <header>
    <div class="brand">
      <div class="brand-mark"></div>
      <div class="brand-title">
        <span>AI TRIAGE DRONE 2040</span>
        <span>Mass casualty triage training • Human vs AI</span>
      </div>
    </div>
    <div class="header-right">
      <div>Mode: <strong id="modeLabel">Solo</strong></div>
      <div class="operator-pill">
        Operator: Waiting for mobile operator…
      </div>
    </div>
  </header>

  <div class="grid-main">
    <!-- PATIENT BODY MAP + SILHOUETTE -->
    <section class="card">
      <div class="card-header">
        <div>
          <div class="card-title">Patient Body Map &amp; Drone Feed</div>
          <div class="card-subtitle">
            Scan QR tags from head to toe. Silhouette fills as you scan.
          </div>
        </div>
        <div>
          <select id="scenarioSelect" style="background:#050716;border-radius:999px;border:1px solid rgba(141,164,255,0.4);color:var(--text-soft);padding:6px 12px;font-size:11px;">
          </select>
        </div>
      </div>

      <div class="body-map">
        <div class="scan-list" id="scanList">
          <!-- rows injected -->
        </div>
        <div class="body-silhouette-wrapper">
          <div class="body-silhouette-shell" id="bodyShell">
            <div class="body-silhouette-base"></div>
            <div class="body-segments" id="bodySegments">
              <!-- segments injected -->
            </div>
            <div class="body-silhouette-outline"></div>
            <div class="envelope-layer" id="envelopeLayer">
              <!-- envelopes injected -->
            </div>
            <div class="body-silhouette-footer" id="silhouetteFooter">
              Scan all body regions in order. When complete, continue to triage.
            </div>
          </div>
        </div>
      </div>

      <div style="margin-top:8px;font-size:11px;color:var(--text-muted);">
        <strong>Scan order:</strong>
        <span id="scanOrderLabel"></span>
      </div>
    </section>

    <!-- LIVE VITALS -->
    <section class="card">
      <div class="card-header">
        <div>
          <div class="card-title">Live Vitals (from drone)</div>
          <div class="card-subtitle">Values update after each QR scan.</div>
        </div>
      </div>

      <ul class="vitals-list" id="vitalsList">
        <!-- rows injected -->
      </ul>

      <div class="timer-panel" id="timerPanel">
        <div class="timer-title-row">
          <div class="timer-title">PATIENT LOADING • TRIAGE TIMER</div>
          <div class="timer-value"><span id="timerValue">0.00</span> s</div>
        </div>
        <small id="timerHint">
          Scan all QR tags first. The timer will start when you continue to triage.
        </small>
      </div>

      <div style="margin-top:12px;font-size:11px;color:var(--text-muted);">
        <div style="margin-bottom:4px;"><strong>Coming soon:</strong> AI Paramedic Support Module</div>
        <div>
          Drone will recommend the exact medical tools paramedics should bring from the hospital based on injuries.
        </div>
      </div>
    </section>

    <!-- HUMAN TRIAGE DECISION -->
    <section class="card">
      <div class="card-header">
        <div>
          <div class="card-title">Human Triage Decision</div>
          <div class="card-subtitle">
            Complete triage only after all scans are done. Then submit to compare with AI.
          </div>
        </div>
      </div>

      <div class="triage-layout">
        <div class="triage-column">
          <div>
            <div class="section-label">Step 1 — Choose triage category</div>
            <div class="triage-badges" id="triageBadges">
              <div class="triage-badge" data-color="red">
                <div class="triage-badge-label">
                  <div class="triage-badge-dot"></div>
                  <span>Red</span>
                </div>
                <div class="triage-badge-desc">Immediate</div>
              </div>
              <div class="triage-badge" data-color="yellow">
                <div class="triage-badge-label">
                  <div class="triage-badge-dot"></div>
                  <span>Yellow</span>
                </div>
                <div class="triage-badge-desc">Urgent but delayed</div>
              </div>
              <div class="triage-badge" data-color="green">
                <div class="triage-badge-label">
                  <div class="triage-badge-dot"></div>
                  <span>Green</span>
                </div>
                <div class="triage-badge-desc">Minimal</div>
              </div>
              <div class="triage-badge" data-color="black">
                <div class="triage-badge-label">
                  <div class="triage-badge-dot"></div>
                  <span>Black</span>
                </div>
                <div class="triage-badge-desc">Expectant / deceased</div>
              </div>
            </div>
          </div>

          <div>
            <div class="section-label">Step 2 — Choose receiving hospital</div>
            <div class="hospital-list" id="hospitalList">
              <!-- rows injected -->
            </div>
          </div>
        </div>

        <div class="triage-column">
          <div>
            <div class="section-label">Step 3 — Choose ER tests</div>
            <div class="er-tests-list" id="erTestsList">
              <!-- chips injected -->
            </div>
          </div>

          <div class="triage-footer">
            <div>
              <div style="margin-bottom:2px;">Complete triage, hospital, and ER tests after scanning all regions.</div>
              <div id="triageStatusMessage"></div>
            </div>
            <div class="triage-footer-buttons">
              <button class="btn btn-ghost" id="btnContinueToTriage" disabled>
                Continue to triage
              </button>
              <button class="btn btn-primary" id="btnSubmitDecision" disabled>
                Submit decision
              </button>
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- HUMAN vs AI RESULTS -->
    <section class="card">
      <div class="results-grid">
        <div>
          <div class="card-header" style="margin-bottom:4px;">
            <div>
              <div class="card-title">Human vs AI Results</div>
              <div class="card-subtitle">
                Compare your triage, hospital choice, and tests with the AI recommendation.
              </div>
            </div>
          </div>

          <table class="match-table">
            <thead>
            <tr>
              <th>Category</th>
              <th>Human</th>
              <th>AI</th>
              <th>Match</th>
            </tr>
            </thead>
            <tbody>
            <tr>
              <td>Triage</td>
              <td id="humanTriageCell">—</td>
              <td id="aiTriageCell">—</td>
              <td id="triageMatchCell">—</td>
            </tr>
            <tr>
              <td>Hospital</td>
              <td id="humanHospitalCell">—</td>
              <td id="aiHospitalCell">—</td>
              <td id="hospitalMatchCell">—</td>
            </tr>
            <tr>
              <td>ER tests</td>
              <td id="humanTestsCell">—</td>
              <td id="aiTestsCell">—</td>
              <td id="testsMatchCell">—</td>
            </tr>
            <tr>
              <td>Time</td>
              <td id="humanTimeCell">—</td>
              <td id="aiTimeCell">Target &lt; 90 s</td>
              <td id="timeMatchCell">—</td>
            </tr>
            </tbody>
          </table>

          <div class="score-row">
            <span>Score: <strong id="scoreValue">0 / 12</strong> points</span>
            <span id="scoreDetail"></span>
          </div>
        </div>

        <div class="leaderboard-card">
          <div class="leaderboard-header">
            <div class="leaderboard-title">Live leaderboard</div>
            <div class="lb-buttons">
              <button class="btn btn-ghost btn-small" id="btnResetSimulation">
                Reset simulation
              </button>
              <button class="btn btn-danger btn-small" id="btnResetBoard">
                Reset board
              </button>
            </div>
          </div>

          <table class="leaderboard-table" id="leaderboardTable">
            <thead>
            <tr>
              <th>#</th>
              <th>Name</th>
              <th>Mode</th>
              <th>Scenario</th>
              <th>Score</th>
              <th>Time</th>
            </tr>
            </thead>
            <tbody>
            <!-- rows injected -->
            </tbody>
          </table>
        </div>
      </div>
    </section>
  </div>
</div>

<!-- MODAL FOR IMAGES -->
<div class="modal-backdrop" id="imageModal">
  <div class="modal">
    <div class="modal-header">
      <span id="modalTitle">Scan image</span>
      <button class="modal-close" id="modalCloseBtn">&times;</button>
    </div>
    <div class="modal-body">
      <img id="modalImage" src="" alt="Scan image" />
    </div>
  </div>
</div>

<script>
  // --------- DATA MODEL ---------

  const scenarios = [
    {
      id: 1,
      label: "Scenario 1 — Hajj Stampede (Red)",
      short: "S1 Red",
      triage: "red",
      aiTriageLabel: "Red – Immediate",
      hospitals: [
        {
          id: "mina",
          name: "Mina Emergency Hospital",
          desc: "Closest high-emergency facility",
          isCorrect: true
        },
        {
          id: "kingFahad",
          name: "King Fahad Medical City — Trauma Centre",
          desc: "Level 1 trauma centre, Riyadh",
          isCorrect: false
        },
        {
          id: "dhahran",
          name: "Dhahran Trauma Center",
          desc: "Highway critical care hub",
          isCorrect: false
        }
      ],
      erTests: [
        { id: "fast", label: "FAST ultrasound", correct: true },
        { id: "lactate", label: "Serum lactate", correct: true },
        { id: "crossmatch", label: "Blood typing and crossmatch", correct: true },
        { id: "ctHead", label: "CT head (non-contrast)", correct: false },
        { id: "dDimer", label: "D-dimer", correct: false },
        { id: "urinalysis", label: "Urinalysis", correct: false }
      ],
      vitalsDisplay: [
        { id: "consciousness", label: "Consciousness", value: "Unresponsive, pale, shallow breathing" },
        { id: "rr", label: "Respiratory rate (RR)", value: "34 / min" },
        { id: "hr", label: "Heart rate (HR)", value: "142 bpm" },
        { id: "bp", label: "Blood pressure (BP)", value: "78 / 45 mmHg" },
        { id: "injury", label: "Key injury / problem", value: "Severe bleeding from lower abdomen, suspected pelvic fracture" }
      ],
      scanSteps: [
        { key: "id", label: "Eyes / ID", description: "Demographics, patient ID" },
        { key: "conclevel", label: "Face – Consciousness", description: "Facial analysis – consciousness level" },
        { key: "hr", label: "Neck – Heart rate", description: "Neck Doppler / HR" },
        { key: "rr", label: "Chest – Respiratory rate", description: "Respiratory module – measuring RR" },
        { key: "bp", label: "Arms – Blood pressure", description: "BP cuff – perfusion" },
        { key: "injury1", label: "Pelvis / Abdomen – Injury 1", description: "FAST ultrasound – bleeding" },
        { key: "injury2", label: "Legs / Feet – Injury 2", description: "Secondary injury" }
      ]
    },
    {
      id: 2,
      label: "Scenario 2 — Riyadh Industrial Explosion (Yellow)",
      short: "S2 Yellow",
      triage: "yellow",
      aiTriageLabel: "Yellow – Urgent but delayed",
      hospitals: [
        {
          id: "kingFahad",
          name: "King Fahad Medical City — Trauma Centre",
          desc: "Best burn + respiratory support",
          isCorrect: true
        },
        {
          id: "mina",
          name: "Mina Emergency Hospital",
          desc: "Milder burns unit",
          isCorrect: false
        },
        {
          id: "dhahran",
          name: "Dhahran Trauma Center",
          desc: "Farther from industrial zone",
          isCorrect: false
        }
      ],
      erTests: [
        { id: "carboxy", label: "Carboxyhemoglobin level", correct: true },
        { id: "chestXray", label: "Chest X-ray", correct: true },
        { id: "burnDepth", label: "Burn depth assessment", correct: true },
        { id: "ecg", label: "ECG (rule out cardiac stress)", correct: true },
        { id: "fast", label: "FAST ultrasound", correct: false },
        { id: "ctAbdomen", label: "CT abdomen with contrast", correct: false }
      ],
      vitalsDisplay: [
        { id: "consciousness", label: "Consciousness", value: "Alert but disoriented" },
        { id: "rr", label: "Respiratory rate (RR)", value: "26 / min" },
        { id: "hr", label: "Heart rate (HR)", value: "110 bpm" },
        { id: "bp", label: "Blood pressure (BP)", value: "100 / 70 mmHg" },
        { id: "injury", label: "Key injury / problem", value: "Burns to arms and face, chest tightness & dizziness" }
      ],
      scanSteps: [
        { key: "id", label: "Eyes / ID", description: "ID & demographics" },
        { key: "conclevel", label: "Face – Consciousness", description: "Facial expression, pain" },
        { key: "hr", label: "Neck – Heart rate", description: "Pulse / HR" },
        { key: "rr", label: "Chest – Respiratory rate", description: "RR & chest effort" },
        { key: "bp", label: "Arms – Blood pressure", description: "BP & perfusion" },
        { key: "injury1", label: "Pelvis / Abdomen – Injury 1", description: "Noted burns extension" },
        { key: "injury2", label: "Legs / Feet – Injury 2", description: "Secondary burns / debris" }
      ]
    },
    {
      id: 3,
      label: "Scenario 3 — Desert Rally Dehydration (Green)",
      short: "S3 Green",
      triage: "green",
      aiTriageLabel: "Green – Minimal",
      hospitals: [
        {
          id: "field",
          name: "On-site Field Medical Tent",
          desc: "Oral rehydration, observation",
          isCorrect: true
        },
        {
          id: "cityMed",
          name: "City General Hospital",
          desc: "Routine ED care, far from rally",
          isCorrect: false
        },
        {
          id: "traumaCentre",
          name: "Regional Trauma Centre",
          desc: "Reserved for major trauma",
          isCorrect: false
        }
      ],
      erTests: [
        { id: "electrolytes", label: "Electrolyte panel", correct: true },
        { id: "skinTurgor", label: "Skin turgor test", correct: true },
        { id: "oralTrial", label: "Oral hydration response", correct: true },
        { id: "ctHead", label: "CT head", correct: false },
        { id: "bloodCulture", label: "Blood cultures", correct: false },
        { id: "troponin", label: "Troponin", correct: false }
      ],
      vitalsDisplay: [
        { id: "consciousness", label: "Consciousness", value: "Alert and walking" },
        { id: "rr", label: "Respiratory rate (RR)", value: "18 / min" },
        { id: "hr", label: "Heart rate (HR)", value: "92 bpm" },
        { id: "bp", label: "Blood pressure (BP)", value: "118 / 78 mmHg" },
        { id: "injury", label: "Key problem", value: "Mild dehydration, fatigue, headache" }
      ],
      scanSteps: [
        { key: "id", label: "Eyes / ID", description: "Rally ID" },
        { key: "conclevel", label: "Face – Consciousness", description: "Facial flush & hydration status" },
        { key: "hr", label: "Neck – Heart rate", description: "HR" },
        { key: "rr", label: "Chest – Respiratory rate", description: "RR" },
        { key: "bp", label: "Arms – Blood pressure", description: "BP normality" },
        { key: "injury1", label: "Pelvis / Abdomen – Injury 1", description: "Abdominal discomfort" },
        { key: "injury2", label: "Legs / Feet – Injury 2", description: "Cramps / gait" }
      ]
    },
    {
      id: 4,
      label: "Scenario 4 — Highway Collision (Black)",
      short: "S4 Black",
      triage: "black",
      aiTriageLabel: "Black – Expectant / deceased",
      hospitals: [
        {
          id: "none",
          name: "No transport — documentation only",
          desc: "Patient declared deceased at scene",
          isCorrect: true
        },
        {
          id: "nearbyGeneral",
          name: "Nearby General Hospital",
          desc: "Not needed once death confirmed",
          isCorrect: false
        },
        {
          id: "traumaCentre",
          name: "Regional Trauma Centre",
          desc: "Reserved for salvageable patients",
          isCorrect: false
        }
      ],
      erTests: [
        { id: "none", label: "None — patient deceased", correct: true },
        { id: "ctWholeBody", label: "Whole-body CT", correct: false },
        { id: "bloodGases", label: "Arterial blood gases", correct: false },
        { id: "troponin", label: "Troponin", correct: false }
      ],
      vitalsDisplay: [
        { id: "consciousness", label: "Consciousness", value: "No response to AVPU scale" },
        { id: "rr", label: "Respiratory rate (RR)", value: "0 / min" },
        { id: "hr", label: "Heart rate (HR)", value: "0 bpm" },
        { id: "bp", label: "Blood pressure (BP)", value: "Not measurable" },
        { id: "injury", label: "Key problem", value: "Massive head and chest trauma, no signs of life" }
      ],
      // 6 scans only, no BP step
      scanSteps: [
        { key: "id", label: "Eyes / ID", description: "ID & time of death logging" },
        { key: "conclevel", label: "Face – Consciousness", description: "Fixed, dilated pupils" },
        { key: "hr", label: "Neck – Heart rate", description: "No carotid pulse" },
        { key: "rr", label: "Chest – Respiratory effort", description: "No movement" },
        { key: "injury1", label: "Pelvis / Abdomen – Injury 1", description: "Trauma distribution" },
        { key: "injury2", label: "Legs / Feet – Injury 2", description: "Final documentation" }
      ]
    }
  ];

  const scenarioSelect = document.getElementById("scenarioSelect");
  const scanList = document.getElementById("scanList");
  const bodyShell = document.getElementById("bodyShell");
  const bodySegmentsContainer = document.getElementById("bodySegments");
  const envelopeLayer = document.getElementById("envelopeLayer");
  const silhouetteFooter = document.getElementById("silhouetteFooter");
  const scanOrderLabel = document.getElementById("scanOrderLabel");
  const vitalsList = document.getElementById("vitalsList");
  const timerPanel = document.getElementById("timerPanel");
  const timerValueEl = document.getElementById("timerValue");
  const timerHint = document.getElementById("timerHint");
  const triageBadges = document.getElementById("triageBadges");
  const hospitalList = document.getElementById("hospitalList");
  const erTestsList = document.getElementById("erTestsList");
  const btnContinueToTriage = document.getElementById("btnContinueToTriage");
  const btnSubmitDecision = document.getElementById("btnSubmitDecision");
  const triageStatusMessage = document.getElementById("triageStatusMessage");

  const humanTriageCell = document.getElementById("humanTriageCell");
  const aiTriageCell = document.getElementById("aiTriageCell");
  const triageMatchCell = document.getElementById("triageMatchCell");
  const humanHospitalCell = document.getElementById("humanHospitalCell");
  const aiHospitalCell = document.getElementById("aiHospitalCell");
  const hospitalMatchCell = document.getElementById("hospitalMatchCell");
  const humanTestsCell = document.getElementById("humanTestsCell");
  const aiTestsCell = document.getElementById("aiTestsCell");
  const testsMatchCell = document.getElementById("testsMatchCell");
  const humanTimeCell = document.getElementById("humanTimeCell");
  const timeMatchCell = document.getElementById("timeMatchCell");
  const aiTimeCell = document.getElementById("aiTimeCell");
  const scoreValue = document.getElementById("scoreValue");
  const scoreDetail = document.getElementById("scoreDetail");
  const leaderboardTable = document.getElementById("leaderboardTable").querySelector("tbody");
  const btnResetSimulation = document.getElementById("btnResetSimulation");
  const btnResetBoard = document.getElementById("btnResetBoard");

  const imageModal = document.getElementById("imageModal");
  const modalTitle = document.getElementById("modalTitle");
  const modalImage = document.getElementById("modalImage");
  const modalCloseBtn = document.getElementById("modalCloseBtn");

  // STATE
  let currentScenario = scenarios[0];
  let scanState = []; // {key, scanned, imageUrl}
  let timerRunning = false;
  let timerStart = null;
  let timerInterval = null;
  let lastSubmittedRunId = 0;

  let selectedTriage = null;
  let selectedHospitalId = null;
  let selectedTests = new Set();

  const LEADERBOARD_STORAGE_KEY = "triageDroneLeaderboard_v1";

  // ---------- INITIALISATION ----------

  function init() {
    scenarios.forEach((sc) => {
      const opt = document.createElement("option");
      opt.value = sc.id;
      opt.textContent = sc.label;
      scenarioSelect.appendChild(opt);
    });

    scenarioSelect.value = currentScenario.id;
    renderScenario(currentScenario);
    hookEvents();
    loadLeaderboardFromStorage();
  }

  function hookEvents() {
    scenarioSelect.addEventListener("change", () => {
      const scenarioId = Number(scenarioSelect.value);
      const sc = scenarios.find((s) => s.id === scenarioId);
      if (sc) {
        currentScenario = sc;
        resetSimulationState(false);
        renderScenario(currentScenario);
      }
    });

    btnContinueToTriage.addEventListener("click", () => {
      if (!allScansComplete()) return;
      if (!timerRunning) startTimer();
      bodyShell.classList.add("envelope-mode");
      silhouetteFooter.textContent =
        "Click any envelope to view the drone's image for that region.";
      triageStatusMessage.textContent =
        "Triage unlocked. Choose colour, hospital, and ER tests, then submit.";
      triageStatusMessage.style.color = "var(--accent-blue)";
    });

    triageBadges.addEventListener("click", (e) => {
      const badge = e.target.closest(".triage-badge");
      if (!badge) return;
      document
        .querySelectorAll(".triage-badge")
        .forEach((el) => el.classList.remove("active"));
      badge.classList.add("active");
      selectedTriage = badge.getAttribute("data-color");
      updateSubmitAvailability();
    });

    hospitalList.addEventListener("click", (e) => {
      const row = e.target.closest(".hospital-row");
      if (!row) return;
      const id = row.getAttribute("data-hospital-id");
      selectedHospitalId = id;
      document
        .querySelectorAll(".hospital-row")
        .forEach((el) => el.classList.remove("active"));
      row.classList.add("active");
      updateSubmitAvailability();
    });

    erTestsList.addEventListener("click", (e) => {
      const chip = e.target.closest(".er-test-chip");
      if (!chip) return;
      const id = chip.getAttribute("data-test-id");
      if (selectedTests.has(id)) {
        selectedTests.delete(id);
        chip.classList.remove("active");
      } else {
        selectedTests.add(id);
        chip.classList.add("active");
      }
      updateSubmitAvailability();
    });

    btnSubmitDecision.addEventListener("click", handleSubmitDecision);

    btnResetSimulation.addEventListener("click", () => {
      resetSimulationState(true);
    });

    btnResetBoard.addEventListener("click", () => {
      if (!confirm("Clear all leaderboard entries?")) return;
      localStorage.removeItem(LEADERBOARD_STORAGE_KEY);
      renderLeaderboard([]);
    });

    envelopeLayer.addEventListener("click", (e) => {
      const hotspot = e.target.closest(".envelope-hotspot");
      if (!hotspot) return;
      const index = Number(hotspot.getAttribute("data-index"));
      const step = scanState[index];
      if (!step || !step.scanned) return;
      openImageModal(step);
    });

    modalCloseBtn.addEventListener("click", closeImageModal);
    imageModal.addEventListener("click", (e) => {
      if (e.target === imageModal) closeImageModal();
    });

    window.addEventListener("beforeunload", () => {
      // timer doesn't need persistence; leaderboard already stored as we go
    });

    // Optional: support postMessage from mobile.html
    window.addEventListener("message", (event) => {
      const data = event.data || {};
      if (data.type === "qr-scan" || data.type === "scan") {
        handleExternalScan(data);
      }
    });
  }

  // ---------- RENDERING ----------

  function renderScenario(scenario) {
    // scan steps
    scanState = scenario.scanSteps.map((step) => ({
      key: step.key,
      label: step.label,
      description: step.description,
      scanned: false,
      imageUrl: `images/s${scenario.id}_${step.key}.jpg`
    }));
    renderScanList();
    renderSilhouette();
    renderVitals(scenario);
    renderHospitals(scenario);
    renderErTests(scenario);
    renderScanOrderLabel(scenario);

    // AI baseline cells
    aiTriageCell.textContent = scenario.aiTriageLabel;
    const correctHospital = scenario.hospitals.find((h) => h.isCorrect);
    aiHospitalCell.textContent = correctHospital
      ? correctHospital.name
      : "AI hospital";
    aiTestsCell.textContent = scenario.erTests
      .filter((t) => t.correct)
      .map((t) => t.label)
      .join(", ");
    aiTimeCell.textContent = "Target < 90 s";

    // reset evaluation cells
    humanTriageCell.textContent = "—";
    humanHospitalCell.textContent = "—";
    humanTestsCell.textContent = "—";
    humanTimeCell.textContent = "—";
    [triageMatchCell, hospitalMatchCell, testsMatchCell, timeMatchCell].forEach(
      (cell) => (cell.textContent = "—")
    );
    scoreValue.textContent = "0 / 12";
    scoreDetail.textContent = "";

    btnContinueToTriage.disabled = !allScansComplete();
    btnSubmitDecision.disabled = true;
  }

  function renderScanList() {
    scanList.innerHTML = "";
    scanState.forEach((step, idx) => {
      const row = document.createElement("div");
      row.className = "scan-row";
      row.setAttribute("data-step-index", idx);

      const label = document.createElement("div");
      label.className = "scan-row-label";
      label.textContent = step.label;

      const status = document.createElement("div");
      status.className = "scan-row-status";
      status.innerHTML = `<span class="status-dot"></span><span>Waiting for scan…</span>`;

      const tag = document.createElement("div");
      tag.className = "scan-row-tag";
      tag.innerHTML = `<span>${idx + 1}</span> / ${scanState.length}`;

      row.appendChild(label);
      row.appendChild(status);
      row.appendChild(tag);

      scanList.appendChild(row);
    });
  }

  function renderSilhouette() {
    bodySegmentsContainer.innerHTML = "";
    envelopeLayer.innerHTML = "";
    const numSegments = scanState.length;

    for (let i = 0; i < numSegments; i++) {
      const seg = document.createElement("div");
      seg.className = "body-segment";
      seg.setAttribute("data-step-index", i);
      const fill = document.createElement("div");
      fill.className = "body-segment-fill";
      seg.appendChild(fill);
      bodySegmentsContainer.appendChild(seg);

      const hotspot = document.createElement("div");
      hotspot.className = "envelope-hotspot";
      hotspot.setAttribute("data-index", i);
      hotspot.innerHTML =
        '<svg viewBox="0 0 24 24"><path d="M4 5h16a1 1 0 0 1 1 1v12a1 1 0 0 1-1 1H4a1 1 0 0 1-1-1V6a1 1 0 0 1 1-1zm0.9 2l6.5 5.2a1.5 1.5 0 0 0 1.8 0L19.7 7H4.9z"/></svg>';
      envelopeLayer.appendChild(hotspot);
    }

    bodyShell.classList.remove("envelope-mode", "all-filled");
    silhouetteFooter.textContent =
      "Scan from head to toe. The silhouette will light up with each scan.";
  }

  function renderVitals(scenario) {
    vitalsList.innerHTML = "";
    scenario.vitalsDisplay.forEach((v) => {
      const row = document.createElement("li");
      row.className = "vitals-row";
      row.innerHTML = `<span class="vitals-label">${v.label}</span><span class="vitals-value">${v.value}</span>`;
      vitalsList.appendChild(row);
    });
  }

  function renderHospitals(scenario) {
    hospitalList.innerHTML = "";
    selectedHospitalId = null;
    scenario.hospitals.forEach((hosp) => {
      const row = document.createElement("div");
      row.className = "hospital-row";
      row.setAttribute("data-hospital-id", hosp.id);
      row.innerHTML = `<div class="hospital-name">${hosp.name}</div><div class="hospital-desc">${hosp.desc}</div>`;
      hospitalList.appendChild(row);
    });
  }

  function renderErTests(scenario) {
    erTestsList.innerHTML = "";
    selectedTests = new Set();
    scenario.erTests.forEach((test) => {
      const chip = document.createElement("button");
      chip.type = "button";
      chip.className = "er-test-chip";
      chip.setAttribute("data-test-id", test.id);
      chip.innerHTML = `<span class="dot"></span><span>${test.label}</span>`;
      erTestsList.appendChild(chip);
    });
  }

  function renderScanOrderLabel(scenario) {
    scanOrderLabel.textContent = scenario.scanSteps
      .map((step, idx) => `${idx + 1}. ${step.label}`)
      .join("  •  ");
  }

  // ---------- SCAN LOGIC ----------

  function markScanReceived(stepKey, imageUrl) {
    const index = scanState.findIndex((s) => s.key === stepKey);
    if (index === -1) return;
    const step = scanState[index];
    if (imageUrl) step.imageUrl = imageUrl;
    if (step.scanned) return;

    step.scanned = true;

    const row = scanList.querySelector(`[data-step-index="${index}"]`);
    if (row) {
      row.classList.add("scanned");
      const statusSpan = row.querySelector(".scan-row-status span:last-child");
      if (statusSpan) statusSpan.textContent = "Scan received";
    }

    const segment = bodySegmentsContainer.querySelector(
      `.body-segment[data-step-index="${index}"]`
    );
    if (segment) segment.classList.add("filled");

    if (allScansComplete()) {
      bodyShell.classList.add("all-filled");
      btnContinueToTriage.disabled = false;
      silhouetteFooter.textContent =
        "All scans complete. Press Continue to move to the triage decision.";
    }
  }

  function allScansComplete() {
    return scanState.every((s) => s.scanned);
  }

  function handleExternalScan(data) {
    const { scenarioId, vitalKey, imageUrl } = data;
    if (scenarioId && Number(scenarioId) !== currentScenario.id) return;
    if (!vitalKey) return;
    markScanReceived(vitalKey, imageUrl);
  }

  // ---------- TIMER ----------

  function startTimer() {
    timerRunning = true;
    timerStart = performance.now();
    timerPanel.classList.add("running");
    timerHint.textContent =
      "Timer running. Complete triage and submit as quickly and safely as possible.";
    if (timerInterval) clearInterval(timerInterval);
    timerInterval = setInterval(updateTimerDisplay, 60);
  }

  function updateTimerDisplay() {
    if (!timerRunning || timerStart == null) return;
    const now = performance.now();
    const seconds = (now - timerStart) / 1000;
    timerValueEl.textContent = seconds.toFixed(2);
  }

  function stopTimer() {
    if (!timerRunning) return;
    timerRunning = false;
    updateTimerDisplay();
    timerPanel.classList.remove("running");
    if (timerInterval) clearInterval(timerInterval);
  }

  function getElapsedTimeSeconds() {
    if (!timerStart) return null;
    const now = timerRunning ? performance.now() : timerStart;
    const delta = (timerRunning ? now - timerStart : now - timerStart) / 1000;
    return parseFloat(timerValueEl.textContent) || delta;
  }

  // ---------- TRIAGE / SUBMIT ----------

  function updateSubmitAvailability() {
    const ready =
      allScansComplete() && selectedTriage && selectedHospitalId && selectedTests.size;
    btnSubmitDecision.disabled = !ready;
  }

  function handleSubmitDecision() {
    if (btnSubmitDecision.disabled) return;

    stopTimer();
    const runId = ++lastSubmittedRunId;

    const scenario = currentScenario;

    const correctHospital = scenario.hospitals.find((h) => h.isCorrect);
    const correctTests = scenario.erTests.filter((t) => t.correct).map((t) => t.id);

    const triageCorrect = selectedTriage === scenario.triage;
    const hospitalCorrect = !!correctHospital && selectedHospitalId === correctHospital.id;

    const testsSelectedArray = Array.from(selectedTests);
    const testsCorrectSet = new Set(correctTests);
    let testsCorrect = true;
    if (testsSelectedArray.length !== correctTests.length) {
      testsCorrect = false;
    } else {
      for (const t of testsSelectedArray) {
        if (!testsCorrectSet.has(t)) {
          testsCorrect = false;
          break;
        }
      }
    }

    const timeSeconds = getElapsedTimeSeconds() || 0;
    const timeGood = timeSeconds > 0 && timeSeconds <= 90;

    // Update result table
    humanTriageCell.textContent = labelForTriage(selectedTriage);
    humanHospitalCell.textContent = scenario.hospitals.find(
      (h) => h.id === selectedHospitalId
    )?.name || "—";
    humanTestsCell.textContent = testsSelectedArray
      .map((id) => scenario.erTests.find((t) => t.id === id)?.label || id)
      .join(", ");
    humanTimeCell.textContent = `${timeSeconds.toFixed(2)} s`;

    aiTriageCell.textContent = scenario.aiTriageLabel;
    aiHospitalCell.textContent = correctHospital
      ? correctHospital.name
      : "AI hospital";
    aiTestsCell.textContent = scenario.erTests
      .filter((t) => t.correct)
      .map((t) => t.label)
      .join(", ");
    aiTimeCell.textContent = "Target < 90 s";

    triageMatchCell.textContent = triageCorrect ? "✓" : "✕";
    triageMatchCell.className = triageCorrect
      ? "match-tag-ok"
      : "match-tag-bad";

    hospitalMatchCell.textContent = hospitalCorrect ? "✓" : "✕";
    hospitalMatchCell.className = hospitalCorrect
      ? "match-tag-ok"
      : "match-tag-bad";

    testsMatchCell.textContent = testsCorrect ? "✓" : "✕";
    testsMatchCell.className = testsCorrect
      ? "match-tag-ok"
      : "match-tag-bad";

    timeMatchCell.textContent = timeGood ? "✓" : "✕";
    timeMatchCell.className = timeGood ? "match-tag-ok" : "match-tag-bad";

    // scoring: 4 pts triage, 3 hospital, 3 tests, 2 time => /12
    let score = 0;
    if (triageCorrect) score += 4;
    if (hospitalCorrect) score += 3;
    if (testsCorrect) score += 3;
    if (timeGood) score += 2;

    scoreValue.textContent = `${score} / 12`;
    scoreDetail.textContent =
      score === 12
        ? "Perfect match with AI for this scenario."
        : score >= 8
        ? "Strong alignment with AI; review any differences."
        : "Significant differences vs AI — discuss in debrief.";

    // Leaderboard entry
    const playerName = prompt(
      "Enter your name for the leaderboard:",
      "Guest"
    ) || "Guest";
    const mode = "Solo";

    addLeaderboardEntry({
      name: playerName,
      mode,
      scenario: scenario.label,
      score,
      timeSeconds: timeSeconds
    });

    // mark that this run has been submitted to avoid duplicates
    btnSubmitDecision.disabled = true;
  }

  function labelForTriage(color) {
    switch (color) {
      case "red":
        return "Red – Immediate";
      case "yellow":
        return "Yellow – Urgent but delayed";
      case "green":
        return "Green – Minimal";
      case "black":
        return "Black – Expectant / deceased";
      default:
        return "—";
    }
  }

  // ---------- LEADERBOARD ----------

  function loadLeaderboardFromStorage() {
    const raw = localStorage.getItem(LEADERBOARD_STORAGE_KEY);
    if (!raw) {
      renderLeaderboard([]);
      return;
    }
    try {
      const entries = JSON.parse(raw);
      renderLeaderboard(entries || []);
    } catch {
      renderLeaderboard([]);
    }
  }

  function saveLeaderboardToStorage(entries) {
    localStorage.setItem(LEADERBOARD_STORAGE_KEY, JSON.stringify(entries));
  }

  function getLeaderboardEntries() {
    const raw = localStorage.getItem(LEADERBOARD_STORAGE_KEY);
    if (!raw) return [];
    try {
      return JSON.parse(raw) || [];
    } catch {
      return [];
    }
  }

  function renderLeaderboard(entries) {
    leaderboardTable.innerHTML = "";
    entries.forEach((entry, idx) => {
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${idx + 1}</td>
        <td>${entry.name}</td>
        <td>${entry.mode}</td>
        <td>${entry.scenarioShort || entry.scenario}</td>
        <td>${entry.score}</td>
        <td>${entry.timeSeconds.toFixed(2)} s</td>
      `;
      leaderboardTable.appendChild(tr);
    });
  }

  function addLeaderboardEntry(entry) {
    const entries = getLeaderboardEntries();
    entries.push({
      name: entry.name,
      mode: entry.mode,
      scenario: entry.scenario,
      scenarioShort:
        scenarios.find((s) => s.label === entry.scenario)?.short ||
        entry.scenario,
      score: entry.score,
      timeSeconds: entry.timeSeconds
    });

    // sort by score desc then time asc
    entries.sort((a, b) => {
      if (b.score !== a.score) return b.score - a.score;
      return a.timeSeconds - b.timeSeconds;
    });

    saveLeaderboardToStorage(entries);
    renderLeaderboard(entries);
  }

  // ---------- MODAL ----------

  function openImageModal(step) {
    modalTitle.textContent = step.label;
    modalImage.src = step.imageUrl;
    imageModal.classList.add("active");
  }

  function closeImageModal() {
    imageModal.classList.remove("active");
    modalImage.src = "";
  }

  // ---------- RESET ----------

  function resetSimulationState(clearTimer) {
    scanState.forEach((step) => (step.scanned = false));
    selectedTriage = null;
    selectedHospitalId = null;
    selectedTests = new Set();

    // UI
    renderScanList();
    renderSilhouette();
    document
      .querySelectorAll(".triage-badge")
      .forEach((el) => el.classList.remove("active"));
    document
      .querySelectorAll(".hospital-row")
      .forEach((el) => el.classList.remove("active"));
    document
      .querySelectorAll(".er-test-chip")
      .forEach((el) => el.classList.remove("active"));

    triageStatusMessage.textContent =
      "Scan all regions first. Then press Continue to unlock triage.";
    triageStatusMessage.style.color = "var(--text-muted)";

    btnContinueToTriage.disabled = !allScansComplete();
    btnSubmitDecision.disabled = true;

    if (clearTimer) {
      stopTimer();
      timerStart = null;
      timerValueEl.textContent = "0.00";
      timerHint.textContent =
        "Scan all QR tags first. The timer will start when you continue to triage.";
    }

    // reset result table
    humanTriageCell.textContent = "—";
    humanHospitalCell.textContent = "—";
    humanTestsCell.textContent = "—";
    humanTimeCell.textContent = "—";
    [triageMatchCell, hospitalMatchCell, testsMatchCell, timeMatchCell].forEach(
      (cell) => {
        cell.textContent = "—";
        cell.className = "";
      }
    );
    scoreValue.textContent = "0 / 12";
    scoreDetail.textContent = "";
  }

  // ---------- START ----------

  init();
</script>
</body>
</html>
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>AI Triage Drone 2040 – Control Screen</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    :root {
      --bg: #040814;
      --panel: #0b1020;
      --accent: #3fbcff;
      --accent-soft: rgba(63, 188, 255, 0.18);
      --danger: #ff4b5c;
      --warning: #ffc857;
      --success: #4ade80;
      --muted: #9ca3af;
      --text: #f9fafb;
      --card-radius: 18px;
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: radial-gradient(circle at top, #111827 0, #020617 40%, #000 100%);
      color: var(--text);
      overflow: hidden;
    }

    .root {
      display: flex;
      flex-direction: column;
      height: 100vh;
      width: 100vw;
      padding: 12px 18px;
      gap: 10px;
    }

    header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 6px 12px;
      border-radius: 999px;
      background: linear-gradient(90deg, #020617, #020617, #020617);
      border: 1px solid rgba(148, 163, 184, 0.3);
      font-size: 14px;
    }

    header .title {
      display: flex;
      align-items: center;
      gap: 10px;
      font-size: 16px;
      font-weight: 600;
    }

    header .title span {
      font-size: 20px;
    }

    header .operator {
      font-size: 14px;
      color: var(--muted);
    }

    main {
      flex: 1;
      display: grid;
      grid-template-rows: 60% 40%;
      gap: 10px;
      min-height: 0;
    }

    .top-row {
      display: grid;
      grid-template-columns: 52% 48%;
      gap: 10px;
      min-height: 0;
    }

    .panel {
      background: radial-gradient(circle at top left, #111827 0, #020617 55%);
      border-radius: var(--card-radius);
      border: 1px solid rgba(148, 163, 184, 0.25);
      padding: 14px 16px;
      box-shadow: 0 18px 40px rgba(15, 23, 42, 0.8);
      min-height: 0;
      overflow: hidden;
    }

    .panel h2 {
      font-size: 16px;
      font-weight: 600;
      margin-bottom: 10px;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .scenario-select {
      width: 100%;
      margin-top: 4px;
      margin-bottom: 10px;
    }

    .scenario-select select {
      width: 100%;
      padding: 8px 10px;
      border-radius: 999px;
      border: 1px solid rgba(148, 163, 184, 0.5);
      background: #020617;
      color: var(--text);
      font-size: 14px;
      outline: none;
    }

    .scan-layout {
      display: grid;
      grid-template-columns: 52% 48%;
      gap: 12px;
      height: calc(100% - 40px);
      min-height: 0;
    }

    .scan-list {
      display: flex;
      flex-direction: column;
      gap: 8px;
      min-height: 0;
      max-width: 540px;
    }

    .scan-row {
      border-radius: 16px;
      padding: 8px 10px;
      border: 1px solid rgba(148, 163, 184, 0.45);
      background: rgba(15, 23, 42, 0.92);
      display: flex;
      flex-direction: column;
      gap: 2px;
      font-size: 13px;
      position: relative;
      overflow: hidden;
    }

    .scan-row .scan-label {
      font-weight: 500;
    }

    .scan-row .scan-status {
      font-size: 11px;
      color: var(--muted);
    }

    .scan-row::before {
      content: "";
      position: absolute;
      inset: 0;
      background: radial-gradient(circle at left, rgba(56, 189, 248, 0.12), transparent 60%);
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.18s ease-out;
    }

    .scan-row.filled {
      border-color: rgba(56, 189, 248, 0.9);
      box-shadow: 0 0 18px rgba(56, 189, 248, 0.45);
    }

    .scan-row.filled::before {
      opacity: 1;
    }

    .scan-instructions {
      margin-top: 4px;
      font-size: 11px;
      color: var(--muted);
      line-height: 1.5;
    }

    .scan-instructions ol {
      margin-left: 16px;
      margin-top: 4px;
    }

    .scan-actions {
      margin-top: 8px;
      display: flex;
      justify-content: space-between;
      gap: 8px;
      align-items: center;
      font-size: 11px;
      color: var(--muted);
    }

    .btn-primary,
    .btn-secondary {
      padding: 6px 12px;
      border-radius: 999px;
      border: none;
      font-size: 12px;
      font-weight: 600;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
      white-space: nowrap;
    }

    .btn-primary {
      background: linear-gradient(135deg, #3b82f6, #22c55e);
      color: white;
      box-shadow: 0 12px 30px rgba(34, 197, 94, 0.5);
    }

    .btn-primary:disabled {
      opacity: 0.4;
      cursor: default;
      box-shadow: none;
    }

    .btn-secondary {
      background: #111827;
      border: 1px solid rgba(148, 163, 184, 0.6);
      color: var(--muted);
      box-shadow: none;
    }

    .figure-wrapper {
      display: flex;
      flex-direction: column;
      gap: 6px;
      align-items: center;
      justify-content: space-between;
    }

    .figure-visual {
      position: relative;
      width: 100%;
      max-width: 320px;
      aspect-ratio: 9 / 20;
      margin: 0 auto;
      border-radius: 999px;
      background: radial-gradient(circle at top, rgba(15, 23, 42, 0.8) 0, #020617 45%, #000 100%);
      overflow: hidden;
      box-shadow: 0 18px 40px rgba(15, 23, 42, 0.9);
    }

    .figure-visual::before {
      content: "";
      position: absolute;
      inset: -10%;
      background: radial-gradient(circle at top, rgba(15, 23, 42, 0.6), transparent 55%);
      pointer-events: none;
      z-index: 0;
    }

    .figure-silhouette {
      position: absolute;
      inset: 2% 10% 0 10%;
      z-index: 1;
    }

    .figure-img-base,
    .figure-img-fill {
      position: absolute;
      inset: 0;
      width: 100%;
      height: 100%;
      object-fit: contain;
    }

    .figure-img-base {
      opacity: 0.26;
      filter: drop-shadow(0 0 14px rgba(15, 23, 42, 0.9));
    }

    .figure-img-fill {
      opacity: 0;
      filter: drop-shadow(0 0 22px rgba(56, 189, 248, 0.95));
      clip-path: inset(100% 0 0 0);
      transition:
        clip-path 0.55s cubic-bezier(0.16, 1, 0.3, 1),
        opacity 0.35s ease-out;
    }

    .figure-hotspot {
      position: absolute;
      width: 28px;
      height: 28px;
      border-radius: 999px;
      border: 1px solid rgba(148, 163, 184, 0.8);
      background: rgba(15, 23, 42, 0.9);
      color: var(--text);
      font-size: 14px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      z-index: 3;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.18s ease-out, transform 0.12s ease-out, box-shadow 0.18s ease-out;
    }

    .figure-hotspot span {
      pointer-events: none;
    }

    .figure-hotspot.active {
      opacity: 1;
      pointer-events: auto;
      box-shadow: 0 0 14px rgba(56, 189, 248, 0.9);
    }

    .figure-hotspot:hover {
      transform: scale(1.04);
    }

    .hotspot-id      { top: 7%;  left: 50%; transform: translate(-50%, -50%); }
    .hotspot-conc    { top: 16%; left: 50%; transform: translate(-50%, -50%); }
    .hotspot-hr      { top: 26%; left: 52%; transform: translate(-50%, -50%); }
    .hotspot-rr      { top: 33%; left: 48%; transform: translate(-50%, -50%); }
    .hotspot-bp      { top: 42%; left: 18%; transform: translate(-50%, -50%); }
    .hotspot-inj1    { top: 55%; left: 50%; transform: translate(-50%, -50%); }
    .hotspot-inj2    { top: 75%; left: 50%; transform: translate(-50%, -50%); }

    .figure-caption {
      font-size: 11px;
      color: var(--muted);
      text-align: center;
    }

    .bottom-row {
      display: grid;
      grid-template-columns: 55% 45%;
      gap: 10px;
      min-height: 0;
    }

    .triage-controls {
      display: flex;
      flex-direction: column;
      gap: 8px;
      height: 100%;
    }

    .triage-circles {
      display: flex;
      gap: 14px;
      align-items: center;
    }

    .triage-circle {
      width: 40px;
      height: 40px;
      border-radius: 999px;
      border: 2px solid transparent;
      cursor: pointer;
      position: relative;
      box-shadow: 0 0 0 0 rgba(0, 0, 0, 0);
      transition: transform 0.12s ease-out, box-shadow 0.12s ease-out, border-color 0.12s ease-out;
    }

    .triage-circle[data-level="Red"] { background: var(--danger); }
    .triage-circle[data-level="Yellow"] { background: var(--warning); }
    .triage-circle[data-level="Green"] { background: var(--success); }
    .triage-circle[data-level="Black"] { background: #020617; border: 1px solid #6b7280; }

    .triage-circle span {
      position: absolute;
      bottom: -18px;
      left: 50%;
      transform: translateX(-50%);
      font-size: 11px;
      white-space: nowrap;
      color: var(--muted);
    }

    .triage-circle.selected {
      transform: scale(1.08);
      box-shadow: 0 0 18px rgba(94, 234, 212, 0.8);
      border-color: #e5e7eb;
    }

    .triage-steps-label {
      font-size: 12px;
      color: var(--muted);
    }

    .hospital-tests {
      margin-top: 8px;
      display: grid;
      grid-template-columns: 55% 45%;
      gap: 8px;
      font-size: 13px;
    }

    .hospital-card {
      border-radius: 16px;
      padding: 8px 10px;
      border: 1px solid rgba(148, 163, 184, 0.5);
      background: rgba(15, 23, 42, 0.92);
      cursor: pointer;
      margin-bottom: 6px;
    }

    .hospital-card.selected {
      border-color: var(--accent);
      box-shadow: 0 0 16px rgba(59, 130, 246, 0.7);
    }

    .hospital-name {
      font-weight: 600;
      margin-bottom: 3px;
    }

    .hospital-meta {
      font-size: 11px;
      color: var(--muted);
    }

    .tests-list {
      border-radius: 16px;
      border: 1px solid rgba(148, 163, 184, 0.4);
      background: rgba(15, 23, 42, 0.96);
      padding: 8px 10px;
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .test-row {
      display: flex;
      gap: 6px;
      align-items: center;
      font-size: 12px;
    }

    .test-row input {
      accent-color: var(--accent);
    }

    .submit-row {
      margin-top: 8px;
      display: flex;
      justify-content: space-between;
      gap: 8px;
      align-items: center;
      font-size: 12px;
      color: var(--muted);
    }

    .results-table {
      width: 100%;
      font-size: 12px;
      border-collapse: collapse;
    }

    .results-table th,
    .results-table td {
      padding: 4px 6px;
      border-bottom: 1px solid rgba(30, 64, 175, 0.5);
      text-align: left;
    }

    .results-table th {
      font-weight: 600;
      color: var(--muted);
    }

    .match-cell {
      text-align: center;
      font-size: 14px;
    }

    .match-yes { color: #4ade80; }
    .match-no { color: #f97373; }

    .score-summary {
      margin-top: 6px;
      font-size: 13px;
    }

    .leaderboard {
      margin-top: 8px;
      font-size: 12px;
    }

    .leaderboard table {
      width: 100%;
      border-collapse: collapse;
    }

    .leaderboard th,
    .leaderboard td {
      padding: 3px 4px;
      border-bottom: 1px solid rgba(30, 64, 175, 0.4);
      text-align: left;
    }

    .leaderboard th {
      font-weight: 600;
      color: var(--muted);
    }

    .timer {
      margin-top: 12px;
      padding: 8px 10px;
      border-radius: 999px;
      background: rgba(15, 23, 42, 0.9);
      display: flex;
      align-items: center;
      justify-content: space-between;
      font-size: 14px;
      border: 1px solid rgba(148, 163, 184, 0.4);
    }

    .timer span.time {
      font-weight: 700;
      font-size: 18px;
    }

    .glow {
      text-shadow: 0 0 10px rgba(56, 189, 248, 0.7);
    }

    .modal-backdrop {
      position: fixed;
      inset: 0;
      background: rgba(15, 23, 42, 0.85);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 40;
    }

    .modal-backdrop.open {
      display: flex;
    }

    .modal {
      background: #020617;
      border-radius: 18px;
      border: 1px solid rgba(148, 163, 184, 0.5);
      max-width: 80vw;
      max-height: 80vh;
      padding: 10px;
      box-shadow: 0 20px 40px rgba(15, 23, 42, 0.95);
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 13px;
      color: var(--muted);
    }

    .modal-close {
      border: none;
      background: transparent;
      color: var(--muted);
      cursor: pointer;
      font-size: 16px;
    }

    .modal-body {
      border-radius: 12px;
      overflow: hidden;
      margin-top: 4px;
    }

    .modal-body img {
      max-width: 100%;
      max-height: 70vh;
      display: block;
    }
  </style>
</head>
<body>
<div class="root">
  <header>
    <div class="title">
      <span>🚁</span>
      <div>
        <div>AI Triage Drone 2040</div>
        <div style="font-size:12px;color:var(--muted);">Mass casualty triage training • Human vs AI</div>
      </div>
    </div>
    <div class="operator" id="operatorLabel">
      Operator: Waiting for mobile operator…
    </div>
  </header>

  <main>
    <div class="top-row">
      <section class="panel" id="bodyPanel">
        <h2>Patient Body Map &amp; Drone Feed</h2>

        <div class="scenario-select">
          <select id="scenarioSelect"></select>
        </div>

        <div class="scan-layout">
          <div class="scan-list">
            <div class="scan-row" data-scan="id">
              <div class="scan-label">Eyes / ID</div>
              <div class="scan-status">Waiting for scan…</div>
            </div>
            <div class="scan-row" data-scan="conclevel">
              <div class="scan-label">Face – Consciousness</div>
              <div class="scan-status">Waiting for scan…</div>
            </div>
            <div class="scan-row" data-scan="hr">
              <div class="scan-label">Neck – Heart rate</div>
              <div class="scan-status">Waiting for scan…</div>
            </div>
            <div class="scan-row" data-scan="rr">
              <div class="scan-label">Chest – Respiratory rate</div>
              <div class="scan-status">Waiting for scan…</div>
            </div>
            <div class="scan-row" data-scan="bp">
              <div class="scan-label">Arms – Blood pressure</div>
              <div class="scan-status">Waiting for scan…</div>
            </div>
            <div class="scan-row" data-scan="injury1">
              <div class="scan-label">Pelvis / Abdomen – Injury 1</div>
              <div class="scan-status">Waiting for scan…</div>
            </div>
            <div class="scan-row" data-scan="injury2">
              <div class="scan-label">Legs / Feet – Injury 2</div>
              <div class="scan-status">Waiting for scan…</div>
            </div>

            <div class="scan-instructions" id="scanHint">
              Scan from head to toe in this order. The silhouette will light up with each scan.
              When all scans are done you can continue to the triage decision.
              <ol>
                <li>Eyes – ID</li>
                <li>Face – consciousness level</li>
                <li>Neck – heart rate</li>
                <li>Chest – respiratory rate</li>
                <li>Arms – blood pressure (not used in Scenario 4)</li>
                <li>Pelvis / Abdomen – main injury</li>
                <li>Legs / Feet – secondary injury</li>
              </ol>
            </div>

            <div class="scan-actions">
              <span id="scanStatusLabel">Waiting for scans…</span>
              <button class="btn-primary" id="continueBtn" disabled>Continue to triage</button>
            </div>
          </div>

          <div class="figure-wrapper">
            <div class="figure-visual" id="figureVisual">
              <div class="figure-silhouette">
                <img src="images/body_silhouette.png" alt="Patient silhouette" class="figure-img-base" />
                <img src="images/body_silhouette.png" alt="" class="figure-img-fill" id="figureFill" />
              </div>

              <button class="figure-hotspot hotspot-id" data-scan="id" title="Eyes / ID"><span>✉</span></button>
              <button class="figure-hotspot hotspot-conc" data-scan="conclevel" title="Consciousness"><span>✉</span></button>
              <button class="figure-hotspot hotspot-hr" data-scan="hr" title="Heart rate"><span>✉</span></button>
              <button class="figure-hotspot hotspot-rr" data-scan="rr" title="Respiratory rate"><span>✉</span></button>
              <button class="figure-hotspot hotspot-bp" data-scan="bp" title="Blood pressure"><span>✉</span></button>
              <button class="figure-hotspot hotspot-inj1" data-scan="injury1" title="Injury 1"><span>✉</span></button>
              <button class="figure-hotspot hotspot-inj2" data-scan="injury2" title="Injury 2"><span>✉</span></button>
            </div>
            <div class="figure-caption">
              During scanning, the body fills from head to toe.  
              After Continue, tap an envelope to view that region’s photo.
            </div>
          </div>
        </div>
      </section>

      <section class="panel">
        <h2>Live Vitals (from drone)</h2>
        <div class="vitals-list" style="display:flex;flex-direction:column;gap:6px;font-size:14px;">
          <div class="vital-row">
            <div class="vital-label">Consciousness</div>
            <div class="vital-value" id="vConsciousness">—</div>
          </div>
          <div class="vital-row">
            <div class="vital-label">Respiratory rate (RR)</div>
            <div class="vital-value" id="vRR">—</div>
          </div>
          <div class="vital-row">
            <div class="vital-label">Heart rate (HR)</div>
            <div class="vital-value" id="vHR">—</div>
          </div>
          <div class="vital-row">
            <div class="vital-label">Blood pressure (BP)</div>
            <div class="vital-value" id="vBP">—</div>
          </div>
          <div class="vital-row">
            <div class="vital-label">Key injury / problem</div>
            <div class="vital-value" id="vKeyInjury">—</div>
          </div>
        </div>

        <div class="timer">
          <div>PATIENT LOADING • TRIAGE TIMER</div>
          <span class="time" id="timerDisplay">0.00 s</span>
        </div>
        <div style="margin-top:4px;font-size:12px;color:var(--muted);" id="timerHint">
          Scan all QR tags first. The timer will start when you continue to triage.
        </div>

        <div style="margin-top:10px;font-size:11px;color:var(--muted);border-radius:14px;border:1px dashed rgba(148,163,184,0.5);padding:8px 10px;">
          <div style="font-weight:600;margin-bottom:4px;">COMING SOON</div>
          <div style="font-weight:600;">AI Paramedic Support Module</div>
          <div>Drone will recommend the exact medical tools paramedics should bring from the hospital based on the injuries.</div>
        </div>
      </section>
    </div>

    <div class="bottom-row">
      <section class="panel">
        <h2>Human Triage Decision</h2>
        <div class="triage-controls">
          <div class="triage-steps-label">Step 1 — choose triage category</div>
          <div class="triage-circles">
            <div class="triage-circle" data-level="Red">
              <span>Red</span>
            </div>
            <div class="triage-circle" data-level="Yellow">
              <span>Yellow</span>
            </div>
            <div class="triage-circle" data-level="Green">
              <span>Green</span>
            </div>
            <div class="triage-circle" data-level="Black">
              <span>Black</span>
            </div>
          </div>

          <div class="hospital-tests">
            <div>
              <div class="triage-steps-label" style="margin-bottom:4px;">Step 2 — choose receiving hospital</div>
              <div id="hospitalList"></div>
            </div>
            <div>
              <div class="triage-steps-label" style="margin-bottom:4px;">Step 3 — choose ER tests</div>
              <div class="tests-list" id="testsList"></div>
            </div>
          </div>

          <div class="submit-row">
            <span id="decisionHint">Complete triage, hospital and tests after scanning all regions and pressing Continue.</span>
            <button class="btn-primary" id="submitDecisionBtn" disabled>Submit Decision</button>
          </div>
        </div>
      </section>

      <section class="panel">
        <h2>Human vs AI Results</h2>

        <table class="results-table">
          <thead>
          <tr>
            <th>Category</th>
            <th>Human</th>
            <th>AI</th>
            <th class="match-cell">Match</th>
          </tr>
          </thead>
          <tbody>
          <tr>
            <td>Triage</td>
            <td id="resHumanTriage">—</td>
            <td id="resAITriage">—</td>
            <td class="match-cell" id="matchTriage">—</td>
          </tr>
          <tr>
            <td>Hospital</td>
            <td id="resHumanHospital">—</td>
            <td id="resAIHospital">—</td>
            <td class="match-cell" id="matchHospital">—</td>
          </tr>
          <tr>
            <td>ER tests</td>
            <td id="resHumanTests">—</td>
            <td id="resAITests">—</td>
            <td class="match-cell" id="matchTests">—</td>
          </tr>
          <tr>
            <td>Time</td>
            <td id="resHumanTime">—</td>
            <td id="resAITime">—</td>
            <td class="match-cell" id="matchTime">—</td>
          </tr>
          </tbody>
        </table>

        <div class="score-summary" id="scoreSummary">
          Score: 0 / 12 points
        </div>

        <div class="leaderboard">
          <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:4px;">
            <div style="font-weight:600;">Live Leaderboard</div>
            <div style="display:flex;gap:6px;">
              <button class="btn-secondary" id="resetSimBtn">Reset simulation</button>
              <button class="btn-primary" style="padding:4px 10px;font-size:11px;background:linear-gradient(135deg,#ef4444,#f97316);" id="resetLeaderboardBtn">
                Reset board
              </button>
            </div>
          </div>
          <table>
            <thead>
            <tr>
              <th>#</th>
              <th>Name</th>
              <th>Mode</th>
              <th>Scenario</th>
              <th>Score</th>
              <th>Time</th>
            </tr>
            </thead>
            <tbody id="leaderboardBody"></tbody>
          </table>
        </div>
      </section>
    </div>
  </main>
</div>

<div class="modal-backdrop" id="imageModal">
  <div class="modal">
    <div class="modal-header">
      <span id="modalTitle">Scan image</span>
      <button class="modal-close" id="modalCloseBtn">✕</button>
    </div>
    <div class="modal-body">
      <img id="modalImage" src="" alt="Scan" />
    </div>
  </div>
</div>

<script src="/socket.io/socket.io.js"></script>
<script>
  const socket = io();

  const scenarios = [
    {
      id: "s1",
      label: "Scenario 1 — Hajj Stampede (Red)",
      ai: {
        triage: "Red",
        hospital: "Mina Emergency Hospital",
        erTests: ["FAST ultrasound", "Serum lactate", "Blood typing and crossmatch"],
        timeSeconds: 1.2
      },
      expectedScans: ["id","conclevel","hr","bp","rr","injury1","injury2"],
      scanVitals: {
        conclevel: { vitalKey: "consciousness", value: "Unconscious, pale, shallow breathing" },
        rr:        { vitalKey: "rr",           value: "34 / min" },
        hr:        { vitalKey: "hr",           value: "142 bpm" },
        bp:        { vitalKey: "bp",           value: "78/45 mmHg" },
        injury1:   { vitalKey: "keyInjury",    value: "Severe bleeding from lower abdomen" },
        injury2:   { vitalKey: "keyInjury",    value: "Severe bleeding from lower abdomen & suspected pelvic fracture" }
      },
      hospitals: [
        {
          name: "Mina Emergency Hospital",
          meta: "Closest high-emergency facility",
          testsAvailable: [
            "FAST ultrasound",
            "Serum lactate",
            "Blood typing and crossmatch",
            "Chest X-ray",
            "Urinalysis"
          ]
        },
        {
          name: "King Fahad Medical City — Trauma Centre",
          meta: "Level 1 trauma centre, Riyadh",
          testsAvailable: [
            "FAST ultrasound",
            "Serum lactate",
            "Blood typing and crossmatch",
            "CT scan",
            "D-dimer"
          ]
        },
        {
          name: "Dhahran Trauma Center",
          meta: "Highway critical care hub",
          testsAvailable: [
            "FAST ultrasound",
            "CT scan",
            "Serum lactate",
            "ECG"
          ]
        }
      ]
    },
    {
      id: "s2",
      label: "Scenario 2 — Industrial Explosion (Yellow)",
      ai: {
        triage: "Yellow",
        hospital: "King Fahad Medical City — Trauma Centre",
        erTests: ["Plain X-ray", "Carboxyhaemoglobin level (CO)", "Burn depth assessment"],
        timeSeconds: 1.4
      },
      expectedScans: ["id","conclevel","hr","bp","rr","injury1","injury2"],
      scanVitals: {
        conclevel: { vitalKey: "consciousness", value: "Alert but disoriented" },
        rr:        { vitalKey: "rr",           value: "26 / min" },
        hr:        { vitalKey: "hr",           value: "110 bpm" },
        bp:        { vitalKey: "bp",           value: "100/70 mmHg" },
        injury1:   { vitalKey: "keyInjury",    value: "Burns to arms and face" },
        injury2:   { vitalKey: "keyInjury",    value: "Burns with chest tightness & dizziness" }
      },
      hospitals: [
        {
          name: "King Fahad Medical City — Trauma Centre",
          meta: "Level 1 trauma centre",
          testsAvailable: [
            "Plain X-ray",
            "Carboxyhaemoglobin level (CO)",
            "Burn depth assessment",
            "ECG",
            "D-dimer"
          ]
        },
        {
          name: "Mina Emergency Hospital",
          meta: "Mass-casualty capable unit",
          testsAvailable: [
            "Plain X-ray",
            "Burn depth assessment",
            "FAST ultrasound",
            "Pregnancy test"
          ]
        },
        {
          name: "Dhahran Trauma Center",
          meta: "High-capacity burn and trauma",
          testsAvailable: [
            "Plain X-ray",
            "CT scan",
            "Burn depth assessment",
            "ECG"
          ]
        }
      ]
    },
    {
      id: "s3",
      label: "Scenario 3 — Desert Rally (Green)",
      ai: {
        triage: "Green",
        hospital: "AlUla Field Medical Base",
        erTests: ["Plain X-ray", "Intravenous (IV) fluids", "FAST ultrasound"],
        timeSeconds: 1.5
      },
      expectedScans: ["id","conclevel","hr","bp","rr","injury1","injury2"],
      scanVitals: {
        conclevel: { vitalKey: "consciousness", value: "Walking, answering appropriately" },
        rr:        { vitalKey: "rr",           value: "18 / min" },
        hr:        { vitalKey: "hr",           value: "92 bpm" },
        bp:        { vitalKey: "bp",           value: "118/78 mmHg" },
        injury1:   { vitalKey: "keyInjury",    value: "Mild dehydration" },
        injury2:   { vitalKey: "keyInjury",    value: "Mild dehydration & heat stress" }
      },
      hospitals: [
        {
          name: "AlUla Field Medical Base",
          meta: "Desert response unit",
          testsAvailable: [
            "Plain X-ray",
            "Intravenous (IV) fluids",
            "FAST ultrasound",
            "ECG"
          ]
        },
        {
          name: "King Fahad Medical City — Trauma Centre",
          meta: "Definitive care (if required)",
          testsAvailable: [
            "Plain X-ray",
            "CT scan abdomen",
            "ECG",
            "Serum lactate"
          ]
        }
      ]
    },
    {
      id: "s4",
      label: "Scenario 4 — Highway Collision (Black)",
      ai: {
        triage: "Black",
        hospital: "Dhahran Trauma Center",
        erTests: ["FAST ultrasound", "CT scan", "Blood typing and crossmatch"],
        timeSeconds: 1.3
      },
      expectedScans: ["id","conclevel","hr","rr","injury1","injury2"], // no BP
      scanVitals: {
        conclevel: { vitalKey: "consciousness", value: "Unresponsive, fixed dilated pupils" },
        rr:        { vitalKey: "rr",           value: "No respiratory effort" },
        hr:        { vitalKey: "hr",           value: "No palpable pulse" },
        injury1:   { vitalKey: "keyInjury",    value: "Massive head trauma" },
        injury2:   { vitalKey: "keyInjury",    value: "Massive head and chest trauma" }
      },
      hospitals: [
        {
          name: "Dhahran Trauma Center",
          meta: "Highway critical care",
          testsAvailable: [
            "FAST ultrasound",
            "CT scan",
            "Blood typing and crossmatch",
            "ECG"
          ]
        },
        {
          name: "King Fahad Medical City — Trauma Centre",
          meta: "Level 1 trauma, tertiary review",
          testsAvailable: [
            "FAST ultrasound",
            "CT scan",
            "Serum lactate",
            "Plain X-ray"
          ]
        }
      ]
    }
  ];

  const scanTypes = ["id","conclevel","hr","bp","rr","injury1","injury2"];

  let currentScenario = scenarios[0];
  let scanState = {};
  let imageState = {};
  let vitalsState = { consciousness:null, rr:null, hr:null, bp:null, keyInjury:null };

  let timerRunning = false;
  let timerStart = null;
  let finalTimeMs = null;
  let triageModeStarted = false;

  let selectedTriage = null;
  let selectedHospital = null;
  let selectedTests = new Set();

  let leaderboard = [];
  let currentOperator = { name: "Unknown", mode: "Solo" };

  const operatorLabelEl = document.getElementById("operatorLabel");
  const scenarioSelectEl = document.getElementById("scenarioSelect");
  const scanRows = Array.from(document.querySelectorAll(".scan-row"));
  const figureVisual = document.getElementById("figureVisual");
  const figureFill = document.getElementById("figureFill");
  const figureHotspots = Array.from(document.querySelectorAll(".figure-hotspot"));
  const continueBtn = document.getElementById("continueBtn");
  const resetSimBtn = document.getElementById("resetSimBtn");
  const scanHintEl = document.getElementById("scanHint");
  const scanStatusLabel = document.getElementById("scanStatusLabel");

  const vConEl = document.getElementById("vConsciousness");
  const vRREl = document.getElementById("vRR");
  const vHREl = document.getElementById("vHR");
  const vBPEl = document.getElementById("vBP");
  const vKeyEl = document.getElementById("vKeyInjury");

  const timerDisplayEl = document.getElementById("timerDisplay");
  const timerHintEl = document.getElementById("timerHint");

  const triageCircles = Array.from(document.querySelectorAll(".triage-circle"));
  const hospitalListEl = document.getElementById("hospitalList");
  const testsListEl = document.getElementById("testsList");
  const submitDecisionBtn = document.getElementById("submitDecisionBtn");
  const decisionHintEl = document.getElementById("decisionHint");

  const resHumanTriage = document.getElementById("resHumanTriage");
  const resAITriage = document.getElementById("resAITriage");
  const resHumanHospital = document.getElementById("resHumanHospital");
  const resAIHospital = document.getElementById("resAIHospital");
  const resHumanTests = document.getElementById("resHumanTests");
  const resAITests = document.getElementById("resAITests");
  const resHumanTime = document.getElementById("resHumanTime");
  const resAITime = document.getElementById("resAITime");
  const matchTriage = document.getElementById("matchTriage");
  const matchHospital = document.getElementById("matchHospital");
  const matchTests = document.getElementById("matchTests");
  const matchTime = document.getElementById("matchTime");
  const scoreSummaryEl = document.getElementById("scoreSummary");
  const leaderboardBody = document.getElementById("leaderboardBody");
  const resetLeaderboardBtn = document.getElementById("resetLeaderboardBtn");

  const imageModal = document.getElementById("imageModal");
  const modalImage = document.getElementById("modalImage");
  const modalTitle = document.getElementById("modalTitle");
  const modalCloseBtn = document.getElementById("modalCloseBtn");

  function populateScenarioDropdown() {
    scenarioSelectEl.innerHTML = "";
    scenarios.forEach(s => {
      const opt = document.createElement("option");
      opt.value = s.id;
      opt.textContent = s.label;
      scenarioSelectEl.appendChild(opt);
    });
  }

  function selectScenarioById(id) {
    const sc = scenarios.find(s => s.id === id) || scenarios[0];
    currentScenario = sc;
    scenarioSelectEl.value = sc.id;
    resetSimulationState();
  }

  scenarioSelectEl.addEventListener("change", () => {
    selectScenarioById(scenarioSelectEl.value);
  });

  function updateVitalsDisplay() {
    vConEl.textContent = vitalsState.consciousness || "—";
    vRREl.textContent = vitalsState.rr || "—";
    vHREl.textContent = vitalsState.hr || "—";
    vBPEl.textContent = vitalsState.bp || "—";
    vKeyEl.textContent = vitalsState.keyInjury || "—";
  }

  function clearVitals() {
    vitalsState = { consciousness:null, rr:null, hr:null, bp:null, keyInjury:null };
    updateVitalsDisplay();
  }

  function resetTimer() {
    timerRunning = false;
    timerStart = null;
    finalTimeMs = null;
    triageModeStarted = false;
    timerDisplayEl.textContent = "0.00 s";
    timerHintEl.textContent = "Scan all QR tags first. The timer will start when you continue to triage.";
  }

  function startTimer() {
    if (timerRunning) return;
    timerRunning = true;
    timerStart = performance.now();
    timerHintEl.textContent = "Timer running… complete your triage decision.";
    requestAnimationFrame(updateTimerLoop);
  }

  function updateTimerLoop() {
    if (!timerRunning) return;
    const now = performance.now();
    const elapsed = now - timerStart;
    const seconds = Math.floor(elapsed / 1000);
    const centis = Math.floor((elapsed % 1000) / 10);
    timerDisplayEl.textContent = `${seconds}.${String(centis).padStart(2, "0")} s`;
    requestAnimationFrame(updateTimerLoop);
  }

  function stopTimer() {
    if (!timerRunning && finalTimeMs !== null) return;
    const now = performance.now();
    const elapsed = finalTimeMs !== null ? finalTimeMs : now - (timerStart || now);
    timerRunning = false;
    finalTimeMs = elapsed;
    const seconds = Math.floor(elapsed / 1000);
    const centis = Math.floor((elapsed % 1000) / 10);
    timerDisplayEl.textContent = `${seconds}.${String(centis).padStart(2, "0")} s (final)`;
    timerHintEl.textContent = "Triage finished. Compare your decision with the AI.";
  }

  function updateBodyFill() {
    if (!figureFill) return;
    const expected = currentScenario.expectedScans;
    const done = expected.filter(t => scanState[t]).length;

    if (done <= 0) {
      figureFill.style.opacity = "0";
      figureFill.style.clipPath = "inset(100% 0 0 0)";
      return;
    }

    const steps = expected.length;
    const seven = [12, 24, 40, 56, 72, 88, 100];
    const six   = [15, 32, 50, 66, 83, 100];
    const table = (steps === 7) ? seven : six;

    const idx = Math.min(done - 1, table.length - 1);
    const revealed = table[idx];
    figureFill.style.opacity = "1";
    figureFill.style.clipPath = `inset(0 0 ${100 - revealed}% 0)`;
  }

  function resetScanState() {
    scanTypes.forEach(t => {
      scanState[t] = false;
      imageState[t] = null;
    });

    scanRows.forEach(row => {
      row.classList.remove("filled");
      const s = row.querySelector(".scan-status");
      if (s) s.textContent = "Waiting for scan…";
    });

    figureVisual.classList.remove("review-mode");
    figureHotspots.forEach(h => h.classList.remove("active"));

    const bpRow = document.querySelector('.scan-row[data-scan="bp"]');
    const bpHot = document.querySelector('.figure-hotspot[data-scan="bp"]');
    if (currentScenario.id === "s4") {
      if (bpRow) {
        bpRow.style.opacity = "0.25";
        bpRow.style.pointerEvents = "none";
        bpRow.querySelector(".scan-status").textContent = "Not used in this scenario";
      }
      if (bpHot) {
        bpHot.style.opacity = "0";
        bpHot.style.pointerEvents = "none";
      }
    } else {
      if (bpRow) {
        bpRow.style.opacity = "1";
        bpRow.style.pointerEvents = "auto";
        bpRow.querySelector(".scan-status").textContent = "Waiting for scan…";
      }
      if (bpHot) {
        bpHot.style.opacity = "";
        bpHot.style.pointerEvents = "";
      }
    }

    continueBtn.disabled = true;
    scanStatusLabel.textContent = "Waiting for scans…";
    scanHintEl.querySelector("ol").style.opacity = "1";

    updateBodyFill();
  }

  function haveAllExpectedScans() {
    return currentScenario.expectedScans.every(t => scanState[t]);
  }

  function enterReviewMode() {
    figureVisual.classList.add("review-mode");
    scanHintEl.querySelector("ol").style.opacity = "0.6";
    scanStatusLabel.textContent = "In triage mode. Use the envelopes to review images.";
    figureHotspots.forEach(h => {
      const t = h.dataset.scan;
      if (scanState[t]) h.classList.add("active");
    });
    triageModeStarted = true;
    startTimer();
    updateSubmitState();
  }

  continueBtn.addEventListener("click", () => {
    if (continueBtn.disabled) return;
    enterReviewMode();
  });

  resetSimBtn.addEventListener("click", () => {
    resetSimulationState();
  });

  function inferScanTypeFromUrl(url) {
    const lower = url.toLowerCase();
    if (lower.includes("_id")) return "id";
    if (lower.includes("_conclevel")) return "conclevel";
    if (lower.includes("_hr")) return "hr";
    if (lower.includes("_bp")) return "bp";
    if (lower.includes("_rr")) return "rr";
    if (lower.includes("_injury1")) return "injury1";
    if (lower.includes("_injury2")) return "injury2";
    return null;
  }

  socket.on("qr-scanned", ({ url }) => {
    const scanType = inferScanTypeFromUrl(url);
    if (!scanType) return;

    if (!currentScenario.expectedScans.includes(scanType)) return;

    if (!scanState[scanType]) {
      scanState[scanType] = true;
      imageState[scanType] = url;

      const row = document.querySelector(`.scan-row[data-scan="${scanType}"]`);
      if (row) {
        row.classList.add("filled");
        const s = row.querySelector(".scan-status");
        if (s) s.textContent = "Scan received";
      }

      const mapping = currentScenario.scanVitals[scanType];
      if (mapping) {
        if (mapping.vitalKey === "consciousness") vitalsState.consciousness = mapping.value;
        if (mapping.vitalKey === "rr")           vitalsState.rr = mapping.value;
        if (mapping.vitalKey === "hr")           vitalsState.hr = mapping.value;
        if (mapping.vitalKey === "bp")           vitalsState.bp = mapping.value;
        if (mapping.vitalKey === "keyInjury")    vitalsState.keyInjury = mapping.value;
        updateVitalsDisplay();
      }

      updateBodyFill();

      scanStatusLabel.textContent = "Keep scanning from head to toe…";

      if (haveAllExpectedScans()) {
        continueBtn.disabled = false;
        scanStatusLabel.textContent = "All scans done. Press Continue to move to triage.";
      }
    }
  });

  socket.on("operator-info", ({ name, mode }) => {
    currentOperator = { name: name || "Visitor", mode: mode || "Solo" };
    operatorLabelEl.innerHTML = `Operator: <span class="glow">${currentOperator.name}</span> (${currentOperator.mode})`;
  });

  figureHotspots.forEach(h => {
    h.addEventListener("click", () => {
      const scanType = h.dataset.scan;
      if (!scanType || !scanState[scanType]) return;
      const url = imageState[scanType];
      if (!url) return;
      modalImage.src = url;
      modalTitle.textContent = `Scan image – ${scanType}`;
      imageModal.classList.add("open");
    });
  });

  modalCloseBtn.addEventListener("click", () => {
    imageModal.classList.remove("open");
    modalImage.src = "";
  });

  imageModal.addEventListener("click", (e) => {
    if (e.target === imageModal) {
      imageModal.classList.remove("open");
      modalImage.src = "";
    }
  });

  function resetDecision() {
    selectedTriage = null;
    selectedHospital = null;
    selectedTests = new Set();
    triageCircles.forEach(c => c.classList.remove("selected"));
    decisionHintEl.textContent = "Complete triage, hospital and tests after scanning all regions and pressing Continue.";
    submitDecisionBtn.disabled = true;
    renderHospitalsAndTests();
  }

  triageCircles.forEach(circle => {
    circle.addEventListener("click", () => {
      triageCircles.forEach(c => c.classList.remove("selected"));
      circle.classList.add("selected");
      selectedTriage = circle.dataset.level;
      updateSubmitState();
    });
  });

  function renderHospitalsAndTests() {
    hospitalListEl.innerHTML = "";
    currentScenario.hospitals.forEach(h => {
      const card = document.createElement("div");
      card.className = "hospital-card";
      card.dataset.name = h.name;
      card.innerHTML = `<div class="hospital-name">${h.name}</div>
                        <div class="hospital-meta">${h.meta}</div>`;
      card.addEventListener("click", () => {
        selectedHospital = h.name;
        Array.from(hospitalListEl.children).forEach(c => c.classList.remove("selected"));
        card.classList.add("selected");
        renderTests(h.testsAvailable);
        updateSubmitState();
      });
      hospitalListEl.appendChild(card);
    });

    const first = currentScenario.hospitals[0];
    if (first) {
      selectedHospital = first.name;
      const card = hospitalListEl.querySelector(`[data-name="${first.name}"]`);
      if (card) card.classList.add("selected");
      renderTests(first.testsAvailable);
    } else {
      testsListEl.innerHTML = "<div style='font-size:12px;color:var(--muted);'>No ER tests configured.</div>";
    }
  }

  function renderTests(list) {
    testsListEl.innerHTML = "";
    selectedTests = new Set();
    list.forEach(testName => {
      const row = document.createElement("label");
      row.className = "test-row";
      row.innerHTML = `<input type="checkbox" value="${testName}">
                       <span>${testName}</span>`;
      const checkbox = row.querySelector("input");
      checkbox.addEventListener("change", () => {
        if (checkbox.checked) selectedTests.add(testName);
        else selectedTests.delete(testName);
        updateSubmitState();
      });
      testsListEl.appendChild(row);
    });
  }

  function updateSubmitState() {
    const ready =
      triageModeStarted &&
      selectedTriage &&
      selectedHospital &&
      selectedTests.size > 0;

    submitDecisionBtn.disabled = !ready;
    decisionHintEl.textContent = ready
      ? "Ready to submit. Compare your plan with the AI."
      : "Complete triage, hospital and ER tests after you move to triage and the timer starts.";
  }

  submitDecisionBtn.addEventListener("click", () => {
    if (submitDecisionBtn.disabled) return;

    stopTimer();
    const timeSeconds = finalTimeMs ? finalTimeMs / 1000 : 0;

    const human = {
      triage: selectedTriage,
      hospital: selectedHospital,
      tests: Array.from(selectedTests),
      timeSeconds
    };

    showResults(human);
    const score = extractScoreFromSummary();

    socket.emit("final-score", {
      operator: currentOperator,
      scenarioId: currentScenario.id,
      score,
      timeSeconds: human.timeSeconds ?? 0
    });
  });

  function showResults(human) {
    const ai = currentScenario.ai;
    resHumanTriage.textContent = human.triage;
    resAITriage.textContent = ai.triage;
    resHumanHospital.textContent = human.hospital;
    resAIHospital.textContent = ai.hospital;
    resHumanTests.textContent = human.tests.join(", ");
    resAITests.textContent = ai.erTests.join(", ");

    const tHuman = human.timeSeconds ?? 0;
    resHumanTime.textContent = `${tHuman.toFixed(2)} s`;
    resAITime.textContent = `${ai.timeSeconds.toFixed(2)} s`;

    let score = 0;

    const triageMatch = human.triage === ai.triage;
    markMatch(matchTriage, triageMatch);
    if (triageMatch) score += 5;

    const hospMatch = human.hospital === ai.hospital;
    markMatch(matchHospital, hospMatch);
    if (hospMatch) score += 3;

    const aiSet = new Set(ai.erTests);
    const humanSet = new Set(human.tests);
    const testsMatch = ai.erTests.length === human.tests.length &&
                       ai.erTests.every(t => humanSet.has(t));
    markMatch(matchTests, testsMatch);
    if (testsMatch) score += 2;

    const faster = human.timeSeconds && human.timeSeconds < ai.timeSeconds;
    markMatch(matchTime, faster);
    if (faster) score += 2;

    scoreSummaryEl.textContent = `Score: ${score} / 12 points`;
  }

  function markMatch(cell, ok) {
    cell.className = "match-cell " + (ok ? "match-yes" : "match-no");
    cell.textContent = ok ? "✅" : "❌";
  }

  function extractScoreFromSummary() {
    const text = scoreSummaryEl.textContent;
    const m = /Score:\s+(\d+)\s+\/\s+12/.exec(text);
    return m ? parseInt(m[1], 10) : 0;
  }

  function addToLeaderboard(entry) {
    leaderboard.push(entry);
    leaderboard.sort((a, b) => {
      if (b.score !== a.score) return b.score - a.score;
      return a.timeSeconds - b.timeSeconds;
    });
    renderLeaderboard();
    try {
      localStorage.setItem("triageLeaderboard", JSON.stringify(leaderboard));
    } catch (e) {}
  }

  function renderLeaderboard() {
    leaderboardBody.innerHTML = "";
    leaderboard.forEach((e, idx) => {
      const tr = document.createElement("tr");
      tr.innerHTML = `<td>${idx+1}</td>
                      <td>${e.name}</td>
                      <td>${e.mode}</td>
                      <td>${e.scenarioLabel}</td>
                      <td>${e.score}</td>
                      <td>${e.timeSeconds.toFixed(2)} s</td>`;
      leaderboardBody.appendChild(tr);
    });
  }

  function loadLeaderboardFromStorage() {
    let saved = null;
    try {
      saved = localStorage.getItem("triageLeaderboard");
    } catch (e) {
      saved = null;
    }
    if (saved) {
      try {
        const arr = JSON.parse(saved);
        if (Array.isArray(arr)) {
          leaderboard = arr;
          renderLeaderboard();
        }
      } catch (e) {}
    }
  }

  resetLeaderboardBtn.addEventListener("click", () => {
    leaderboard = [];
    renderLeaderboard();
    try { localStorage.removeItem("triageLeaderboard"); } catch (e) {}
    socket.emit("reset-leaderboard");
  });

  socket.on("reset-leaderboard", () => {
    leaderboard = [];
    renderLeaderboard();
    try { localStorage.removeItem("triageLeaderboard"); } catch (e) {}
  });

  socket.on("final-score", (payload) => {
    if (!payload || !payload.operator) return;
    const sc = scenarios.find(s => s.id === payload.scenarioId);
    const scenarioLabel = sc ? sc.label : "Unknown scenario";
    addToLeaderboard({
      name: payload.operator.name || "Unknown",
      mode: payload.operator.mode || "Solo",
      scenarioLabel,
      score: payload.score ?? 0,
      timeSeconds: payload.timeSeconds ?? 0
    });
  });

  function clearResultsOnly() {
    resHumanTriage.textContent = "—";
    resAITriage.textContent = "—";
    resHumanHospital.textContent = "—";
    resAIHospital.textContent = "—";
    resHumanTests.textContent = "—";
    resAITests.textContent = "—";
    resHumanTime.textContent = "—";
    resAITime.textContent = "—";
    [matchTriage,matchHospital,matchTests,matchTime].forEach(el => {
      el.textContent = "—";
      el.className = "match-cell";
    });
    scoreSummaryEl.textContent = "Score: 0 / 12 points";
  }

  function resetSimulationState() {
    resetScanState();
    clearVitals();
    resetTimer();
    resetDecision();
    clearResultsOnly();
  }

  socket.on("final-score-initial", (entries) => {
    // if your server ever sends an initial full board, you could handle here
  });

  socket.on("connect", () => {
    // nothing special; leaderboard is already loaded from localStorage
  });

  function populateAndInit() {
    populateScenarioDropdown();
    selectScenarioById(scenarios[0].id);
    loadLeaderboardFromStorage();
  }

  populateAndInit();
</script>
</body>
</html>
