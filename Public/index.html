<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>AI Drone Triage 2040</title>

<style>
body {
    background: #0d1117;
    color: #e6edf3;
    font-family: Arial, sans-serif;
    padding: 20px;
}

/* Layout */
.container {
    display: flex;
    gap: 20px;
}

/* Body map */
.body-slot {
    width: 260px;
    height: 260px;
    background: #111827;
    border: 2px dashed #4b5563;
    border-radius: 12px;
    display: flex;
    justify-content: center;
    align-items: center;
    margin-bottom: 20px;
    overflow: hidden;
}
.body-slot img {
    width: 100%;
    height: 100%;
    object-fit: contain; /* BIGGER IMAGE */
}

/* Vital panel */
.vital-line {
    font-size: 22px;
    margin-bottom: 8px;
}

/* Timer */
#triageTimer {
    font-size: 32px;
    margin-top: 25px;
    font-weight: bold;
}

/* Alerts */
#alertBox {
    margin-top: 15px;
    font-size: 20px;
    color: #ff7070;
}

/* Dropdown clean */
select option {
    background: #0d1117;
    color: #fff;
}
</style>
</head>

<body>

<h1>üßç Patient Body Map & Drone Feed</h1>

<div>
<label>Scenario</label><br>
<select id="scenarioSelect">
    <option value="1">Scenario 1 ‚Äî Hajj Stampede</option>
    <option value="2">Scenario 2 ‚Äî Industrial Explosion</option>
    <option value="3">Scenario 3 ‚Äî Desert Rally</option>
    <option value="4">Scenario 4 ‚Äî Highway Collision</option>
</select>
</div>

<div class="container">

<!-- LEFT SIDE: BODY MAP -->
<div>
    <h2>BODY MAP (HEAD ‚Üí TOES)</h2>

    <div class="body-slot" id="slot_head">Scan tag for head</div>
    <div class="body-slot" id="slot_chest">Scan tag for chest</div>
    <div class="body-slot" id="slot_abdomen">Scan tag for abdomen</div>
    <div class="body-slot" id="slot_arms">Scan tag for arms</div>
    <div class="body-slot" id="slot_legs">Scan tag for legs</div>

    <div id="alertBox"></div>
</div>

<!-- RIGHT SIDE: VITALS -->
<div>
    <h2>Live Vitals (from Drone)</h2>

    <div class="vital-line" id="v_consciousness">Consciousness: ‚Äî ‚Äî</div>
    <div class="vital-line" id="v_rr">Respiratory Rate (RR): ‚Äî ‚Äî</div>
    <div class="vital-line" id="v_hr">Heart Rate (HR): ‚Äî ‚Äî</div>
    <div class="vital-line" id="v_bp">Blood Pressure (BP): ‚Äî ‚Äî</div>
    <div class="vital-line" id="v_injury">Key Injury / Problem: ‚Äî ‚Äî</div>

    <h2>TRIAGE TIMER</h2>
    <div id="triageTimer">--.--s</div>
</div>

</div>

<script>
// -----------------------------------------------------
// FIXED SCENARIO ‚Üí VITALS MAPPING
// -----------------------------------------------------
const scenarioVitals = {
    1: {
        head:      { consciousness: "Unconscious" },
        chest:     { rr: "34 / min" },
        abdomen:   { hr: "142 bpm" },
        arms:      { bp: "78/45 mmHg" },
        legs:      { injury: "Severe abdominal bleeding / pelvic fracture" }
    },
    2: {
        head:      { consciousness: "Alert but confused" },
        chest:     { rr: "26 / min" },
        abdomen:   { hr: "110 bpm" },
        arms:      { bp: "100/70 mmHg" },
        legs:      { injury: "Burns + chest tightness" }
    },
    3: {
        head:      { consciousness: "Walking" },
        chest:     { rr: "18 / min" },
        abdomen:   { hr: "92 bpm" },
        arms:      { bp: "118/78 mmHg" },
        legs:      { injury: "Mild dehydration" }
    },
    4: {
        head:      { consciousness: "No response" },
        chest:     { rr: "0 / min" },
        abdomen:   { hr: "0 bpm" },
        arms:      { bp: "0/0 mmHg" },
        legs:      { injury: "Massive trauma / no signs of life" }
    }
};

// Track scanned parts
const scanned = {
    head: false,
    chest: false,
    abdomen: false,
    arms: false,
    legs: false
};

// Timer
let startTime = null;
function updateTimer() {
    if (!startTime) return;
    let s = ((Date.now() - startTime) / 1000).toFixed(2);
    document.getElementById("triageTimer").innerText = s + " s";
    requestAnimationFrame(updateTimer);
}

// -----------------------------------------------------
// FIXED QR PARSER ‚Äî SUPPORTS RAW GITHUB / IMGUR / ANY URL
// -----------------------------------------------------
function parseQrData(qrText) {
    try {
        const url = new URL(qrText);
        const file = url.pathname.split("/").pop();

        // MUST be named:  s1_head.jpg
        const match = file.match(/^s(\d+)_(head|chest|abdomen|arms|legs)\.(jpg|jpeg|png)$/i);
        if (!match) return null;

        return {
            scenario: parseInt(match[1]),
            part: match[2],
            imageUrl: url.href
        };
    } catch {
        return null;
    }
}

// -----------------------------------------------------
// MAIN SCAN HANDLER
// -----------------------------------------------------
function handleQrScan(qrText) {
    const data = parseQrData(qrText);

    if (!data) {
        document.getElementById("alertBox").innerText =
            "Invalid tag scanned. Use official game QR codes.";
        return;
    }

    const selected = parseInt(document.getElementById("scenarioSelect").value);

    if (data.scenario !== selected) {
        document.getElementById("alertBox").innerText =
            "This tag belongs to a different scenario.";
        return;
    }

    if (scanned[data.part]) {
        document.getElementById("alertBox").innerText =
            "You already scanned this part.";
        return;
    }

    document.getElementById("alertBox").innerText = "";

    // Start timer on first scan
    if (!startTime) {
        startTime = Date.now();
        updateTimer();
    }

    scanned[data.part] = true;

    // SHOW IMAGE (BIG)
    document.getElementById("slot_" + data.part).innerHTML =
        `<img src="${data.imageUrl}" />`;

    // SHOW VITAL
    const v = scenarioVitals[selected][data.part];

    if (v.consciousness)
        document.getElementById("v_consciousness").innerText =
            "Consciousness: " + v.consciousness;

    if (v.rr)
        document.getElementById("v_rr").innerText =
            "Respiratory Rate (RR): " + v.rr;

    if (v.hr)
        document.getElementById("v_hr").innerText =
            "Heart Rate (HR): " + v.hr;

    if (v.bp)
        document.getElementById("v_bp").innerText =
            "Blood Pressure (BP): " + v.bp;

    if (v.injury)
        document.getElementById("v_injury").innerText =
            "Key Injury / Problem: " + v.injury;
}

// -----------------------------------------------------
// DEBUG BUTTON (REMOVE LATER)
// Simulate scan on desktop:
// handleQrScan("https://raw.githubusercontent.com/.../s1_head.jpg");
// -----------------------------------------------------
window.handleQrScan = handleQrScan;

</script>

</body>
</html>
