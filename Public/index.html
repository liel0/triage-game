<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>AI Triage Drone 2040</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    :root {
      --bg: #050815;
      --panel: #0b1020;
      --panel-soft: #101628;
      --accent: #3ddcff;
      --accent-soft: rgba(61, 220, 255, 0.22);
      --accent-strong: #24b8ff;
      --accent-warm: #ffb347;
      --accent-red: #ff5c7a;
      --accent-green: #6dffb3;
      --accent-yellow: #ffd86b;
      --accent-black: #888da3;
      --text-main: #f7fbff;
      --text-subtle: #9ba4c7;
      --chip-bg: #141a30;
      --chip-on: #1e2640;
      --chip-border: #252f4a;
      --border-soft: #141a2e;
      --danger: #ff4b6a;
      --good: #5dffb5;
      --shadow-soft: 0 0 40px rgba(0, 0, 0, 0.8);
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      padding: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI",
        sans-serif;
      background: radial-gradient(circle at top, #131a33 0, #050815 52%, #020411 100%);
      color: var(--text-main);
      overflow-x: hidden;
    }

    h1,
    h2,
    h3,
    h4 {
      margin: 0;
      font-weight: 500;
    }

    .app-shell {
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      color: var(--text-main);
    }

    header {
      padding: 12px 32px;
      border-bottom: 1px solid #151b30;
      background: linear-gradient(
        to right,
        rgba(61, 220, 255, 0.15),
        transparent
      );
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 16px;
    }

    header .title-block {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .title-badge {
      width: 26px;
      height: 26px;
      border-radius: 50%;
      border: 2px solid rgba(61, 220, 255, 0.7);
      box-shadow: 0 0 16px rgba(61, 220, 255, 0.9);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 11px;
      color: var(--accent);
    }

    header h1 {
      font-size: 16px;
      letter-spacing: 0.05em;
      text-transform: uppercase;
    }

    header .subtitle {
      font-size: 12px;
      color: var(--text-subtle);
    }

    header .mode-indicator {
      font-size: 11px;
      color: var(--text-subtle);
      display: flex;
      align-items: center;
      gap: 10px;
    }

    header .operator-pill {
      padding: 4px 10px;
      border-radius: 999px;
      background: linear-gradient(
        135deg,
        rgba(61, 220, 255, 0.15),
        rgba(130, 255, 194, 0.12)
      );
      border: 1px solid rgba(61, 220, 255, 0.45);
      font-size: 11px;
    }

    /* --- MAIN GRID LAYOUT --- */
    .main-grid {
      flex: 1;
      padding: 18px 18px 24px;
      display: grid;
      grid-template-columns: minmax(420px, 520px) minmax(420px, 520px);
      grid-template-rows: minmax(360px, 420px) minmax(260px, 320px);
      gap: 16px;
    }

    .panel {
      background: radial-gradient(circle at top, #151b30 0, #050815 52%);
      border-radius: 18px;
      border: 1px solid var(--border-soft);
      box-shadow: var(--shadow-soft);
      padding: 14px 18px;
      position: relative;
      overflow: hidden;
    }

    .panel::before {
      content: "";
      position: absolute;
      inset: -80%;
      background: radial-gradient(
        circle at top,
        rgba(61, 220, 255, 0.09),
        transparent 60%
      );
      opacity: 0.7;
      pointer-events: none;
    }

    .panel-inner {
      position: relative;
      z-index: 1;
    }

    .panel-header {
      display: flex;
      justify-content: space-between;
      align-items: baseline;
      margin-bottom: 10px;
      gap: 12px;
    }

    .panel-title {
      font-size: 14px;
      letter-spacing: 0.06em;
      text-transform: uppercase;
      color: var(--text-subtle);
    }

    .panel-subtitle {
      font-size: 11px;
      color: var(--text-subtle);
    }

    /* --- PATIENT MAP + SILHOUETTE --- */
    .patient-grid {
      display: grid;
      grid-template-columns: minmax(260px, 340px) minmax(220px, 280px);
      gap: 12px;
      align-items: stretch;
    }

    .scenario-select {
      width: 100%;
      margin-bottom: 8px;
      padding: 6px 10px;
      border-radius: 999px;
      border: 1px solid #222a3f;
      background: rgba(4, 10, 28, 0.95);
      color: var(--text-main);
      font-size: 12px;
      outline: none;
      appearance: none;
      position: relative;
    }

    .scenario-select-wrapper {
      position: relative;
      margin-bottom: 10px;
    }

    .scenario-select-wrapper::after {
      content: "▾";
      position: absolute;
      right: 12px;
      top: 50%;
      transform: translateY(-50%);
      font-size: 10px;
      pointer-events: none;
      color: var(--text-subtle);
    }

    .body-slot-list {
      display: flex;
      flex-direction: column;
      gap: 6px;
      margin-top: 6px;
    }

    .body-slot {
      border-radius: 999px;
      background: linear-gradient(90deg, #080d20, #050815);
      border: 1px solid #161c33;
      padding: 6px 14px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 10px;
      font-size: 12px;
      min-height: 34px;
    }

    .body-slot-label {
      display: flex;
      flex-direction: column;
      gap: 2px;
    }

    .body-slot-title {
      font-size: 12px;
    }

    .body-slot-status {
      font-size: 10px;
      color: var(--text-subtle);
    }

    .body-slot-tag {
      font-size: 10px;
      padding: 2px 8px;
      border-radius: 999px;
      border: 1px solid rgba(61, 220, 255, 0.48);
      background: rgba(61, 220, 255, 0.1);
      color: var(--accent);
    }

    .body-slot.scanned {
      border-color: var(--accent);
      box-shadow: 0 0 16px rgba(61, 220, 255, 0.35);
      background: radial-gradient(circle at left, #0b1530 0, #050815 65%);
    }

    .body-slot.scanned .body-slot-status {
      color: var(--accent-soft);
    }

    .body-slot-index {
      font-size: 10px;
      color: var(--text-subtle);
    }

    .scan-order-hint {
      margin-top: 6px;
      font-size: 10px;
      color: var(--text-subtle);
    }

    .scan-order-hint strong {
      color: var(--accent-soft);
      font-weight: 500;
    }

    /* --- SILHOUETTE COLUMN --- */
    .silhouette-panel {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: flex-start;
      gap: 8px;
      padding-top: 6px;
    }

    .silhouette-shell {
      position: relative;
      width: 82%;
      max-width: 260px;
      aspect-ratio: 1 / 2.6;
      border-radius: 999px;
      background: radial-gradient(circle at top, #121a30 0, #040719 55%);
      border: 1px solid #222840;
      box-shadow: 0 0 45px rgba(0, 0, 0, 0.9);
      overflow: hidden;
    }

    /* Human silhouette image – put images/silhouette.png */
    .silhouette-figure {
      position: absolute;
      inset: 10% 23% 6%;
      opacity: 0.18;
      mix-blend-mode: screen;
      filter: drop-shadow(0 0 16px rgba(0, 0, 0, 0.9));
      pointer-events: none;
      z-index: 2;
      object-fit: contain;
    }

    .silhouette-layer {
      position: absolute;
      left: 14%;
      right: 14%;
      height: 11.5%;
      background: radial-gradient(circle at center, #101a35 0, #050816 70%);
      border-radius: 999px;
      border: 1px solid rgba(60, 78, 132, 0.75);
      overflow: hidden;
      transform-origin: left center;
    }

    .silhouette-layer-fill {
      position: absolute;
      inset: 0;
      background: linear-gradient(
        90deg,
        rgba(61, 220, 255, 0.14),
        rgba(61, 220, 255, 0.9),
        rgba(130, 255, 194, 0.9)
      );
      box-shadow: 0 0 18px rgba(61, 220, 255, 0.9);
      transform: scaleX(0);
      transform-origin: left center;
      transition: transform 460ms cubic-bezier(0.17, 0.89, 0.32, 1.3);
      opacity: 0.95;
    }

    .silhouette-layer.active .silhouette-layer-fill {
      transform: scaleX(1);
    }

    .silhouette-layer[data-slot="1"] {
      top: 9%;
    }
    .silhouette-layer[data-slot="2"] {
      top: 21%;
    }
    .silhouette-layer[data-slot="3"] {
      top: 33%;
    }
    .silhouette-layer[data-slot="4"] {
      top: 45%;
    }
    .silhouette-layer[data-slot="5"] {
      top: 57%;
    }
    .silhouette-layer[data-slot="6"] {
      top: 69%;
    }
    .silhouette-layer[data-slot="7"] {
      top: 81%;
    }

    .silhouette-caption {
      font-size: 10px;
      text-align: center;
      color: var(--text-subtle);
      max-width: 250px;
    }

    .silhouette-caption strong {
      color: var(--accent-soft);
    }

    /* --- LIVE VITALS PANEL --- */
    .vitals-list {
      margin-top: 4px;
      display: flex;
      flex-direction: column;
      gap: 4px;
      font-size: 11px;
    }

    .vitals-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 5px 10px;
      border-radius: 999px;
      border: 1px solid #141a30;
      background: radial-gradient(circle at left, #091022 0, #020413 65%);
    }

    .vitals-label {
      color: var(--text-subtle);
    }

    .vitals-value {
      color: var(--accent);
    }

    .timer-panel {
      margin-top: 10px;
      border-radius: 14px;
      padding: 8px 12px;
      border: 1px solid rgba(255, 196, 120, 0.5);
      background: linear-gradient(
        90deg,
        rgba(255, 177, 99, 0.28),
        transparent
      );
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 10px;
      font-size: 11px;
    }

    .timer-title {
      font-weight: 500;
      text-transform: uppercase;
      letter-spacing: 0.06em;
      color: var(--accent-warm);
    }

    .timer-value {
      font-size: 14px;
      font-variant-numeric: tabular-nums;
      padding: 4px 10px;
      border-radius: 999px;
      background: rgba(3, 6, 20, 0.9);
      border: 1px solid rgba(255, 213, 142, 0.8);
      color: #ffe2a3;
    }

    .coming-soon {
      margin-top: 10px;
      padding: 8px 10px;
      border-radius: 14px;
      border: 1px dashed rgba(124, 139, 186, 0.7);
      background: rgba(10, 14, 32, 0.9);
      font-size: 10px;
      color: var(--text-subtle);
    }

    .coming-soon strong {
      color: var(--accent-soft);
    }

    /* --- HUMAN TRIAGE DECISION PANEL --- */
    .triage-grid {
      display: grid;
      grid-template-columns: minmax(300px, 360px) minmax(380px, 1fr);
      gap: 14px;
      align-items: flex-start;
    }

    .triage-steps {
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .step-title {
      font-size: 11px;
      letter-spacing: 0.08em;
      text-transform: uppercase;
      color: var(--text-subtle);
      margin-bottom: 6px;
    }

    .triage-colors {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
    }

    .triage-pill {
      padding: 6px 10px 6px 9px;
      border-radius: 999px;
      border: 1px solid #1c2339;
      background: radial-gradient(circle at top, #151b2f 0, #050815 70%);
      display: flex;
      align-items: center;
      gap: 6px;
      font-size: 11px;
      cursor: pointer;
      transition: border 160ms, background 160ms, box-shadow 160ms,
        transform 80ms;
    }

    .triage-pill:hover {
      border-color: rgba(61, 220, 255, 0.8);
      box-shadow: 0 0 14px rgba(61, 220, 255, 0.35);
      transform: translateY(-1px);
    }

    .triage-pill.active {
      border-color: var(--accent);
      background: radial-gradient(circle at top, #182549 0, #050815 78%);
      box-shadow: 0 0 16px rgba(61, 220, 255, 0.4);
    }

    .triage-color-dot {
      width: 14px;
      height: 14px;
      border-radius: 50%;
      box-shadow: 0 0 10px rgba(0, 0, 0, 0.7);
    }

    .triage-color-red {
      background: radial-gradient(circle at 30% 20%, #ffe6f0, #ff3059);
    }

    .triage-color-yellow {
      background: radial-gradient(circle at 30% 20%, #fff6d3, #ffb347);
    }

    .triage-color-green {
      background: radial-gradient(circle at 30% 20%, #e3ffe9, #25e47a);
    }

    .triage-color-black {
      background: radial-gradient(circle at 30% 20%, #d5dae5, #4b4f63);
    }

    .triage-pill span {
      font-size: 11px;
    }

    .triage-pill small {
      font-size: 9px;
      color: var(--text-subtle);
    }

    .hospital-list {
      border-radius: 12px;
      border: 1px solid #1b2237;
      background: rgba(8, 12, 26, 0.95);
      overflow: hidden;
    }

    .hospital-item {
      padding: 7px 10px;
      border-bottom: 1px solid #12172a;
      font-size: 11px;
      cursor: pointer;
      display: flex;
      flex-direction: column;
      gap: 2px;
    }

    .hospital-item:last-child {
      border-bottom: none;
    }

    .hospital-name {
      font-size: 11px;
    }

    .hospital-desc {
      font-size: 10px;
      color: var(--text-subtle);
    }

    .hospital-item.active {
      background: radial-gradient(circle at left, #192748 0, #050815 70%);
      border-color: rgba(61, 220, 255, 0.55);
      box-shadow: 0 0 14px rgba(61, 220, 255, 0.35);
    }

    .er-tests-wrapper {
      border-radius: 14px;
      border: 1px solid #1c2339;
      background: radial-gradient(circle at top, #151b2f 0, #050815 70%);
      padding: 8px 10px 10px;
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    .er-tests-chips {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
    }

    .chip {
      border-radius: 999px;
      padding: 4px 9px;
      border: 1px solid var(--chip-border);
      background: var(--chip-bg);
      font-size: 10px;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 4px;
      transition: 150ms;
    }

    .chip::before {
      content: "";
      width: 6px;
      height: 6px;
      border-radius: 50%;
      background: #596089;
    }

    .chip.active {
      border-color: var(--accent);
      background: var(--chip-on);
      box-shadow: 0 0 12px rgba(61, 220, 255, 0.4);
    }

    .chip.active::before {
      background: var(--accent);
    }

    .er-tests-hint {
      font-size: 10px;
      color: var(--text-subtle);
    }

    .triage-actions {
      display: flex;
      justify-content: flex-end;
      gap: 10px;
      margin-top: 12px;
      flex-wrap: wrap;
    }

    .btn {
      border-radius: 999px;
      padding: 7px 18px;
      font-size: 11px;
      border: none;
      outline: none;
      cursor: pointer;
      letter-spacing: 0.04em;
      text-transform: uppercase;
      font-weight: 500;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      transition: background 140ms, transform 70ms, box-shadow 140ms,
        opacity 120ms;
      white-space: nowrap;
    }

    .btn:disabled {
      opacity: 0.4;
      cursor: default;
      box-shadow: none !important;
      transform: none !important;
    }

    .btn-primary {
      background: linear-gradient(135deg, var(--accent-strong), #4bffda);
      color: #02101a;
      box-shadow: 0 0 18px rgba(61, 220, 255, 0.7);
    }

    .btn-primary:hover:not(:disabled) {
      box-shadow: 0 0 24px rgba(61, 220, 255, 0.9);
      transform: translateY(-1px);
    }

    .btn-secondary {
      background: radial-gradient(circle at top, #1b233a 0, #050815 65%);
      border: 1px solid #232c45;
      color: var(--text-main);
    }

    .btn-secondary:hover:not(:disabled) {
      border-color: var(--accent-soft);
      box-shadow: 0 0 14px rgba(61, 220, 255, 0.4);
      transform: translateY(-1px);
    }

    /* --- RESULTS PANEL + LEADERBOARD --- */
    .results-grid {
      display: grid;
      grid-template-rows: auto minmax(120px, 1fr);
      gap: 10px;
    }

    .comparison-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 11px;
    }

    .comparison-table th,
    .comparison-table td {
      text-align: left;
      padding: 4px 6px;
      border-bottom: 1px solid #151a2d;
    }

    .comparison-table th {
      font-weight: 500;
      font-size: 10px;
      color: var(--text-subtle);
      text-transform: uppercase;
      letter-spacing: 0.06em;
    }

    .comparison-table td:nth-child(2) {
      color: var(--accent-soft);
    }

    .comparison-table td:nth-child(3) {
      color: var(--accent-green);
    }

    .comparison-table td:nth-child(4) {
      font-variant-numeric: tabular-nums;
    }

    .match-pill {
      padding: 2px 8px;
      border-radius: 999px;
      font-size: 10px;
      border: 1px solid transparent;
    }

    .match-pill.ok {
      border-color: rgba(99, 255, 195, 0.7);
      background: rgba(47, 180, 122, 0.18);
      color: var(--good);
    }

    .match-pill.bad {
      border-color: rgba(255, 109, 123, 0.7);
      background: rgba(191, 41, 80, 0.21);
      color: var(--danger);
    }

    .score-line {
      margin-top: 4px;
      font-size: 11px;
      color: var(--text-subtle);
    }

    .score-line strong {
      color: var(--accent-soft);
    }

    .leaderboard-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 4px;
      font-size: 11px;
    }

    .leaderboard-actions {
      display: flex;
      gap: 8px;
    }

    .btn-ghost {
      border-radius: 999px;
      padding: 5px 12px;
      font-size: 10px;
      border: 1px solid #222944;
      background: rgba(7, 10, 24, 0.9);
      color: var(--text-subtle);
      cursor: pointer;
      transition: 140ms;
      white-space: nowrap;
    }

    .btn-ghost:hover {
      border-color: var(--accent-soft);
      color: var(--accent-soft);
      box-shadow: 0 0 12px rgba(61, 220, 255, 0.35);
    }

    .leaderboard-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 11px;
    }

    .leaderboard-table th,
    .leaderboard-table td {
      text-align: left;
      padding: 4px 6px;
      border-bottom: 1px solid #13182a;
    }

    .leaderboard-table th {
      font-weight: 500;
      font-size: 10px;
      color: var(--text-subtle);
      text-transform: uppercase;
      letter-spacing: 0.06em;
    }

    .leaderboard-table td:nth-child(1) {
      width: 32px;
      color: var(--text-subtle);
    }

    .leaderboard-table td:nth-child(4),
    .leaderboard-table td:nth-child(5) {
      font-variant-numeric: tabular-nums;
    }

    /* --- SMALL SCREENS (fallback only, main screen is projector) --- */
    @media (max-width: 1100px) {
      .main-grid {
        grid-template-columns: 1fr;
        grid-template-rows: auto auto auto auto;
      }

      .patient-grid {
        grid-template-columns: minmax(260px, 1fr);
      }

      .silhouette-panel {
        margin-top: 10px;
      }

      .triage-grid {
        grid-template-columns: 1fr;
      }
    }
  </style>
</head>
<body>
<div class="app-shell">
  <header>
    <div class="title-block">
      <div class="title-badge">AI</div>
      <div>
        <h1>AI TRIAGE DRONE 2040</h1>
        <div class="subtitle">Mass casualty triage training • Human vs AI</div>
      </div>
    </div>
    <div class="mode-indicator">
      <span>Mode: <strong>Solo</strong></span>
      <span class="operator-pill">Operator: Waiting for mobile operator…</span>
    </div>
  </header>

  <main class="main-grid">
    <!-- PATIENT BODY MAP + SILHOUETTE -->
    <section class="panel">
      <div class="panel-inner">
        <div class="panel-header">
          <div>
            <div class="panel-title">PATIENT BODY MAP &amp; DRONE FEED</div>
            <div class="panel-subtitle">
              Scan QR tags from head to toe. Silhouette fills as you scan.
            </div>
          </div>
        </div>

        <div class="scenario-select-wrapper">
          <select id="scenarioSelect" class="scenario-select">
            <option value="1">Scenario 1 — Hajj Stampede (Red)</option>
            <option value="2">Scenario 2 — Industrial Explosion (Yellow)</option>
            <option value="3">Scenario 3 — Desert Rally (Green)</option>
            <option value="4">Scenario 4 — Highway Collision (Black)</option>
          </select>
        </div>

        <div class="patient-grid">
          <!-- LEFT: BODY SLOTS -->
          <div>
            <div class="body-slot-list" id="bodySlotList">
              <!-- slots injected by JS -->
            </div>
            <div class="scan-order-hint" id="scanOrderHint">
              Scan order:
              <strong>1.</strong> Eyes / ID →
              <strong>2.</strong> Face / consciousness →
              <strong>3.</strong> Neck / heart rate →
              <strong>4.</strong> Chest / respiratory rate →
              <strong>5.</strong> Arms / blood pressure (not used in Scenario 4) →
              <strong>6.</strong> Pelvis / abdomen →
              <strong>7.</strong> Legs / feet.
            </div>
          </div>

          <!-- RIGHT: SILHOUETTE -->
          <div class="silhouette-panel">
            <div class="silhouette-shell" id="silhouetteShell">
              <!-- 7 layers for all cases; JS only activates 6 for Scenario 4 -->
              <div class="silhouette-layer" data-slot="1">
                <div class="silhouette-layer-fill"></div>
              </div>
              <div class="silhouette-layer" data-slot="2">
                <div class="silhouette-layer-fill"></div>
              </div>
              <div class="silhouette-layer" data-slot="3">
                <div class="silhouette-layer-fill"></div>
              </div>
              <div class="silhouette-layer" data-slot="4">
                <div class="silhouette-layer-fill"></div>
              </div>
              <div class="silhouette-layer" data-slot="5">
                <div class="silhouette-layer-fill"></div>
              </div>
              <div class="silhouette-layer" data-slot="6">
                <div class="silhouette-layer-fill"></div>
              </div>
              <div class="silhouette-layer" data-slot="7">
                <div class="silhouette-layer-fill"></div>
              </div>

              <!-- Human figure overlay -->
              <img src="images/silhouette.png"
                   alt="Patient silhouette"
                   class="silhouette-figure" />
            </div>
            <div class="silhouette-caption" id="silhouetteCaption">
              Scan from <strong>head to toe</strong>. The silhouette lights up
              with each scan. Case 4 uses <strong>6</strong> scans (no blood
              pressure).
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- LIVE VITALS -->
    <section class="panel">
      <div class="panel-inner">
        <div class="panel-header">
          <div>
            <div class="panel-title">LIVE VITALS (FROM DRONE)</div>
            <div class="panel-subtitle">
              Values update after each QR scan.
            </div>
          </div>
        </div>

        <div class="vitals-list" id="vitalsList">
          <!-- rows injected by JS -->
        </div>

        <div class="timer-panel">
          <div>
            <div class="timer-title">PATIENT LOADING • TRIAGE TIMER</div>
            <div style="font-size: 10px; color: var(--text-subtle);">
              Scan all QR tags first. The timer starts when you continue to
              triage.
            </div>
          </div>
          <div class="timer-value" id="timerValue">0.00 s</div>
        </div>

        <div class="coming-soon">
          <strong>AI Paramedic Support Module</strong><br />
          Drone will recommend the exact medical tools paramedics should bring
          from the hospital based on the injuries.
        </div>
      </div>
    </section>

    <!-- HUMAN TRIAGE DECISION -->
    <section class="panel">
      <div class="panel-inner">
        <div class="panel-header">
          <div>
            <div class="panel-title">HUMAN TRIAGE DECISION</div>
            <div class="panel-subtitle">
              Complete triage only after all scans are done. Then submit to
              compare with AI.
            </div>
          </div>
        </div>

        <div class="triage-grid">
          <div class="triage-steps">
            <!-- Step 1 -->
            <div>
              <div class="step-title">STEP 1 — CHOOSE TRIAGE CATEGORY</div>
              <div class="triage-colors" id="triageOptions">
                <button
                  type="button"
                  class="triage-pill"
                  data-triage="Red"
                >
                  <div class="triage-color-dot triage-color-red"></div>
                  <div>
                    <span>RED</span><br />
                    <small>Immediate</small>
                  </div>
                </button>
                <button
                  type="button"
                  class="triage-pill"
                  data-triage="Yellow"
                >
                  <div class="triage-color-dot triage-color-yellow"></div>
                  <div>
                    <span>YELLOW</span><br />
                    <small>Urgent but delayed</small>
                  </div>
                </button>
                <button
                  type="button"
                  class="triage-pill"
                  data-triage="Green"
                >
                  <div class="triage-color-dot triage-color-green"></div>
                  <div>
                    <span>GREEN</span><br />
                    <small>Minimal</small>
                  </div>
                </button>
                <button
                  type="button"
                  class="triage-pill"
                  data-triage="Black"
                >
                  <div class="triage-color-dot triage-color-black"></div>
                  <div>
                    <span>BLACK</span><br />
                    <small>Expectant / deceased</small>
                  </div>
                </button>
              </div>
            </div>

            <!-- Step 2 -->
            <div>
              <div class="step-title">STEP 2 — CHOOSE RECEIVING HOSPITAL</div>
              <div class="hospital-list" id="hospitalList">
                <!-- hospitals injected by JS -->
              </div>
            </div>
          </div>

          <!-- Step 3 + actions -->
          <div>
            <div class="step-title">STEP 3 — CHOOSE ER TESTS</div>
            <div class="er-tests-wrapper">
              <div class="er-tests-chips" id="erTestsChips">
                <!-- chips injected by JS -->
              </div>
              <div class="er-tests-hint">
                Pick the most appropriate initial tests. Some options are
                deliberately wrong to make it challenging.
              </div>
            </div>

            <div class="triage-actions">
              <button
                type="button"
                id="continueToTriageBtn"
                class="btn btn-secondary"
                disabled
              >
                CONTINUE TO TRIAGE
              </button>
              <button
                type="button"
                id="submitDecisionBtn"
                class="btn btn-primary"
                disabled
              >
                SUBMIT DECISION
              </button>
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- RESULTS + LEADERBOARD -->
    <section class="panel">
      <div class="panel-inner">
        <div class="panel-header">
          <div>
            <div class="panel-title">HUMAN VS AI RESULTS</div>
            <div class="panel-subtitle">
              Compare your triage, hospital choice, and tests with the AI
              recommendation.
            </div>
          </div>
        </div>

        <div class="results-grid">
          <div>
            <table class="comparison-table">
              <thead>
              <tr>
                <th>Category</th>
                <th>Human</th>
                <th>AI</th>
                <th>Match</th>
              </tr>
              </thead>
              <tbody>
              <tr>
                <td>Triage</td>
                <td id="humanTriageCell">—</td>
                <td id="aiTriageCell">—</td>
                <td><span id="triageMatchCell" class="match-pill">—</span></td>
              </tr>
              <tr>
                <td>Hospital</td>
                <td id="humanHospitalCell">—</td>
                <td id="aiHospitalCell">—</td>
                <td><span id="hospitalMatchCell" class="match-pill">—</span></td>
              </tr>
              <tr>
                <td>ER tests</td>
                <td id="humanTestsCell">—</td>
                <td id="aiTestsCell">—</td>
                <td><span id="testsMatchCell" class="match-pill">—</span></td>
              </tr>
              <tr>
                <td>Time</td>
                <td id="humanTimeCell">—</td>
                <td id="aiTimeCell">Target &lt; 90 s</td>
                <td><span id="timeMatchCell" class="match-pill">—</span></td>
              </tr>
              </tbody>
            </table>
            <div class="score-line">
              Score: <strong><span id="scoreValue">0</span> / 12</strong> points
            </div>
          </div>

          <div>
            <div class="leaderboard-header">
              <div>Live Leaderboard</div>
              <div class="leaderboard-actions">
                <button
                  type="button"
                  id="resetSimulationBtn"
                  class="btn-ghost"
                >
                  Reset simulation
                </button>
                <button
                  type="button"
                  id="resetBoardBtn"
                  class="btn-ghost"
                >
                  Reset board
                </button>
              </div>
            </div>

            <table class="leaderboard-table" id="leaderboardTable">
              <thead>
              <tr>
                <th>#</th>
                <th>Name</th>
                <th>Mode</th>
                <th>Scenario</th>
                <th>Score</th>
                <th>Time</th>
              </tr>
              </thead>
              <tbody>
              <!-- rows injected by JS -->
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </section>
  </main>
</div>

<script>
  /******************************************************************
   * DATA: Scenarios, vitals, AI answers
   ******************************************************************/
  const scenarios = {
    1: {
      id: 1,
      name: "Scenario 1 — Hajj Stampede (Red)",
      triage: "Red",
      hospital: "Mina Emergency Hospital",
      aiTimeTarget: 90,
      vitals: {
        Consciousness: "Unresponsive, pale, shallow breathing",
        "Respiratory rate (RR)": "34 / min",
        "Heart rate (HR)": "142 bpm",
        "Blood pressure (BP)": "78/45 mmHg",
        "Key injury / problem":
          "Severe bleeding from lower abdomen, suspected pelvic fracture",
      },
      bodySlots: [
        {
          id: "id",
          label: "Eyes / ID",
          desc: "Waiting for scan…",
          counterIndex: 1,
        },
        {
          id: "conclevel",
          label: "Face – Consciousness",
          desc: "Waiting for scan…",
          counterIndex: 2,
        },
        {
          id: "hr",
          label: "Neck – Heart rate",
          desc: "Waiting for scan…",
          counterIndex: 3,
        },
        {
          id: "rr",
          label: "Chest – Respiratory rate",
          desc: "Waiting for scan…",
          counterIndex: 4,
        },
        {
          id: "bp",
          label: "Arms – Blood pressure",
          desc: "Waiting for scan…",
          counterIndex: 5,
        },
        {
          id: "injury1",
          label: "Pelvis / Abdomen – Injury 1",
          desc: "Waiting for scan…",
          counterIndex: 6,
        },
        {
          id: "injury2",
          label: "Legs / Feet – Injury 2",
          desc: "Waiting for scan…",
          counterIndex: 7,
        },
      ],
      erTestsCorrect: [
        "FAST ultrasound",
        "Serum lactate",
        "Blood typing and crossmatch",
      ],
      erTestsWrong: [
        "Urinalysis",
        "CT head (non-contrast)",
        "D-dimer",
        "ECG",
      ],
    },
    2: {
      id: 2,
      name: "Scenario 2 — Industrial Explosion (Yellow)",
      triage: "Yellow",
      hospital: "King Fahad Medical City — Trauma Centre",
      aiTimeTarget: 120,
      vitals: {
        Consciousness: "Alert but disoriented",
        "Respiratory rate (RR)": "26 / min",
        "Heart rate (HR)": "110 bpm",
        "Blood pressure (BP)": "100/70 mmHg",
        "Key injury / problem":
          "Burns on arms and face, chest tightness, dizziness",
      },
      bodySlots: [
        {
          id: "id",
          label: "Eyes / ID",
          desc: "Waiting for scan…",
          counterIndex: 1,
        },
        {
          id: "conclevel",
          label: "Face – Consciousness / pain",
          desc: "Waiting for scan…",
          counterIndex: 2,
        },
        {
          id: "hr",
          label: "Neck – Heart rate",
          desc: "Waiting for scan…",
          counterIndex: 3,
        },
        {
          id: "rr",
          label: "Chest – Respiratory rate",
          desc: "Waiting for scan…",
          counterIndex: 4,
        },
        {
          id: "bp",
          label: "Arms – Burn depth",
          desc: "Waiting for scan…",
          counterIndex: 5,
        },
        {
          id: "injury1",
          label: "Pelvis / Abdomen – Injury 1",
          desc: "Waiting for scan…",
          counterIndex: 6,
        },
        {
          id: "injury2",
          label: "Legs / Feet – Injury 2",
          desc: "Waiting for scan…",
          counterIndex: 7,
        },
      ],
      erTestsCorrect: [
        "Carboxyhemoglobin",
        "Chest X-ray",
        "ECG",
      ],
      erTestsWrong: [
        "FAST ultrasound",
        "Urinalysis",
        "D-dimer",
        "CT head (non-contrast)",
      ],
    },
    3: {
      id: 3,
      name: "Scenario 3 — Desert Rally (Green)",
      triage: "Green",
      hospital: "Dharhan Trauma Center",
      aiTimeTarget: 180,
      vitals: {
        Consciousness: "Alert and walking",
        "Respiratory rate (RR)": "18 / min",
        "Heart rate (HR)": "92 bpm",
        "Blood pressure (BP)": "118/78 mmHg",
        "Key injury / problem":
          "Mild dehydration, fatigue, headache; mild heat stress",
      },
      bodySlots: [
        {
          id: "id",
          label: "Eyes / ID",
          desc: "Waiting for scan…",
          counterIndex: 1,
        },
        {
          id: "conclevel",
          label: "Face – Hydration status",
          desc: "Waiting for scan…",
          counterIndex: 2,
        },
        {
          id: "hr",
          label: "Neck – Heart rate",
          desc: "Waiting for scan…",
          counterIndex: 3,
        },
        {
          id: "rr",
          label: "Chest – Respiratory rate",
          desc: "Waiting for scan…",
          counterIndex: 4,
        },
        {
          id: "bp",
          label: "Arms – Skin turgor",
          desc: "Waiting for scan…",
          counterIndex: 5,
        },
        {
          id: "injury1",
          label: "Pelvis / Abdomen – Injury 1",
          desc: "Waiting for scan…",
          counterIndex: 6,
        },
        {
          id: "injury2",
          label: "Legs / Feet – Injury 2",
          desc: "Waiting for scan…",
          counterIndex: 7,
        },
      ],
      erTestsCorrect: ["Electrolyte panel", "Oral hydration response"],
      erTestsWrong: [
        "FAST ultrasound",
        "Blood typing and crossmatch",
        "CT head (non-contrast)",
        "D-dimer",
      ],
    },
    4: {
      id: 4,
      name: "Scenario 4 — Highway Collision (Black)",
      triage: "Black",
      hospital: "Mina Emergency Hospital",
      aiTimeTarget: 60,
      vitals: {
        Consciousness: "No response, fixed dilated pupils",
        "Respiratory rate (RR)": "0 / min",
        "Heart rate (HR)": "0 bpm",
        "Blood pressure (BP)": "0/0 mmHg",
        "Key injury / problem":
          "Massive head and chest trauma; no signs of life",
      },
      // only 6 scans: no BP
      bodySlots: [
        {
          id: "id",
          label: "Eyes / ID",
          desc: "Waiting for scan…",
          counterIndex: 1,
        },
        {
          id: "conclevel",
          label: "Face – Consciousness",
          desc: "Waiting for scan…",
          counterIndex: 2,
        },
        {
          id: "hr",
          label: "Neck – Heart rate",
          desc: "Waiting for scan…",
          counterIndex: 3,
        },
        {
          id: "rr",
          label: "Chest – Respiratory effort",
          desc: "Waiting for scan…",
          counterIndex: 4,
        },
        {
          id: "injury1",
          label: "Pelvis / Abdomen – Injury 1",
          desc: "Waiting for scan…",
          counterIndex: 5,
        },
        {
          id: "injury2",
          label: "Legs / Feet – Injury 2",
          desc: "Waiting for scan…",
          counterIndex: 6,
        },
      ],
      erTestsCorrect: [],
      erTestsWrong: [
        "FAST ultrasound",
        "Serum lactate",
        "CT head (non-contrast)",
        "Urinalysis",
      ],
    },
  };

  const hospitals = [
    {
      name: "Mina Emergency Hospital",
      desc: "Closest high-emergency facility",
    },
    {
      name: "King Fahad Medical City — Trauma Centre",
      desc: "Level 1 trauma centre, Riyadh",
    },
    {
      name: "Dharhan Trauma Center",
      desc: "Highway critical care hub",
    },
  ];

  const allErTests = [
    "FAST ultrasound",
    "Serum lactate",
    "Blood typing and crossmatch",
    "CT head (non-contrast)",
    "D-dimer",
    "Urinalysis",
    "Carboxyhemoglobin",
    "Chest X-ray",
    "ECG",
    "Electrolyte panel",
    "Oral hydration response",
  ];

  /******************************************************************
   * STATE
   ******************************************************************/
  let currentScenarioId = 1;
  let scannedSlots = new Set();
  let timerStarted = false;
  let timerStartTs = null;
  let timerInterval = null;

  let chosenTriage = null;
  let chosenHospital = null;
  let chosenTests = new Set();

  const leaderboardKey = "triage_game_leaderboard_v1";

  /******************************************************************
   * ELEMENTS
   ******************************************************************/
  const scenarioSelectEl = document.getElementById("scenarioSelect");
  const bodySlotListEl = document.getElementById("bodySlotList");
  const scanOrderHintEl = document.getElementById("scanOrderHint");
  const vitalsListEl = document.getElementById("vitalsList");
  const timerValueEl = document.getElementById("timerValue");
  const silhouetteCaptionEl = document.getElementById("silhouetteCaption");
  const silhouetteLayers = Array.from(
    document.querySelectorAll(".silhouette-layer")
  );

  const triageOptionsEl = document.getElementById("triageOptions");
  const hospitalListEl = document.getElementById("hospitalList");
  const erTestsChipsEl = document.getElementById("erTestsChips");

  const continueBtn = document.getElementById("continueToTriageBtn");
  const submitBtn = document.getElementById("submitDecisionBtn");
  const resetSimBtn = document.getElementById("resetSimulationBtn");
  const resetBoardBtn = document.getElementById("resetBoardBtn");

  // results cells
  const humanTriageCell = document.getElementById("humanTriageCell");
  const aiTriageCell = document.getElementById("aiTriageCell");
  const triageMatchCell = document.getElementById("triageMatchCell");

  const humanHospitalCell = document.getElementById("humanHospitalCell");
  const aiHospitalCell = document.getElementById("aiHospitalCell");
  const hospitalMatchCell = document.getElementById("hospitalMatchCell");

  const humanTestsCell = document.getElementById("humanTestsCell");
  const aiTestsCell = document.getElementById("aiTestsCell");
  const testsMatchCell = document.getElementById("testsMatchCell");

  const humanTimeCell = document.getElementById("humanTimeCell");
  const aiTimeCell = document.getElementById("aiTimeCell");
  const timeMatchCell = document.getElementById("timeMatchCell");
  const scoreValueEl = document.getElementById("scoreValue");

  const leaderboardTableBody = document.querySelector(
    "#leaderboardTable tbody"
  );

  /******************************************************************
   * INITIALISATION
   ******************************************************************/
  function renderBodySlots() {
    const scenario = scenarios[currentScenarioId];
    bodySlotListEl.innerHTML = "";
    scannedSlots = new Set();

    scenario.bodySlots.forEach((slot, index) => {
      const row = document.createElement("div");
      row.className = "body-slot";
      row.dataset.slotId = slot.id;

      const label = document.createElement("div");
      label.className = "body-slot-label";

      const title = document.createElement("div");
      title.className = "body-slot-title";
      title.textContent = slot.label;
      label.appendChild(title);

      const status = document.createElement("div");
      status.className = "body-slot-status";
      status.textContent = slot.desc;
      label.appendChild(status);

      row.appendChild(label);

      const tag = document.createElement("div");
      tag.className = "body-slot-tag";
      tag.textContent = `${slot.counterIndex} / ${
        currentScenarioId === 4 ? 6 : 7
      }`;
      row.appendChild(tag);

      bodySlotListEl.appendChild(row);
    });

    // update silhouette labels for scenario 4 (6 layers only)
    const maxLayers = currentScenarioId === 4 ? 6 : 7;
    silhouetteLayers.forEach((layer, i) => {
      if (i < maxLayers) {
        layer.style.display = "block";
      } else {
        layer.style.display = "none";
      }
      layer.classList.remove("active");
    });

    const text =
      currentScenarioId === 4
        ? "Scan from head to toe. Case 4 uses only 6 scans (no blood pressure). The silhouette lights up with each scan."
        : "Scan from head to toe. The silhouette lights up with each scan. Make sure all 7 regions are scanned before triage.";
    silhouetteCaptionEl.textContent = text;

    const orderText =
      currentScenarioId === 4
        ? "Scan order: 1. Eyes / ID → 2. Face / consciousness → 3. Neck / heart rate → 4. Chest / respiratory effort → 5. Pelvis / abdomen → 6. Legs / feet."
        : "Scan order: 1. Eyes / ID → 2. Face / consciousness → 3. Neck / heart rate → 4. Chest / respiratory rate → 5. Arms / blood pressure → 6. Pelvis / abdomen → 7. Legs / feet.";
    scanOrderHintEl.textContent = orderText;
  }

  function renderVitals() {
    const scenario = scenarios[currentScenarioId];
    vitalsListEl.innerHTML = "";
    Object.entries(scenario.vitals).forEach(([label, value]) => {
      const row = document.createElement("div");
      row.className = "vitals-row";

      const l = document.createElement("div");
      l.className = "vitals-label";
      l.textContent = label;

      const v = document.createElement("div");
      v.className = "vitals-value";
      v.textContent = value;

      row.appendChild(l);
      row.appendChild(v);
      vitalsListEl.appendChild(row);
    });

    aiTriageCell.textContent = scenario.triage;
    aiHospitalCell.textContent = scenario.hospital;
    aiTestsCell.textContent = scenario.erTestsCorrect.join(", ") || "None";
    aiTimeCell.textContent = `Target < ${scenario.aiTimeTarget} s`;
  }

  function renderHospitals() {
    hospitalListEl.innerHTML = "";
    hospitals.forEach((h) => {
      const item = document.createElement("div");
      item.className = "hospital-item";
      item.dataset.hospitalName = h.name;

      const name = document.createElement("div");
      name.className = "hospital-name";
      name.textContent = h.name;

      const desc = document.createElement("div");
      desc.className = "hospital-desc";
      desc.textContent = h.desc;

      item.appendChild(name);
      item.appendChild(desc);

      item.addEventListener("click", () => {
        chosenHospital = h.name;
        document
          .querySelectorAll(".hospital-item")
          .forEach((el) => el.classList.remove("active"));
        item.classList.add("active");
        updateSubmitState();
      });

      hospitalListEl.appendChild(item);
    });
  }

  function renderErTests() {
    const scenario = scenarios[currentScenarioId];
    erTestsChipsEl.innerHTML = "";
    chosenTests = new Set();

    const testsForScenario = new Set([
      ...scenario.erTestsCorrect,
      ...scenario.erTestsWrong,
    ]);

    // Keep ordering consistent based on global list
    allErTests.forEach((test) => {
      if (!testsForScenario.has(test)) return;
      const chip = document.createElement("button");
      chip.type = "button";
      chip.className = "chip";
      chip.textContent = test;
      chip.dataset.testName = test;

      chip.addEventListener("click", () => {
        if (chosenTests.has(test)) {
          chosenTests.delete(test);
          chip.classList.remove("active");
        } else {
          chosenTests.add(test);
          chip.classList.add("active");
        }
        updateSubmitState();
      });

      erTestsChipsEl.appendChild(chip);
    });
  }

  function renderTriagedState() {
    document
      .querySelectorAll(".triage-pill")
      .forEach((pill) => pill.classList.remove("active"));
    if (!chosenTriage) return;
    const active = document.querySelector(
      `.triage-pill[data-triage="${chosenTriage}"]`
    );
    if (active) active.classList.add("active");
  }

  function resetTimer() {
    timerStarted = false;
    timerStartTs = null;
    if (timerInterval) clearInterval(timerInterval);
    timerValueEl.textContent = "0.00 s";
  }

  function resetDecisionOnly() {
    chosenTriage = null;
    chosenHospital = null;
    chosenTests = new Set();
    renderTriagedState();
    document
      .querySelectorAll(".hospital-item")
      .forEach((el) => el.classList.remove("active"));
    document
      .querySelectorAll(".chip")
      .forEach((el) => el.classList.remove("active"));

    humanTriageCell.textContent = "—";
    humanHospitalCell.textContent = "—";
    humanTestsCell.textContent = "—";
    humanTimeCell.textContent = "—";
    [triageMatchCell, hospitalMatchCell, testsMatchCell, timeMatchCell].forEach(
      (el) => {
        el.textContent = "—";
        el.classList.remove("ok", "bad");
      }
    );
    scoreValueEl.textContent = "0";
    continueBtn.disabled = true;
    submitBtn.disabled = true;
    resetTimer();
  }

  function resetSimulation() {
    resetDecisionOnly();
    renderBodySlots();
    silhouetteLayers.forEach((layer) => layer.classList.remove("active"));
  }

  function initScenario() {
    resetSimulation();
    renderVitals();
    renderHospitals();
    renderErTests();
    renderTriagedState();
  }

  /******************************************************************
   * TIMER
   ******************************************************************/
  function startTimerIfNeeded() {
    if (timerStarted) return;
    timerStarted = true;
    timerStartTs = performance.now();
    timerInterval = setInterval(() => {
      const elapsed = (performance.now() - timerStartTs) / 1000;
      timerValueEl.textContent = `${elapsed.toFixed(2)} s`;
    }, 80);
  }

  function stopTimer() {
    if (!timerStarted) return 0;
    const elapsed = (performance.now() - timerStartTs) / 1000;
    clearInterval(timerInterval);
    timerInterval = null;
    return elapsed;
  }

  /******************************************************************
   * SUBMIT + SCORING
   ******************************************************************/
  function updateSubmitState() {
    const scenario = scenarios[currentScenarioId];
    const requiredScans = scenario.bodySlots.length;
    const allScanned = scannedSlots.size >= requiredScans;

    continueBtn.disabled = !allScanned;
    const hasChoices =
      chosenTriage && chosenHospital && chosenTests.size > 0 && allScanned;
    submitBtn.disabled = !hasChoices;
  }

  continueBtn.addEventListener("click", () => {
    startTimerIfNeeded();
    continueBtn.disabled = true;
  });

  submitBtn.addEventListener("click", () => {
    const scenario = scenarios[currentScenarioId];

    const elapsed = stopTimer();
    const elapsedDisplay = `${elapsed.toFixed(2)} s`;
    humanTimeCell.textContent = elapsedDisplay;

    humanTriageCell.textContent = chosenTriage || "—";
    humanHospitalCell.textContent = chosenHospital || "—";
    humanTestsCell.textContent = Array.from(chosenTests).join(", ") || "—";

    // scoring
    let score = 0;

    if (chosenTriage === scenario.triage) {
      triageMatchCell.textContent = "Match";
      triageMatchCell.classList.add("ok");
      score += 3;
    } else {
      triageMatchCell.textContent = "Different";
      triageMatchCell.classList.add("bad");
    }

    if (chosenHospital === scenario.hospital) {
      hospitalMatchCell.textContent = "Match";
      hospitalMatchCell.classList.add("ok");
      score += 3;
    } else {
      hospitalMatchCell.textContent = "Different";
      hospitalMatchCell.classList.add("bad");
    }

    const correctTests = new Set(scenario.erTestsCorrect);
    const humanTests = Array.from(chosenTests);
    const allCorrectChosen =
      humanTests.length > 0 &&
      humanTests.every((t) => correctTests.has(t)) &&
      correctTests.size === humanTests.length;

    if (allCorrectChosen) {
      testsMatchCell.textContent = "Appropriate";
      testsMatchCell.classList.add("ok");
      score += 3;
    } else {
      testsMatchCell.textContent = "Sub-optimal";
      testsMatchCell.classList.add("bad");
    }

    if (elapsed <= scenario.aiTimeTarget) {
      timeMatchCell.textContent = "Within target";
      timeMatchCell.classList.add("ok");
      score += 3;
    } else {
      timeMatchCell.textContent = "Slower";
      timeMatchCell.classList.add("bad");
    }

    scoreValueEl.textContent = score.toString();

    addLeaderboardEntry({
      name: "You",
      mode: "Solo",
      scenario: scenario.name,
      score,
      time: elapsedDisplay,
    });

    // prevent resubmitting duplicate results
    submitBtn.disabled = true;
  });

  /******************************************************************
   * LEADERBOARD (localStorage)
   ******************************************************************/
  function loadLeaderboard() {
    try {
      const raw = localStorage.getItem(leaderboardKey);
      if (!raw) return [];
      const parsed = JSON.parse(raw);
      if (!Array.isArray(parsed)) return [];
      return parsed;
    } catch (e) {
      console.warn("Failed to load leaderboard", e);
      return [];
    }
  }

  function saveLeaderboard(entries) {
    try {
      localStorage.setItem(leaderboardKey, JSON.stringify(entries));
    } catch (e) {
      console.warn("Failed to save leaderboard", e);
    }
  }

  function renderLeaderboard() {
    const entries = loadLeaderboard();
    leaderboardTableBody.innerHTML = "";
    entries.forEach((entry, idx) => {
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${idx + 1}</td>
        <td>${entry.name}</td>
        <td>${entry.mode}</td>
        <td>${entry.scenario}</td>
        <td>${entry.score}</td>
        <td>${entry.time}</td>
      `;
      leaderboardTableBody.appendChild(tr);
    });
  }

  function addLeaderboardEntry(entry) {
    const entries = loadLeaderboard();
    entries.push(entry);
    entries.sort((a, b) => b.score - a.score || a.time.localeCompare(b.time));
    saveLeaderboard(entries);
    renderLeaderboard();
  }

  resetSimBtn.addEventListener("click", () => {
    resetSimulation();
  });

  resetBoardBtn.addEventListener("click", () => {
    saveLeaderboard([]);
    renderLeaderboard();
  });

  /******************************************************************
   * TRIAGE COLOR EVENTS
   ******************************************************************/
  triageOptionsEl.addEventListener("click", (e) => {
    const pill = e.target.closest(".triage-pill");
    if (!pill) return;
    chosenTriage = pill.dataset.triage;
    renderTriagedState();
    updateSubmitState();
  });

  /******************************************************************
   * SCENARIO CHANGE
   ******************************************************************/
  scenarioSelectEl.addEventListener("change", () => {
    currentScenarioId = parseInt(scenarioSelectEl.value, 10);
    initScenario();
  });

  /******************************************************************
   * QR SCAN CHANNEL (desktop listens to mobile.html)
   *
   * The mobile page should send messages like:
   * { type: 'scan', scenarioId: 1, slotId: 'bp' }
   *
   * This keeps compatibility with your existing QR setup.
   ******************************************************************/
  function handleScanMessage(data) {
    const scenario = scenarios[currentScenarioId];
    if (!scenario) return;
    if (data.scenarioId && data.scenarioId !== currentScenarioId) {
      // ignore scans from other scenarios
      return;
    }

    const slotIndex = scenario.bodySlots.findIndex(
      (slot) => slot.id === data.slotId
    );
    if (slotIndex === -1) return;

    const slot = scenario.bodySlots[slotIndex];
    scannedSlots.add(slot.id);

    // update body list
    const slotRow = bodySlotListEl.querySelector(
      `.body-slot[data-slot-id="${slot.id}"]`
    );
    if (slotRow) {
      slotRow.classList.add("scanned");
      const statusEl = slotRow.querySelector(".body-slot-status");
      if (statusEl) statusEl.textContent = "Scan received";
    }

    // update silhouette animation
    // slotIndex maps to layer index
    const maxLayers = scenario.bodySlots.length;
    const layer = silhouetteLayers[slotIndex];
    if (layer && slotIndex < maxLayers) {
      layer.classList.add("active");
    }

    updateSubmitState();
  }

  // BroadcastChannel (modern browsers)
  try {
    const channel = new BroadcastChannel("triage-drone-channel");
    channel.addEventListener("message", (event) => {
      const data = event.data || {};
      if (data.type === "scan") {
        handleScanMessage(data);
      }
    });
  } catch (e) {
    // Fallback: polling localStorage key "triage_last_scan"
    window.addEventListener("storage", (event) => {
      if (event.key !== "triage_last_scan") return;
      try {
        const data = JSON.parse(event.newValue);
        if (data && data.type === "scan") {
          handleScanMessage(data);
        }
      } catch (err) {
        console.warn("Bad scan payload", err);
      }
    });
  }

  /******************************************************************
   * START
   ******************************************************************/
  initScenario();
  renderLeaderboard();
</script>
</body>
</html>
