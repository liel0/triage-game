<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>AI Triage Drone 2040 ‚Äì Main Screen</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    :root {
      --bg: #020617;
      --card: #020617;
      --border: #1f2937;
      --accent: #22c55e;
      --accent2: #06b6d4;
      --accent3: #f97316;
      --text: #e5e7eb;
      --muted: #9ca3af;
      --danger: #f97373;
    }

    * { box-sizing: border-box; margin: 0; padding: 0; }

    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: radial-gradient(circle at top, #111827 0, #020617 45%, #000 100%);
      color: var(--text);
      height: 100vh;
      overflow: hidden;
      display: flex;
      flex-direction: column;
    }

    .main-layout {
      display: grid;
      grid-template-rows: auto 1fr auto auto;
      grid-template-columns: 1.3fr 1fr;
      gap: 16px;
      padding: 16px 24px;
      height: 100%;
    }

    .main-layout > * {
      background: rgba(15, 23, 42, 0.96);
      border-radius: 24px;
      border: 1px solid rgba(148, 163, 184, 0.35);
      box-shadow: 0 20px 60px rgba(15, 23, 42, 0.95);
    }

    .title-card {
      grid-column: 1 / span 2;
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 10px 18px;
    }

    .title-card h1 {
      font-size: 22px;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .title-card h1 span {
      font-size: 28px;
    }

    .subtitle {
      font-size: 12px;
      color: var(--muted);
    }

    .operator-label {
      font-size: 13px;
      text-align: right;
    }

    .operator-label span {
      color: var(--accent);
      font-weight: 600;
    }

    .body-card {
      grid-row: 2 / span 1;
      grid-column: 1 / span 1;
      padding: 12px 16px;
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }

    .vitals-card {
      grid-row: 2 / span 2;
      grid-column: 2 / span 1;
      padding: 12px 18px;
      display: flex;
      flex-direction: column;
      justify-content: space-between;
    }

    .triage-card {
      grid-row: 3 / span 1;
      grid-column: 1 / span 1;
      padding: 12px 18px;
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .results-card {
      grid-row: 4 / span 1;
      grid-column: 1 / span 2;
      padding: 12px 18px;
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .card-title-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 8px;
    }

    .card-title-row h2 {
      font-size: 16px;
      letter-spacing: 0.04em;
    }

    .scenario-select {
      padding: 6px 12px;
      border-radius: 999px;
      border: 1px solid rgba(148, 163, 184, 0.5);
      background: #020617;
      color: var(--text);
      font-size: 13px;
      min-width: 260px;
    }

    .body-grid {
      display: grid;
      grid-template-columns: 1fr;
      gap: 6px;
      overflow-y: auto;
    }

    .body-row {
      display: grid;
      grid-template-columns: 90px minmax(0, 1fr);
      align-items: center;
      gap: 10px;
      padding: 4px 0;
    }

    .body-label {
      font-size: 13px;
      color: var(--muted);
    }

    .image-box {
      position: relative;
      background: #020617;
      border-radius: 18px;
      border: 1px solid rgba(148, 163, 184, 0.6);
      height: 140px;
      overflow: hidden;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .image-box img {
      max-width: 100%;
      max-height: 100%;
      object-fit: contain;
      display: block;
    }

    .image-placeholder {
      font-size: 12px;
      color: var(--muted);
    }

    .hint-pill {
      position: absolute;
      bottom: 6px;
      left: 10px;
      font-size: 11px;
      color: var(--muted);
      background: rgba(15, 23, 42, 0.9);
      padding: 2px 8px;
      border-radius: 999px;
    }

    .vital-pair {
      display: flex;
      justify-content: space-between;
      align-items: baseline;
      margin-bottom: 3px;
      font-size: 14px;
    }

    .vital-label {
      color: var(--muted);
      font-size: 13px;
    }

    .vital-value {
      font-weight: 600;
    }

    .timer-block {
      margin-top: 12px;
      padding-top: 8px;
      border-top: 1px solid rgba(55, 65, 81, 0.8);
    }

    .timer-label {
      font-size: 12px;
      color: var(--muted);
      margin-bottom: 2px;
    }

    .timer-value {
      font-size: 24px;
      font-weight: 700;
    }

    .timer-note {
      font-size: 12px;
      color: var(--muted);
      margin-top: 4px;
    }

    .triage-buttons {
      display: flex;
      gap: 18px;
      align-items: center;
    }

    .triage-circle {
      width: 46px;
      height: 46px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 11px;
      font-weight: 700;
      cursor: pointer;
      border: 3px solid transparent;
      text-align: center;
    }

    .triage-red { background: #ef4444; }
    .triage-yellow { background: #eab308; color: #111827; }
    .triage-green { background: #22c55e; }
    .triage-black { background: #111827; border-color: #4b5563; }

    .triage-circle.active {
      box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.7);
    }

    .triage-label {
      font-size: 12px;
      color: var(--muted);
      margin-top: 4px;
      text-align: center;
    }

    .hospital-tests {
      display: grid;
      grid-template-columns: 1.4fr 1.4fr;
      gap: 10px;
      font-size: 12px;
    }

    .hospital-card {
      border-radius: 18px;
      border: 1px solid rgba(148, 163, 184, 0.5);
      padding: 8px 10px;
      background: #020617;
    }

    .hospital-title {
      font-weight: 600;
      font-size: 13px;
      margin-bottom: 2px;
    }

    .hospital-sub {
      color: var(--muted);
      margin-bottom: 6px;
      font-size: 11px;
    }

    .hospital-option {
      margin-bottom: 4px;
    }

    .submit-btn {
      margin-top: 6px;
      align-self: flex-start;
      padding: 7px 18px;
      border-radius: 999px;
      border: none;
      font-size: 13px;
      font-weight: 600;
      cursor: pointer;
      background: linear-gradient(135deg, #22c55e, #06b6d4);
      color: white;
      box-shadow: 0 10px 25px rgba(6, 182, 212, 0.6);
    }

    .submit-btn:disabled {
      opacity: 0.5;
      cursor: default;
      box-shadow: none;
    }

    .results-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 12px;
    }

    .results-table th,
    .results-table td {
      padding: 4px 6px;
      border-bottom: 1px solid rgba(31, 41, 55, 0.9);
      text-align: left;
    }

    .results-table th {
      color: var(--muted);
      font-weight: 500;
    }

    .results-table td.match {
      text-align: center;
      width: 60px;
    }

    .score-line {
      font-size: 13px;
      margin-top: 4px;
    }

    .leaderboard {
      margin-top: 6px;
      font-size: 12px;
    }

    .leaderboard table {
      width: 100%;
      border-collapse: collapse;
    }

    .leaderboard th,
    .leaderboard td {
      padding: 3px 6px;
      border-bottom: 1px solid rgba(31, 41, 55, 0.9);
      text-align: left;
    }

    .leaderboard th {
      color: var(--muted);
      font-weight: 500;
    }
  </style>
</head>
<body>
<div class="main-layout">
  <div class="title-card">
    <div>
      <h1><span>üöÅ</span>AI Triage Drone 2040</h1>
      <div class="subtitle">Mass-casualty triage simulator ‚Äì drone + human collaboration.</div>
    </div>
    <div class="operator-label" id="operatorDisplay">
      Operator: <span>Waiting for phone‚Ä¶</span>
    </div>
  </div>

  <!-- Left: patient body map -->
  <div class="body-card">
    <div class="card-title-row">
      <h2>Patient Body Map & Drone Feed</h2>
      <select id="scenarioSelect" class="scenario-select">
        <option value="s1">Scenario 1 ‚Äî Hajj Stampede</option>
        <option value="s2">Scenario 2 ‚Äî Industrial Explosion</option>
        <option value="s3">Scenario 3 ‚Äî Desert Rally</option>
        <option value="s4">Scenario 4 ‚Äî Highway Collision</option>
      </select>
    </div>

    <div class="body-grid">
      <div class="body-row">
        <div class="body-label">Head</div>
        <div class="image-box" data-part="head">
          <span class="image-placeholder">Scan tag for head</span>
          <img style="display:none;" />
          <div class="hint-pill">Facial analysis ‚Äì consciousness & pallor</div>
        </div>
      </div>
      <div class="body-row">
        <div class="body-label">Chest</div>
        <div class="image-box" data-part="chest">
          <span class="image-placeholder">Scan tag for chest</span>
          <img style="display:none;" />
          <div class="hint-pill">Respiratory module ‚Äì RR</div>
        </div>
      </div>
      <div class="body-row">
        <div class="body-label">Abdomen</div>
        <div class="image-box" data-part="abdomen">
          <span class="image-placeholder">Scan tag for abdomen</span>
          <img style="display:none;" />
          <div class="hint-pill">FAST ultrasound ‚Äì bleeding</div>
        </div>
      </div>
      <div class="body-row">
        <div class="body-label">Arms</div>
        <div class="image-box" data-part="arms">
          <span class="image-placeholder">Scan tag for arms</span>
          <img style="display:none;" />
          <div class="hint-pill">Circulatory sensors ‚Äì BP</div>
        </div>
      </div>
      <div class="body-row">
        <div class="body-label">Legs / ID</div>
        <div class="image-box" data-part="legs">
          <span class="image-placeholder">Scan tag for legs / ID</span>
          <img style="display:none;" />
          <div class="hint-pill">Injury map ‚Äì key trauma / history</div>
        </div>
      </div>
    </div>
  </div>

  <!-- Right: vitals -->
  <div class="vitals-card">
    <div>
      <div class="card-title-row">
        <h2>Live Vitals (from drone)</h2>
      </div>

      <div id="vitalsList">
        <div class="vital-pair">
          <div class="vital-label">Consciousness</div>
          <div class="vital-value" id="vital-consciousness">‚Äî</div>
        </div>
        <div class="vital-pair">
          <div class="vital-label">Respiratory rate (RR)</div>
          <div class="vital-value" id="vital-respRate">‚Äî</div>
        </div>
        <div class="vital-pair">
          <div class="vital-label">Heart rate (HR)</div>
          <div class="vital-value" id="vital-heartRate">‚Äî</div>
        </div>
        <div class="vital-pair">
          <div class="vital-label">Blood pressure (BP)</div>
          <div class="vital-value" id="vital-bloodPressure">‚Äî</div>
        </div>
        <div class="vital-pair">
          <div class="vital-label">Key injury / problem</div>
          <div class="vital-value" id="vital-injury">‚Äî</div>
        </div>
      </div>

      <div class="timer-block">
        <div class="timer-label">TRIAGE TIMER</div>
        <div class="timer-value" id="timerText">0.00 s</div>
        <div class="timer-note" id="timerNote">
          Scan any patient tag to begin.
        </div>
      </div>
    </div>
  </div>

  <!-- Human triage + hospital/tests -->
  <div class="triage-card">
    <div class="card-title-row">
      <h2>Human Triage Decision</h2>
    </div>

    <div class="triage-buttons">
      <div>
        <div class="triage-circle triage-red" data-triage="Red">RED</div>
        <div class="triage-label">Immediate</div>
      </div>
      <div>
        <div class="triage-circle triage-yellow" data-triage="Yellow">YELLOW</div>
        <div class="triage-label">Urgent</div>
      </div>
      <div>
        <div class="triage-circle triage-green" data-triage="Green">GREEN</div>
        <div class="triage-label">Minimal</div>
      </div>
      <div>
        <div class="triage-circle triage-black" data-triage="Black">BLACK</div>
        <div class="triage-label">Expectant</div>
      </div>
    </div>

    <div class="hospital-tests">
      <div class="hospital-card">
        <div class="hospital-title">Receiving hospital</div>
        <div class="hospital-sub" id="hospitalHint">Choose the most appropriate facility.</div>
        <div id="hospitalOptions"></div>
      </div>

      <div class="hospital-card">
        <div class="hospital-title">Emergency department tests</div>
        <div class="hospital-sub">Select all tests you would order on arrival.</div>
        <div id="testOptions"></div>
      </div>
    </div>

    <button class="submit-btn" id="submitDecisionBtn" disabled>
      Submit Decision
    </button>
  </div>

  <!-- Results & leaderboard -->
  <div class="results-card">
    <div class="card-title-row">
      <h2>Human vs AI Results</h2>
    </div>

    <table class="results-table">
      <thead>
      <tr>
        <th>Category</th>
        <th>Human</th>
        <th>AI</th>
        <th class="match">Match</th>
      </tr>
      </thead>
      <tbody>
      <tr>
        <td>Triage</td>
        <td id="res-human-triage">‚Äî</td>
        <td id="res-ai-triage">‚Äî</td>
        <td class="match" id="res-match-triage">‚Äî</td>
      </tr>
      <tr>
        <td>Hospital</td>
        <td id="res-human-hospital">‚Äî</td>
        <td id="res-ai-hospital">‚Äî</td>
        <td class="match" id="res-match-hospital">‚Äî</td>
      </tr>
      <tr>
        <td>ER tests</td>
        <td id="res-human-tests">‚Äî</td>
        <td id="res-ai-tests">‚Äî</td>
        <td class="match" id="res-match-tests">‚Äî</td>
      </tr>
      <tr>
        <td>Time</td>
        <td id="res-human-time">‚Äî</td>
        <td id="res-ai-time">‚Äî</td>
        <td class="match" id="res-match-time">‚Äî</td>
      </tr>
      </tbody>
    </table>

    <div class="score-line" id="scoreLine">Score: ‚Äî / 12 points</div>

    <div class="leaderboard">
      <div style="margin-bottom:2px; font-weight:600;">Leaderboard</div>
      <table>
        <thead>
        <tr>
          <th>#</th>
          <th>Name / team</th>
          <th>Scenario</th>
          <th>Score</th>
          <th>Time</th>
        </tr>
        </thead>
        <tbody id="leaderboardBody"></tbody>
      </table>
    </div>
  </div>
</div>

<script src="/socket.io/socket.io.js"></script>
<script>
  const socket = io();

  const scenarioSelect = document.getElementById("scenarioSelect");
  const bodyImageBoxes = document.querySelectorAll(".image-box");
  const timerText = document.getElementById("timerText");
  const timerNote = document.getElementById("timerNote");
  const operatorDisplay = document.getElementById("operatorDisplay").querySelector("span");

  const vitalEls = {
    consciousness: document.getElementById("vital-consciousness"),
    respRate: document.getElementById("vital-respRate"),
    heartRate: document.getElementById("vital-heartRate"),
    bloodPressure: document.getElementById("vital-bloodPressure"),
    injury: document.getElementById("vital-injury"),
  };

  const triageCircles = document.querySelectorAll(".triage-circle");
  const submitDecisionBtn = document.getElementById("submitDecisionBtn");

  const resHumanTriage = document.getElementById("res-human-triage");
  const resAiTriage = document.getElementById("res-ai-triage");
  const resMatchTriage = document.getElementById("res-match-triage");

  const resHumanHospital = document.getElementById("res-human-hospital");
  const resAiHospital = document.getElementById("res-ai-hospital");
  const resMatchHospital = document.getElementById("res-match-hospital");

  const resHumanTests = document.getElementById("res-human-tests");
  const resAiTests = document.getElementById("res-ai-tests");
  const resMatchTests = document.getElementById("res-match-tests");

  const resHumanTime = document.getElementById("res-human-time");
  const resAiTime = document.getElementById("res-ai-time");
  const resMatchTime = document.getElementById("res-match-time");

  const scoreLine = document.getElementById("scoreLine");
  const leaderboardBody = document.getElementById("leaderboardBody");
  const hospitalOptionsDiv = document.getElementById("hospitalOptions");
  const testOptionsDiv = document.getElementById("testOptions");

  const partToVitalKey = {
    head: "consciousness",
    chest: "respRate",
    abdomen: "heartRate",
    arms: "bloodPressure",
    legs: "injury",
  };

  const scenarios = {
    s1: {
      name: "Scenario 1 ‚Äî Hajj Stampede",
      aiTriage: "Red",
      aiHospital: "Mina Emergency Hospital ‚Äî Hajj Priority Centre",
      aiTests: ["FAST ultrasound", "Serum lactate", "Blood typing and crossmatch"],
      aiTimeSec: 1.2,
      vitals: {
        consciousness: "Unconscious",
        respRate: "34 / min",
        heartRate: "142 bpm",
        bloodPressure: "78/45 mmHg",
        injury: "Severe abdominal bleeding & suspected pelvic fracture",
      },
      hospitals: [
        "Mina Emergency Hospital ‚Äî Hajj Priority Centre",
        "King Fahad Medical City ‚Äî Level 1 Trauma Centre",
        "Dhahran Trauma Center ‚Äî Highway Critical Care",
        "AlUla Field Medical Base ‚Äî Desert Response",
      ],
      tests: [
        "FAST ultrasound",
        "Carboxyhaemoglobin level (CO)",
        "Plain X-ray",
        "MRI scan",
        "CT scan",
        "Intravenous (IV) fluids",
        "Blood typing and crossmatch",
        "Serum lactate",
        "Burn depth assessment",
      ],
    },
    s2: {
      name: "Scenario 2 ‚Äî Industrial Explosion",
      aiTriage: "Yellow",
      aiHospital: "King Fahad Medical City ‚Äî Level 1 Trauma Centre",
      aiTests: ["Plain X-ray", "Carboxyhaemoglobin level (CO)", "Burn depth assessment"],
      aiTimeSec: 1.4,
      vitals: {
        consciousness: "Alert, confused",
        respRate: "26 / min",
        heartRate: "110 bpm",
        bloodPressure: "100/70 mmHg",
        injury: "Burns, chest tightness & dizziness",
      },
      hospitals: [
        "King Fahad Medical City ‚Äî Level 1 Trauma Centre",
        "Mina Emergency Hospital ‚Äî Hajj Priority Centre",
        "Dhahran Trauma Center ‚Äî Highway Critical Care",
        "AlUla Field Medical Base ‚Äî Desert Response",
      ],
      tests: [
        "FAST ultrasound",
        "Carboxyhaemoglobin level (CO)",
        "Plain X-ray",
        "MRI scan",
        "CT scan",
        "Intravenous (IV) fluids",
        "Blood typing and crossmatch",
        "Serum lactate",
        "Burn depth assessment",
      ],
    },
    s3: {
      name: "Scenario 3 ‚Äî Desert Rally",
      aiTriage: "Green",
      aiHospital: "AlUla Field Medical Base ‚Äî Desert Response",
      aiTests: ["Intravenous (IV) fluids", "Plain X-ray", "FAST ultrasound"],
      aiTimeSec: 1.3,
      vitals: {
        consciousness: "Walking, talking",
        respRate: "18 / min",
        heartRate: "92 bpm",
        bloodPressure: "118/78 mmHg",
        injury: "Mild dehydration & heat stress",
      },
      hospitals: [
        "AlUla Field Medical Base ‚Äî Desert Response",
        "Mina Emergency Hospital ‚Äî Hajj Priority Centre",
        "King Fahad Medical City ‚Äî Level 1 Trauma Centre",
        "Dhahran Trauma Center ‚Äî Highway Critical Care",
      ],
      tests: [
        "FAST ultrasound",
        "Carboxyhaemoglobin level (CO)",
        "Plain X-ray",
        "MRI scan",
        "CT scan",
        "Intravenous (IV) fluids",
        "Blood typing and crossmatch",
        "Serum lactate",
        "Burn depth assessment",
      ],
    },
    s4: {
      name: "Scenario 4 ‚Äî Highway Collision",
      aiTriage: "Black",
      aiHospital: "Dhahran Trauma Center ‚Äî Highway Critical Care",
      aiTests: ["CT scan", "FAST ultrasound", "Blood typing and crossmatch"],
      aiTimeSec: 1.2,
      vitals: {
        consciousness: "No response",
        respRate: "0 / min",
        heartRate: "0 bpm",
        bloodPressure: "Undetectable",
        injury: "Massive polytrauma, non-survivable",
      },
      hospitals: [
        "Dhahran Trauma Center ‚Äî Highway Critical Care",
        "King Fahad Medical City ‚Äî Level 1 Trauma Centre",
        "Mina Emergency Hospital ‚Äî Hajj Priority Centre",
        "AlUla Field Medical Base ‚Äî Desert Response",
      ],
      tests: [
        "FAST ultrasound",
        "Carboxyhaemoglobin level (CO)",
        "Plain X-ray",
        "MRI scan",
        "CT scan",
        "Intravenous (IV) fluids",
        "Blood typing and crossmatch",
        "Serum lactate",
        "Burn depth assessment",
      ],
    },
  };

  let currentScenarioId = "s1";

  let collectedVitals;
  let imagesByPart;
  let timerRunning = false;
  let timerStartMs = 0;
  let timerStoppedValue = 0;

  let currentTriage = null;
  let currentHospital = null;
  let currentTests = new Set();
  let lastOperatorName = "Visitor";
  let lastOperatorMode = "Solo";

  const leaderboard = [];

  function resetStateForScenario() {
    collectedVitals = {
      consciousness: false,
      respRate: false,
      heartRate: false,
      bloodPressure: false,
      injury: false,
    };
    imagesByPart = {
      head: null,
      chest: null,
      abdomen: null,
      arms: null,
      legs: null,
    };

    Object.keys(vitalEls).forEach((key) => {
      vitalEls[key].textContent = "‚Äî";
    });

    bodyImageBoxes.forEach((box) => {
      const img = box.querySelector("img");
      const ph = box.querySelector(".image-placeholder");
      img.style.display = "none";
      img.src = "";
      ph.style.display = "block";
    });

    timerRunning = false;
    timerStartMs = 0;
    timerStoppedValue = 0;
    timerText.textContent = "0.00 s";
    timerNote.textContent = "Scan any patient tag to begin.";

    currentTriage = null;
    currentHospital = null;
    currentTests = new Set();

    triageCircles.forEach((c) => c.classList.remove("active"));
    submitDecisionBtn.disabled = true;

    resHumanTriage.textContent = "‚Äî";
    resAiTriage.textContent = "‚Äî";
    resMatchTriage.textContent = "‚Äî";
    resHumanHospital.textContent = "‚Äî";
    resAiHospital.textContent = "‚Äî";
    resMatchHospital.textContent = "‚Äî";
    resHumanTests.textContent = "‚Äî";
    resAiTests.textContent = "‚Äî";
    resMatchTests.textContent = "‚Äî";
    resHumanTime.textContent = "‚Äî";
    resAiTime.textContent = "‚Äî";
    resMatchTime.textContent = "‚Äî";
    scoreLine.textContent = "Score: ‚Äî / 12 points";

    populateHospitalAndTests();
  }

  function populateHospitalAndTests() {
    const sc = scenarios[currentScenarioId];
    hospitalOptionsDiv.innerHTML = "";
    sc.hospitals.forEach((name) => {
      const id = "hosp-" + name.replace(/\W+/g, "-");
      const wrapper = document.createElement("div");
      wrapper.className = "hospital-option";
      wrapper.innerHTML = `
        <label>
          <input type="radio" name="hospital" value="${name}" id="${id}">
          ${name}
        </label>`;
      hospitalOptionsDiv.appendChild(wrapper);
    });

    testOptionsDiv.innerHTML = "";
    sc.tests.forEach((t) => {
      const id = "test-" + t.replace(/\W+/g, "-");
      const wrapper = document.createElement("div");
      wrapper.className = "hospital-option";
      wrapper.innerHTML = `
        <label>
          <input type="checkbox" value="${t}" id="${id}">
          ${t}
        </label>`;
      testOptionsDiv.appendChild(wrapper);
    });
  }

  function inferBodyPartFromUrl(url) {
    const u = url.toLowerCase();
    if (u.includes("head")) return "head";
    if (u.includes("chest")) return "chest";
    if (u.includes("abdomen")) return "abdomen";
    if (u.includes("arm")) return "arms";
    if (u.includes("leg") || u.includes("id")) return "legs";
    return null;
  }

  function handleValidScan(url) {
    const part = inferBodyPartFromUrl(url);
    if (!part) {
      timerNote.textContent = "Tag scanned, but body region not recognised.";
      return;
    }

    if (!timerRunning) {
      timerRunning = true;
      timerStartMs = performance.now();
      requestAnimationFrame(updateTimer);
      timerNote.textContent = "Vitals incoming‚Ä¶";
    }

    const box = document.querySelector(`.image-box[data-part="${part}"]`);
    if (!box) return;
    const img = box.querySelector("img");
    const ph = box.querySelector(".image-placeholder");
    img.src = url;
    img.style.display = "block";
    ph.style.display = "none";
    imagesByPart[part] = url;

    const vitalKey = partToVitalKey[part];
    if (vitalKey && !collectedVitals[vitalKey]) {
      const sc = scenarios[currentScenarioId];
      vitalEls[vitalKey].textContent = sc.vitals[vitalKey];
      collectedVitals[vitalKey] = true;
    }

    const allVitalsDone = Object.values(collectedVitals).every(Boolean);
    if (allVitalsDone) {
      timerNote.textContent = "All vitals collected! Make your triage decision.";
      submitDecisionBtn.disabled = false;
    } else {
      const count = Object.values(collectedVitals).filter(Boolean).length;
      timerNote.textContent = `Vitals scanned: ${count} / 5`;
    }
  }

  function updateTimer(timestamp) {
    if (!timerRunning) return;
    const elapsedMs = timestamp - timerStartMs;
    timerStoppedValue = elapsedMs;
    const sec = elapsedMs / 1000;
    const whole = Math.floor(sec);
    const ms2 = Math.floor((sec - whole) * 100);
    timerText.textContent = `${whole}.${ms2.toString().padStart(2, "0")} s`;
    requestAnimationFrame(updateTimer);
  }

  function aiForScenario() {
    return scenarios[currentScenarioId];
  }

  function computeScore(human, ai, humanTimeSec) {
    let score = 0;
    if (human.triage === ai.aiTriage) score += 5;
    if (human.hospital === ai.aiHospital) score += 3;

    const setHuman = new Set(human.tests);
    const setAi = new Set(ai.aiTests);
    const sameSize = setHuman.size === setAi.size;
    const allIn = [...setHuman].every((t) => setAi.has(t));
    if (sameSize && allIn) score += 3;

    if (humanTimeSec < ai.aiTimeSec) score += 1;

    return score;
  }

  function updateLeaderboard() {
    leaderboardBody.innerHTML = "";
    leaderboard
      .sort((a, b) => b.score - a.score || a.timeSec - b.timeSec)
      .forEach((row, idx) => {
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${idx + 1}</td>
          <td>${row.name}</td>
          <td>${row.scenario}</td>
          <td>${row.score} / 12</td>
          <td>${row.time.toFixed(2)} s</td>
        `;
        leaderboardBody.appendChild(tr);
      });
  }

  // Scenario change
  scenarioSelect.addEventListener("change", () => {
    currentScenarioId = scenarioSelect.value;
    resetStateForScenario();
  });

  // Triages
  triageCircles.forEach((circle) => {
    circle.addEventListener("click", () => {
      triageCircles.forEach((c) => c.classList.remove("active"));
      circle.classList.add("active");
      currentTriage = circle.getAttribute("data-triage");
    });
  });

  // Hospital selection
  hospitalOptionsDiv.addEventListener("change", (e) => {
    if (e.target && e.target.name === "hospital") {
      currentHospital = e.target.value;
    }
  });

  // Tests selection
  testOptionsDiv.addEventListener("change", (e) => {
    if (e.target && e.target.type === "checkbox") {
      const val = e.target.value;
      if (e.target.checked) currentTests.add(val);
      else currentTests.delete(val);
    }
  });

  // Submit
  submitDecisionBtn.addEventListener("click", () => {
    if (!currentTriage || !currentHospital) return;

    timerRunning = false;
    const timeSec = timerStoppedValue / 1000;

    const ai = aiForScenario();
    const human = {
      triage: currentTriage,
      hospital: currentHospital,
      tests: Array.from(currentTests),
    };

    const score = computeScore(human, ai, timeSec);

    resHumanTriage.textContent = human.triage;
    resAiTriage.textContent = ai.aiTriage;
    resMatchTriage.textContent =
      human.triage === ai.aiTriage ? "‚úÖ" : "‚ùå";

    resHumanHospital.textContent = human.hospital;
    resAiHospital.textContent = ai.aiHospital;
    resMatchHospital.textContent =
      human.hospital === ai.aiHospital ? "‚úÖ" : "‚ùå";

    resHumanTests.textContent = human.tests.join(", ") || "None";
    resAiTests.textContent = ai.aiTests.join(", ");
    const sameTests =
      human.tests.length === ai.aiTests.length &&
      human.tests.every((t) => ai.aiTests.includes(t));
    resMatchTests.textContent = sameTests ? "‚úÖ" : "‚ùå";

    resHumanTime.textContent = `${timeSec.toFixed(2)} s`;
    resAiTime.textContent = `${ai.aiTimeSec.toFixed(2)} s`;
    resMatchTime.textContent =
      timeSec < ai.aiTimeSec ? "‚è±Ô∏è‚úÖ" : "‚è±Ô∏è‚ùå";

    scoreLine.textContent = `Score: ${score} / 12 points`;

    const nameDisplay = `${lastOperatorName} (${lastOperatorMode})`;

    const lbRow = {
      name: nameDisplay,
      scenario: scenarios[currentScenarioId].name,
      score,
      time: timeSec,
      timeSec,
    };
    leaderboard.push(lbRow);
    updateLeaderboard();

    socket.emit("final-score", lbRow);
  });

  // Socket listeners
  socket.on("operator-info", (info) => {
    lastOperatorName = info.name || "Visitor";
    lastOperatorMode = info.mode || "Solo";
    operatorDisplay.textContent = `${lastOperatorName} (${lastOperatorMode})`;
  });

  socket.on("qr-scanned", (data) => {
    if (data.operator) {
      lastOperatorName = data.operator;
      lastOperatorMode = data.mode || "Solo";
      operatorDisplay.textContent = `${lastOperatorName} (${lastOperatorMode})`;
    }
    handleValidScan(data.url);
  });

  socket.on("final-score", (row) => {
    leaderboard.push(row);
    updateLeaderboard();
  });

  // initial
  resetStateForScenario();
</script>
</body>
</html>
