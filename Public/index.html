<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Emergency Drone Simulation ‚Äì Big Screen</title>
  <script src="/socket.io/socket.io.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>

  <style>
    body {
      font-family: system-ui, sans-serif;
      background: #020617;
      color: #e5e7eb;
      margin: 0;
      padding: 20px;
    }

    h1, h2, h3 { margin: 0.4rem 0; }

    .row {
      display: flex;
      gap: 20px;
      margin-top: 20px;
      flex-wrap: wrap;
    }

    .card {
      flex: 1;
      min-width: 320px;
      background: #0f172a;
      border-radius: 12px;
      padding: 16px 18px;
      box-shadow: 0 0 20px rgba(15, 23, 42, 0.7);
    }

    .label {
      font-size: 0.9rem;
      text-transform: uppercase;
      color: #9ca3af;
      letter-spacing: 0.08em;
      margin-top: 10px;
      margin-bottom: 4px;
    }

    .value {
      font-size: 1.05rem;
      margin-bottom: 0.4rem;
    }

    /* BIGGER VITALS */
    #vitalsList {
      font-size: 1.2rem;
      line-height: 1.8;
    }

    .vital {
      margin-bottom: 0.15rem;
    }

    .timer-seconds {
      font-size: 2rem;
      font-weight: 700;
    }

    .timer-ms {
      font-size: 1.2rem;
      font-weight: 500;
      opacity: 0.9;
    }

    button {
      padding: 8px 16px;
      border-radius: 999px;
      border: none;
      cursor: pointer;
      margin-top: 12px;
      margin-right: 8px;
      font-size: 0.95rem;
    }

    button.primary { background: #2563eb; color: #fff; }
    button.danger  { background: #b91c1c; color: #fff; }

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.95rem;
      margin-top: 8px;
    }

    th, td {
      border-bottom: 1px solid #1f2937;
      padding: 6px 4px;
      text-align: left;
    }

    .small { font-size: 0.8rem; color: #9ca3af; }

    .big-text {
      font-size: 1.15rem;
      line-height: 1.8;
      color: #e2e8f0;
    }

    .glow-title {
      font-size: 1.3rem;
      font-weight: 700;
      color: #fff;
      text-shadow: 0 0 10px rgba(255,255,255,0.55);
      margin-top: 12px;
      margin-bottom: 6px;
    }

    .glow-box {
      background: rgba(15,23,42,0.9);
      border-radius: 12px;
      padding: 12px 14px;
      margin-top: 6px;
      border: 1px solid rgba(148,163,184,0.6);
      box-shadow: 0 0 18px rgba(56,189,248,0.4);
    }

    .important-text {
      color: #fff;
      font-weight: 600;
      text-shadow: 0 0 8px rgba(255,255,255,0.7);
    }
  </style>
</head>

<body>
  <h1>üö® Emergency Drone Simulation ‚Äì Human vs AI Triage</h1>
  <p class="small">
    Players scan QR codes on mannequins. Vitals appear on this screen. The team then performs triage, chooses tests and selects the most appropriate receiving hospital.
  </p>

  <div class="row">
    <!-- CURRENT CASE / MONITOR -->
    <div class="card">
      <div class="label">Current Team</div>
      <div class="value" id="teamInfo">Waiting for player...</div>

      <div class="label">Patient Scenario</div>
      <div class="value" id="patientInfo">‚Äì</div>
      <div id="patientNarrative" class="glow-box big-text"></div>

      <div class="label">Recorded Vitals</div>
      <div id="vitalsList">
        <span class="small">No vitals scanned yet.</span>
      </div>

      <div class="label">Triage Timer</div>
      <div id="timerDisplay">Timer: --</div>
      <div class="small" id="infoMessage" style="margin-top:4px;"></div>

      <button class="danger" id="resetBtn">Reset Simulation</button>
      <button class="danger" id="resetLeaderboardBtn">Reset Leaderboard</button>
    </div>

    <!-- HUMAN TRIAGE PANEL -->
    <div class="card">
      <h2>üß© Human Triage Panel</h2>

      <!-- 1. TRIAGE CATEGORY -->
      <div class="label">1. Triage Category</div>
      <select id="triageSelect">
        <option value="">Select triage category...</option>
        <option value="Red">üî¥ Red ‚Äì Immediate</option>
        <option value="Yellow">üü° Yellow ‚Äì Urgent but delayed</option>
        <option value="Green">üü¢ Green ‚Äì Minimal</option>
        <option value="Black">‚ö´ Black ‚Äì Expectant / deceased</option>
      </select>

      <!-- 2. RECEIVING HOSPITAL -->
      <div class="label">2. Receiving Hospital</div>
      <label class="small">
        <input type="radio" name="hospitalChoice" value="King Fahad Medical City ‚Äî Level 1 Trauma Center">
        üöë King Fahad Medical City ‚Äî Level 1 Trauma Center
      </label><br>
      <label class="small">
        <input type="radio" name="hospitalChoice" value="Mina Emergency Hospital ‚Äî Hajj Priority Center">
        üè• Mina Emergency Hospital ‚Äî Hajj Priority Center
      </label><br>
      <label class="small">
        <input type="radio" name="hospitalChoice" value="AlUla Field Medical Base ‚Äî Desert Response">
        üè• AlUla Field Medical Base ‚Äî Desert Response
      </label><br>
      <label class="small">
        <input type="radio" name="hospitalChoice" value="Dhahran Trauma Center ‚Äî Highway Critical Care">
        üè• Dhahran Trauma Center ‚Äî Highway Critical Care
      </label><br>

      <!-- 3. EMERGENCY DEPARTMENT TESTS -->
      <div class="label">3. Emergency Department Tests</div>
      <label class="small"><input type="checkbox" class="testCheckbox" value="FAST ultrasound"> FAST ultrasound (trauma scan)</label><br>
      <label class="small"><input type="checkbox" class="testCheckbox" value="Carboxyhaemoglobin level"> Carboxyhaemoglobin level (CO)</label><br>
      <label class="small"><input type="checkbox" class="testCheckbox" value="Plain X-ray"> Plain X-ray</label><br>
      <label class="small"><input type="checkbox" class="testCheckbox" value="MRI scan"> MRI scan</label><br>
      <label class="small"><input type="checkbox" class="testCheckbox" value="CT scan"> CT scan</label><br>
      <label class="small"><input type="checkbox" class="testCheckbox" value="Intravenous fluids"> Intravenous (IV) fluids</label><br>
      <label class="small"><input type="checkbox" class="testCheckbox" value="Blood typing and crossmatch"> Blood typing and crossmatch</label><br>
      <label class="small"><input type="checkbox" class="testCheckbox" value="Serum lactate"> Serum lactate</label><br>
      <label class="small"><input type="checkbox" class="testCheckbox" value="Burn depth assessment"> Burn depth assessment</label><br>

      <!-- 4. INITIAL EMERGENCY MANAGEMENT -->
      <div class="label">4. Primary Emergency Treatment</div>
      <select id="primarySelect">
        <option value="">Select primary treatment...</option>
        <option value="Rapid IV fluids and oxygen">Rapid IV fluids and oxygen</option>
        <option value="High-flow oxygen, burn dressing, analgesia">High-flow oxygen, burn dressing, analgesia</option>
        <option value="Oral rehydration solution, shade and cooling">Oral rehydration solution, shade and cooling</option>
        <option value="Immediate high-quality CPR">Immediate high-quality CPR</option>
      </select>

      <div class="label">5. Adjunct Treatment / Monitoring</div>
      <select id="secondarySelect">
        <option value="">Select adjunct treatment...</option>
        <option value="Blood transfusion, pelvic stabilisation, analgesia">Blood transfusion, pelvic stabilisation, analgesia</option>
        <option value="Carboxyhaemoglobin level, ECG, chest X-ray">Carboxyhaemoglobin level, ECG, chest X-ray</option>
        <option value="Monitor symptoms; consider blood tests if no improvement">Monitor symptoms; consider blood tests if no improvement</option>
        <option value="If local policy allows, brief CPR / ACLS attempt">If local policy allows, brief CPR / ACLS attempt</option>
      </select>

      <div class="label">6. Disposition</div>
      <select id="dispositionSelect">
        <option value="">Select disposition...</option>
        <option value="Emergency operating theatre">Emergency operating theatre</option>
        <option value="Observation ward / burns unit">Observation ward / burns unit</option>
        <option value="Discharge from checkpoint with advice">Discharge from checkpoint with advice</option>
        <option value="Expectant / deceased; document and prioritise other casualties">
          Expectant / deceased; document and prioritise other casualties
        </option>
      </select>

      <div class="label">7. Overall Treatment Tag</div>
      <select id="treatmentSelect">
        <option value="">Select treatment tag...</option>
        <option value="Emergency Surgery">Emergency Surgery</option>
        <option value="Observation">Observation</option>
        <option value="Hydration and rest">Hydration and rest</option>
        <option value="Discharge with analgesia">Discharge with analgesia</option>
        <option value="CPR / ACLS as appropriate">CPR / ACLS as appropriate</option>
      </select>

      <button class="primary" id="submitDecisionBtn">Submit Decision</button>
      <div class="small" id="submitStatus" style="margin-top:4px;"></div>
    </div>
  </div>

  <div class="row">
    <!-- RESULTS -->
    <div class="card">
      <h2>üìä Human vs AI ‚Äì Comparison</h2>
      <table>
        <thead>
          <tr>
            <th>Category</th>
            <th>Human</th>
            <th>AI</th>
            <th>Match</th>
          </tr>
        </thead>
        <tbody id="resultsTableBody"></tbody>
      </table>

      <div class="label" style="margin-top: 10px;">Score</div>
      <div class="value" id="scoreDisplay">‚Äì</div>

      <div class="small" id="scoreBreakdown"></div>

      <h3 class="glow-title">üß† Why the AI chose this plan</h3>
      <div id="explanationBox" class="glow-box big-text">
        <p><span class="important-text">Triage decision:</span> <span id="explainTriage">‚Äì</span></p>
        <p><span class="important-text">Choice of tests:</span> <span id="explainTests">‚Äì</span></p>
        <p><span class="important-text">Treatment and disposition:</span> <span id="explainTreatment">‚Äì</span></p>
      </div>
    </div>

    <!-- LEADERBOARD -->
    <div class="card">
      <h2>üèÜ Leaderboard</h2>
      <table>
        <thead>
          <tr>
            <th>#</th>
            <th>Team</th>
            <th>Mode</th>
            <th>Points</th>
            <th>Time (s)</th>
          </tr>
        </thead>
        <tbody id="leaderboardBody"></tbody>
      </table>
    </div>
  </div>

  <script>
    const socket = io();

    let currentGame = null;

    const teamInfoEl = document.getElementById("teamInfo");
    const patientInfoEl = document.getElementById("patientInfo");
    const patientNarrativeEl = document.getElementById("patientNarrative");
    const vitalsListEl = document.getElementById("vitalsList");
    const timerDisplayEl = document.getElementById("timerDisplay");
    const infoMessageEl = document.getElementById("infoMessage");
    const submitStatusEl = document.getElementById("submitStatus");
    const resultsTableBody = document.getElementById("resultsTableBody");
    const scoreDisplayEl = document.getElementById("scoreDisplay");
    const scoreBreakdownEl = document.getElementById("scoreBreakdown");
    const leaderboardBody = document.getElementById("leaderboardBody");
    const explainTriageEl = document.getElementById("explainTriage");
    const explainTestsEl = document.getElementById("explainTests");
    const explainTreatmentEl = document.getElementById("explainTreatment");

    const triageSelect = document.getElementById("triageSelect");
    const treatmentSelect = document.getElementById("treatmentSelect");
    const primarySelect = document.getElementById("primarySelect");
    const secondarySelect = document.getElementById("secondarySelect");
    const dispositionSelect = document.getElementById("dispositionSelect");
    const testCheckboxes = document.querySelectorAll(".testCheckbox");
    const hospitalRadios = document.querySelectorAll('input[name="hospitalChoice"]');

    let timerInterval = null;
    let timerStart = null;

    function startTimer(durationSeconds) {
      timerStart = performance.now();
      const endTime = timerStart + durationSeconds * 1000;

      if (timerInterval) clearInterval(timerInterval);

      timerInterval = setInterval(() => {
        const now = performance.now();
        let remaining = endTime - now;

        if (remaining <= 0) {
          remaining = 0;
          clearInterval(timerInterval);
          timerInterval = null;
        }

        const totalSeconds = remaining / 1000;
        const formatted = totalSeconds.toFixed(2);
        const [sec, ms] = formatted.split(".");

        timerDisplayEl.innerHTML =
          `<span class="timer-seconds">${sec}</span>` +
          `<span class="timer-ms">.${ms}</span> s`;
      }, 16);
    }

    function stopTimerAndFreeze() {
      if (timerInterval) {
        clearInterval(timerInterval);
        timerInterval = null;
      }

      if (timerStart !== null) {
        const elapsedSec = (performance.now() - timerStart) / 1000;
        const formatted = elapsedSec.toFixed(2);
        const [sec, ms] = formatted.split(".");

        timerDisplayEl.innerHTML =
          `<span class="timer-seconds">${sec}</span>` +
          `<span class="timer-ms">.${ms}</span> s (final)`;
      }
    }

    function resetTimerDisplay() {
      if (timerInterval) clearInterval(timerInterval);
      timerInterval = null;
      timerStart = null;
      timerDisplayEl.textContent = "Timer: --";
    }

    function arraysEqualAsSets(a, b) {
      const setA = new Set(a);
      const setB = new Set(b);
      if (setA.size !== setB.size) return false;
      for (const item of setA) if (!setB.has(item)) return false;
      return true;
    }

    socket.on("stateUpdate", (data) => {
      currentGame = data.currentGame || null;

      leaderboardBody.innerHTML = "";
      (data.leaderboard || []).forEach((entry, i) => {
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${i + 1}</td>
          <td>${entry.playerName}</td>
          <td>${entry.mode}</td>
          <td>${entry.points}</td>
          <td>${entry.timeSeconds.toFixed(2)}</td>
        `;
        leaderboardBody.appendChild(tr);
      });

      if (!currentGame) {
        teamInfoEl.textContent = "Waiting for player...";
        patientInfoEl.textContent = "‚Äì";
        patientNarrativeEl.textContent = "";
        vitalsListEl.innerHTML = "<span class='small'>No vitals scanned yet.</span>";
        infoMessageEl.textContent = "";
        resetTimerDisplay();
        return;
      }

      teamInfoEl.textContent = currentGame.playerName;
      patientInfoEl.textContent = currentGame.patientName;
      patientNarrativeEl.textContent = currentGame.patientNarrative || "";
    });

    // Map internal vital keys to clinical labels
    const vitalLabels = {
      consciousness: "Consciousness",
      respiratoryRate: "Respiratory rate",
      pulse: "Heart rate (pulse)",
      bloodPressure: "Blood pressure",
      oxygenSaturation: "Oxygen saturation"
    };

    // VITAL SCAN HANDLER
    socket.on("vitalScanned", (payload) => {
      if (
        vitalsListEl.firstChild &&
        vitalsListEl.firstChild.classList &&
        vitalsListEl.firstChild.classList.contains("small")
      ) {
        vitalsListEl.innerHTML = "";
      }

      let line = vitalsListEl.querySelector(`.vital[data-key="${payload.vitalKey}"]`);

      if (!line) {
        line = document.createElement("div");
        line.className = "vital";
        line.dataset.key = payload.vitalKey;
        vitalsListEl.appendChild(line);
      }

      const label = vitalLabels[payload.vitalKey] || payload.vitalKey;
      line.textContent = `${label}: ${payload.vitalValue}`;

      infoMessageEl.textContent =
        `‚úÖ Vital ${payload.count} of ${payload.total} received ‚Äî scan the next tag.`;
    });

    socket.on("allVitalsCollected", (payload) => {
      infoMessageEl.textContent =
        "üö® All vitals collected. Move to the triage zone and make your decision.";
      startTimer(payload.triageTimerSeconds || 60);
    });

    socket.on("resultsReady", (result) => {
      stopTimerAndFreeze();

      resultsTableBody.innerHTML = "";
      const rows = [
        { category: "Triage category", human: result.human.triage, ai: result.ai.triage },
        {
          category: "Receiving hospital",
          human: result.human.hospital || "Not selected",
          ai: result.ai.hospital || "‚Äì"
        },
        {
          category: "Emergency department tests",
          human: result.human.tests.join(", ") || "None selected",
          ai: result.ai.tests.join(", ") || "None"
        },
        {
          category: "Treatment tag",
          human: result.human.treatment,
          ai: result.ai.treatment
        },
        {
          category: "Treatment plan (primary / adjunct / disposition)",
          human: `${result.human.treatmentSteps.primary || "‚Äì"} / ${result.human.treatmentSteps.secondary || "‚Äì"} / ${result.human.treatmentSteps.disposition || "‚Äì"}`,
          ai: `${result.ai.treatmentSteps.primary} / ${result.ai.treatmentSteps.secondary} / ${result.ai.treatmentSteps.disposition}`
        },
        {
          category: "Time to decision",
          human: `${result.human.timeSeconds.toFixed(2)} s`,
          ai: `${result.ai.aiTimeSeconds.toFixed(2)} s`
        }
      ];

      rows.forEach(r => {
        const tr = document.createElement("tr");
        let match = "‚Äì";

        if (r.category === "Triage category") {
          match = result.human.triage === result.ai.triage ? "‚úÖ" : "‚ùå";
        } else if (r.category === "Receiving hospital") {
          match = result.human.hospital === result.ai.hospital ? "‚úÖ" : "‚ùå";
        } else if (r.category === "Emergency department tests") {
          match = arraysEqualAsSets(result.human.tests, result.ai.tests) ? "‚úÖ" : "‚ùå";
        }

        tr.innerHTML = `
          <td>${r.category}</td>
          <td>${r.human}</td>
          <td>${r.ai}</td>
          <td>${match}</td>
        `;
        resultsTableBody.appendChild(tr);
      });

      const bd = result.scoreBreakdown;
      scoreDisplayEl.textContent = `${bd.total} / 12 points`;

      scoreBreakdownEl.innerHTML = `
        <strong>Scoring:</strong>
        Correct triage <strong>+5</strong> &nbsp;‚Ä¢&nbsp;
        Correct hospital <strong>+3</strong> &nbsp;‚Ä¢&nbsp;
        Correct ER tests <strong>+2</strong> &nbsp;‚Ä¢&nbsp;
        Finished under 30 seconds <strong>+2</strong>
      `;

      explainTriageEl.textContent = result.explanations.triage;
      explainTestsEl.textContent = result.explanations.tests;
      explainTreatmentEl.textContent = result.explanations.treatment;
    });

    document.getElementById("resetBtn").onclick = () => {
      socket.emit("resetGame");
      resetTimerDisplay();
      vitalsListEl.innerHTML = "<span class='small'>No vitals scanned yet.</span>";
      infoMessageEl.textContent = "";
      resultsTableBody.innerHTML = "";
      scoreDisplayEl.textContent = "‚Äì";
      scoreBreakdownEl.textContent = "";
      explainTriageEl.textContent = "‚Äì";
      explainTestsEl.textContent = "‚Äì";
      explainTreatmentEl.textContent = "‚Äì";
    };

    document.getElementById("resetLeaderboardBtn").onclick = () => {
      socket.emit("resetLeaderboard");
    };

    document.getElementById("submitDecisionBtn").onclick = () => {
      const triage = triageSelect.value;
      const treatment = treatmentSelect.value;

      const tests = Array.from(testCheckboxes)
        .filter(c => c.checked)
        .map(c => c.value);

      const hospital =
        Array.from(hospitalRadios).find(r => r.checked)?.value || "";

      const treatmentSteps = {
        primary: primarySelect.value || "",
        secondary: secondarySelect.value || "",
        disposition: dispositionSelect.value || ""
      };

      if (!triage) {
        submitStatusEl.textContent = "Please select a triage category.";
        return;
      }
      if (!hospital) {
        submitStatusEl.textContent = "Please select a receiving hospital.";
        return;
      }
      if (!treatment) {
        submitStatusEl.textContent = "Please select an overall treatment tag.";
        return;
      }

      socket.emit("submitHumanDecision", {
        triage,
        tests,
        treatment,
        treatmentSteps,
        hospital
      });

      submitStatusEl.textContent = "Decision sent. Comparing with AI...";
    };
  </script>
</body>
</html>
