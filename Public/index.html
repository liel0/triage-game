<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>AI Triage Drone 2040 ‚Äì Control Screen</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    :root {
      --bg: #040814;
      --panel: #0b1020;
      --accent: #3fbcff;
      --accent-soft: rgba(63, 188, 255, 0.18);
      --danger: #ff4b5c;
      --warning: #ffc857;
      --success: #4ade80;
      --muted: #9ca3af;
      --text: #f9fafb;
      --card-radius: 18px;
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: radial-gradient(circle at top, #111827 0, #020617 40%, #000 100%);
      color: var(--text);
      overflow: hidden;
    }

    .root {
      display: flex;
      flex-direction: column;
      height: 100vh;
      width: 100vw;
      padding: 12px 18px;
      gap: 10px;
    }

    header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 6px 12px;
      border-radius: 999px;
      background: linear-gradient(90deg, #020617, #020617, #020617);
      border: 1px solid rgba(148, 163, 184, 0.3);
      font-size: 14px;
    }

    header .title {
      display: flex;
      align-items: center;
      gap: 10px;
      font-size: 16px;
      font-weight: 600;
    }

    header .title span {
      font-size: 20px;
    }

    header .meta {
      display: flex;
      align-items: center;
      gap: 14px;
      font-size: 13px;
      color: var(--muted);
    }

    header .meta span.label {
      color: #e5e7eb;
      font-weight: 500;
    }

    main {
      flex: 1;
      display: grid;
      grid-template-rows: 60% 40%;
      gap: 10px;
      min-height: 0;
    }

    .top-row {
      display: grid;
      grid-template-columns: 60% 40%;
      gap: 10px;
      min-height: 0;
    }

    .bottom-row {
      display: grid;
      grid-template-columns: 55% 45%;
      gap: 10px;
      min-height: 0;
    }

    .panel {
      background: radial-gradient(circle at top left, #111827 0, #020617 55%);
      border-radius: var(--card-radius);
      border: 1px solid rgba(148, 163, 184, 0.25);
      padding: 14px 16px;
      box-shadow: 0 18px 40px rgba(15, 23, 42, 0.8);
      min-height: 0;
      overflow: hidden;
    }

    .panel h2 {
      font-size: 16px;
      font-weight: 600;
      margin-bottom: 10px;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .pill {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 4px 10px;
      border-radius: 999px;
      font-size: 12px;
      border: 1px solid rgba(148, 163, 184, 0.4);
      background: rgba(15, 23, 42, 0.8);
      color: var(--muted);
    }

    .scenario-select {
      width: 100%;
      margin-top: 4px;
      margin-bottom: 12px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 8px;
    }

    .scenario-select select {
      flex: 1;
      padding: 8px 10px;
      border-radius: 999px;
      border: 1px solid rgba(148, 163, 184, 0.5);
      background: #020617;
      color: var(--text);
      font-size: 14px;
      outline: none;
    }

    .scenario-select .scan-count {
      font-size: 12px;
      color: var(--muted);
      text-align: right;
    }

    .body-layout {
      display: grid;
      grid-template-columns: 60% 40%;
      gap: 10px;
      min-height: 0;
    }

    .body-map {
      display: flex;
      flex-direction: column;
      gap: 8px;
      min-height: 0;
    }

    .body-row {
      display: grid;
      grid-template-columns: 26% 74%;
      align-items: center;
      gap: 12px;
      min-height: 0;
      border-radius: 999px;
      padding: 6px 10px;
      background: radial-gradient(circle at left, rgba(15,23,42,0.9) 0, #020617 55%);
      border: 1px solid rgba(148, 163, 184, 0.4);
    }

    .body-row[data-state="waiting"] {
      opacity: 0.8;
    }

    .body-row[data-state="scanned"] {
      border-color: rgba(96, 165, 250, 0.9);
      box-shadow: 0 0 12px rgba(56, 189, 248, 0.7);
    }

    .body-label-main {
      font-size: 13px;
      font-weight: 500;
    }

    .body-status {
      font-size: 11px;
      color: var(--muted);
    }

    .body-right {
      display: flex;
      align-items: center;
      justify-content: center;
      position: relative;
      min-height: 0;
    }

    /* Silhouette */

    .silhouette-shell {
      position: relative;
      display: flex;
      align-items: center;
      justify-content: center;
      width: 100%;
      height: 100%;
    }

    .silhouette-frame {
      position: relative;
      width: 60%;
      max-width: 260px;
      aspect-ratio: 0.45 / 1;
      border-radius: 999px;
      background:
        radial-gradient(circle at 50% 115%, #020617 0, #000 40%, transparent 70%),
        radial-gradient(circle at 50% -10%, rgba(15,23,42,0.7) 0, transparent 55%),
        linear-gradient(180deg, #020617, #020617);
      box-shadow:
        0 0 40px rgba(15, 23, 42, 0.9),
        0 0 80px rgba(15, 23, 42, 0.9);
      overflow: hidden;
      padding-inline: 10%;
      padding-block: 8%;
    }

    .silhouette-layers {
      position: absolute;
      inset: 10% 4%;
      display: flex;
      flex-direction: column;
      justify-content: space-between;
      pointer-events: none;
    }

    .silhouette-layer {
      flex: 1;
      margin: 4px 0;
      border-radius: 999px;
      background: radial-gradient(circle at 50% 30%, rgba(15, 23, 42, 0.6), rgba(15, 23, 42, 0.96));
      border: 1px solid rgba(148, 163, 184, 0.25);
      opacity: 0.15;
      transform: translateX(18px);
      box-shadow: 0 0 0 rgba(56,189,248,0);
      transition:
        opacity 0.4s ease-out,
        transform 0.4s ease-out,
        box-shadow 0.4s ease-out,
        border-color 0.4s ease-out,
        background 0.4s ease-out;
    }

    .silhouette-layer.filled {
      opacity: 0.96;
      transform: translateX(0);
      border-color: rgba(125, 211, 252, 0.9);
      background: radial-gradient(circle at 50% 30%, rgba(59,130,246,0.7), rgba(15,23,42,0.98));
      box-shadow:
        0 0 16px rgba(56, 189, 248, 0.9),
        0 0 36px rgba(59, 130, 246, 0.9);
    }

    .silhouette-figure {
      position: absolute;
      inset: 6% 18%;
      background-image: url("/images/body_silhouette.png");
      background-position: center bottom;
      background-repeat: no-repeat;
      background-size: contain;
      opacity: 0.96;
      filter:
        drop-shadow(0 0 10px rgba(148,163,184,0.7))
        drop-shadow(0 0 20px rgba(15,23,42,0.9));
      pointer-events: none;
    }

    .scan-footer {
      margin-top: 10px;
      font-size: 12px;
      color: var(--muted);
    }

    .scan-footer-top {
      margin-bottom: 4px;
    }

    .scan-footer-bottom {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 8px;
      margin-top: 4px;
    }

    .scan-status-text {
      font-size: 12px;
      color: var(--muted);
    }

    .btn-primary,
    .btn-secondary,
    .btn-small {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
      padding: 7px 14px;
      border-radius: 999px;
      border: none;
      cursor: pointer;
      font-size: 13px;
      font-weight: 600;
    }

    .btn-primary {
      background: linear-gradient(135deg, #3b82f6, #22c55e);
      color: white;
      box-shadow: 0 12px 30px rgba(34, 197, 94, 0.5);
    }

    .btn-secondary {
      background: #111827;
      color: var(--text);
      border: 1px solid rgba(148, 163, 184, 0.7);
      box-shadow: none;
    }

    .btn-primary:disabled,
    .btn-secondary:disabled {
      opacity: 0.45;
      cursor: default;
      box-shadow: none;
    }

    .btn-small {
      padding: 4px 10px;
      font-size: 11px;
    }

    .btn-orange {
      background: linear-gradient(135deg,#ef4444,#f97316);
      color: white;
      box-shadow: 0 10px 22px rgba(248, 113, 113, 0.4);
    }

    .vitals-list {
      margin-top: 4px;
      display: flex;
      flex-direction: column;
      gap: 6px;
      font-size: 14px;
    }

    .vital-row {
      display: flex;
      justify-content: space-between;
      align-items: baseline;
      border-bottom: 1px dashed rgba(51, 65, 85, 0.7);
      padding: 4px 0;
    }

    .vital-label {
      color: var(--muted);
    }

    .vital-value {
      font-weight: 600;
    }

    .timer {
      margin-top: 12px;
      padding: 8px 10px;
      border-radius: 999px;
      background: rgba(15, 23, 42, 0.9);
      display: flex;
      align-items: center;
      justify-content: space-between;
      font-size: 14px;
      border: 1px solid rgba(148, 163, 184, 0.4);
    }

    .timer span.time {
      font-weight: 700;
      font-size: 18px;
    }

    .triage-controls {
      display: flex;
      flex-direction: column;
      gap: 8px;
      height: 100%;
    }

    .triage-circles {
      display: flex;
      gap: 14px;
      align-items: center;
    }

    .triage-circle {
      width: 40px;
      height: 40px;
      border-radius: 999px;
      border: 2px solid transparent;
      cursor: pointer;
      position: relative;
      box-shadow: 0 0 0 0 rgba(0, 0, 0, 0);
      transition: transform 0.12s ease-out, box-shadow 0.12s ease-out, border-color 0.12s ease-out;
    }

    .triage-circle[data-level="Red"] { background: var(--danger); }
    .triage-circle[data-level="Yellow"] { background: var(--warning); }
    .triage-circle[data-level="Green"] { background: var(--success); }
    .triage-circle[data-level="Black"] { background: #020617; border: 1px solid #6b7280; }

    .triage-circle span {
      position: absolute;
      bottom: -18px;
      left: 50%;
      transform: translateX(-50%);
      font-size: 11px;
      white-space: nowrap;
      color: var(--muted);
    }

    .triage-circle.selected {
      transform: scale(1.08);
      box-shadow: 0 0 18px rgba(94, 234, 212, 0.8);
      border-color: #e5e7eb;
    }

    .triage-steps-label {
      font-size: 12px;
      color: var(--muted);
    }

    .hospital-tests {
      margin-top: 8px;
      display: grid;
      grid-template-columns: 55% 45%;
      gap: 8px;
      font-size: 13px;
    }

    .hospital-card {
      border-radius: 16px;
      padding: 8px 10px;
      border: 1px solid rgba(148, 163, 184, 0.5);
      background: rgba(15, 23, 42, 0.92);
      cursor: pointer;
      margin-bottom: 6px;
    }

    .hospital-card.selected {
      border-color: var(--accent);
      box-shadow: 0 0 16px rgba(59, 130, 246, 0.7);
    }

    .hospital-name {
      font-weight: 600;
      margin-bottom: 3px;
    }

    .hospital-meta {
      font-size: 11px;
      color: var(--muted);
    }

    .tests-list {
      border-radius: 16px;
      border: 1px solid rgba(148, 163, 184, 0.4);
      background: rgba(15, 23, 42, 0.96);
      padding: 8px 10px;
      display: flex;
      flex-direction: column;
      gap: 4px;
      max-height: 140px;
      overflow-y: auto;
    }

    .test-row {
      display: flex;
      gap: 6px;
      align-items: center;
      font-size: 12px;
    }

    .test-row input {
      accent-color: var(--accent);
    }

    .submit-row {
      margin-top: 8px;
      display: flex;
      justify-content: space-between;
      gap: 8px;
      align-items: center;
      font-size: 12px;
      color: var(--muted);
    }

    .results-table {
      width: 100%;
      font-size: 12px;
      border-collapse: collapse;
    }

    .results-table th,
    .results-table td {
      padding: 4px 6px;
      border-bottom: 1px solid rgba(30, 64, 175, 0.5);
      text-align: left;
    }

    .results-table th {
      font-weight: 600;
      color: var(--muted);
    }

    .match-cell {
      text-align: center;
      font-size: 14px;
    }

    .match-yes { color: #4ade80; }
    .match-no { color: #f97373; }

    .score-summary {
      margin-top: 6px;
      font-size: 13px;
    }

    .leaderboard {
      margin-top: 8px;
      font-size: 12px;
    }

    .leaderboard table {
      width: 100%;
      border-collapse: collapse;
    }

    .leaderboard th,
    .leaderboard td {
      padding: 3px 4px;
      border-bottom: 1px solid rgba(30, 64, 175, 0.4);
      text-align: left;
    }

    .leaderboard th {
      font-weight: 600;
      color: var(--muted);
    }

    .glow {
      text-shadow: 0 0 10px rgba(56, 189, 248, 0.7);
    }
  </style>
</head>
<body>
<div class="root">
  <header>
    <div class="title">
      <span>üöÅ</span>
      <div>
        <div>AI Triage Drone 2040</div>
        <div style="font-size:12px;color:var(--muted);">Mass casualty triage training ‚Ä¢ Human vs AI</div>
      </div>
    </div>
    <div class="meta">
      <div id="phaseLabel"><span class="label">Phase 1:</span> Drone scanning</div>
      <div id="operatorLabel">Operator: Waiting for mobile operator‚Ä¶</div>
    </div>
  </header>

  <main>
    <!-- TOP ROW -->
    <div class="top-row">
      <!-- BODY MAP + SILHOUETTE -->
      <section class="panel" id="bodyPanel">
        <h2>Patient Body Map &amp; Drone Feed</h2>

        <div class="scenario-select">
          <select id="scenarioSelect"></select>
          <div class="scan-count" id="scanCountLabel">Scans: 0 / 7</div>
        </div>

        <div class="body-layout">
          <div class="body-map">
            <div class="body-row" data-slot="id" data-state="waiting">
              <div>
                <div class="body-label-main">Eyes / ID</div>
                <div class="body-status" data-status>Waiting for scan‚Ä¶</div>
              </div>
            </div>
            <div class="body-row" data-slot="conclevel" data-state="waiting">
              <div>
                <div class="body-label-main">Face ‚Äì Consciousness</div>
                <div class="body-status" data-status>Waiting for scan‚Ä¶</div>
              </div>
            </div>
            <div class="body-row" data-slot="hr" data-state="waiting">
              <div>
                <div class="body-label-main">Neck ‚Äì Heart rate</div>
                <div class="body-status" data-status>Waiting for scan‚Ä¶</div>
              </div>
            </div>
            <div class="body-row" data-slot="rr" data-state="waiting">
              <div>
                <div class="body-label-main">Chest ‚Äì Respiratory rate</div>
                <div class="body-status" data-status>Waiting for scan‚Ä¶</div>
              </div>
            </div>
            <div class="body-row" data-slot="bp" data-state="waiting">
              <div>
                <div class="body-label-main">Arms ‚Äì Blood pressure</div>
                <div class="body-status" data-status>Waiting for scan‚Ä¶</div>
              </div>
            </div>
            <div class="body-row" data-slot="injury1" data-state="waiting">
              <div>
                <div class="body-label-main">Pelvis / Abdomen ‚Äì Injury 1</div>
                <div class="body-status" data-status>Waiting for scan‚Ä¶</div>
              </div>
            </div>
            <div class="body-row" data-slot="injury2" data-state="waiting">
              <div>
                <div class="body-label-main">Legs / Feet ‚Äì Injury 2</div>
                <div class="body-status" data-status>Waiting for scan‚Ä¶</div>
              </div>
            </div>
          </div>

          <div class="body-right">
            <div class="silhouette-shell">
              <div class="silhouette-frame">
                <div class="silhouette-layers" id="silhouetteLayers">
                  <!-- 7 layers created in JS -->
                </div>
                <div class="silhouette-figure"></div>
              </div>
            </div>
          </div>
        </div>

        <div class="scan-footer">
          <div class="scan-footer-top">
            Scan from head to toe in this exact order. The silhouette will light up with each scan.
            When all scans are complete, press <strong>Continue to triage</strong>.
          </div>
          <ol style="padding-left:18px;margin-top:2px;">
            <li>Eyes ‚Äì ID</li>
            <li>Face ‚Äì consciousness level</li>
            <li>Neck ‚Äì heart rate</li>
            <li>Chest ‚Äì respiratory rate</li>
            <li>Arms ‚Äì blood pressure (not used in Scenario 4)</li>
            <li>Pelvis / Abdomen ‚Äì main injury</li>
            <li>Legs / Feet ‚Äì secondary injury</li>
          </ol>
          <div class="scan-footer-bottom">
            <span class="scan-status-text" id="scanStatusText">Waiting for first QR scan‚Ä¶</span>
            <button class="btn-primary btn-small" id="continueTriageBtn" disabled>Continue to triage</button>
          </div>
        </div>
      </section>

      <!-- VITALS PANEL -->
      <section class="panel">
        <h2>Live Vitals (from drone)</h2>
        <div class="vitals-list">
          <div class="vital-row">
            <div class="vital-label">Consciousness</div>
            <div class="vital-value" id="vConsciousness">‚Äî</div>
          </div>
          <div class="vital-row">
            <div class="vital-label">Respiratory rate (RR)</div>
            <div class="vital-value" id="vRR">‚Äî</div>
          </div>
          <div class="vital-row">
            <div class="vital-label">Heart rate (HR)</div>
            <div class="vital-value" id="vHR">‚Äî</div>
          </div>
          <div class="vital-row">
            <div class="vital-label">Blood pressure (BP)</div>
            <div class="vital-value" id="vBP">‚Äî</div>
          </div>
          <div class="vital-row">
            <div class="vital-label">Key injury / problem</div>
            <div class="vital-value" id="vKeyInjury">‚Äî</div>
          </div>
        </div>

        <div class="timer">
          <div id="timerLabel">PATIENT LOADING ‚Ä¢ TRIAGE TIMER</div>
          <span class="time" id="timerDisplay">0.00 s</span>
        </div>
        <div style="margin-top:4px;font-size:12px;color:var(--muted);" id="timerHint">
          Scan all QR tags on the mannequin. The timer will start when you continue to triage.
        </div>
      </section>
    </div>

    <!-- BOTTOM ROW -->
    <div class="bottom-row">
      <!-- TRIAGE DECISION -->
      <section class="panel">
        <h2>Human Triage Decision</h2>
        <div class="triage-controls">
          <div class="triage-steps-label">Step 1 ‚Äî choose triage category</div>
          <div class="triage-circles">
            <div class="triage-circle" data-level="Red">
              <span>Red</span>
            </div>
            <div class="triage-circle" data-level="Yellow">
              <span>Yellow</span>
            </div>
            <div class="triage-circle" data-level="Green">
              <span>Green</span>
            </div>
            <div class="triage-circle" data-level="Black">
              <span>Black</span>
            </div>
          </div>

          <div class="hospital-tests">
            <div>
              <div class="triage-steps-label" style="margin-bottom:4px;">Step 2 ‚Äî choose receiving hospital</div>
              <div id="hospitalList"></div>
            </div>
            <div>
              <div class="triage-steps-label" style="margin-bottom:4px;">Step 3 ‚Äî choose ER tests</div>
              <div class="tests-list" id="testsList"></div>
            </div>
          </div>

          <div class="submit-row">
            <span id="decisionHint">Complete triage, hospital and ER tests after you move to triage and the timer starts.</span>
            <button class="btn-primary" id="submitDecisionBtn" disabled>Submit Decision</button>
          </div>
        </div>
      </section>

      <!-- RESULTS + LEADERBOARD -->
      <section class="panel">
        <h2>Human vs AI Results</h2>

        <table class="results-table">
          <thead>
          <tr>
            <th>Category</th>
            <th>Human</th>
            <th>AI</th>
            <th class="match-cell">Match</th>
          </tr>
          </thead>
          <tbody>
          <tr>
            <td>Triage</td>
            <td id="resHumanTriage">‚Äî</td>
            <td id="resAITriage">‚Äî</td>
            <td class="match-cell" id="matchTriage">‚Äî</td>
          </tr>
          <tr>
            <td>Hospital</td>
            <td id="resHumanHospital">‚Äî</td>
            <td id="resAIHospital">‚Äî</td>
            <td class="match-cell" id="matchHospital">‚Äî</td>
          </tr>
          <tr>
            <td>ER tests</td>
            <td id="resHumanTests">‚Äî</td>
            <td id="resAITests">‚Äî</td>
            <td class="match-cell" id="matchTests">‚Äî</td>
          </tr>
          <tr>
            <td>Time</td>
            <td id="resHumanTime">‚Äî</td>
            <td id="resAITime">‚Äî</td>
            <td class="match-cell" id="matchTime">‚Äî</td>
          </tr>
          </tbody>
        </table>

        <div class="score-summary" id="scoreSummary">
          Score: 0 / 12 points
        </div>

        <div class="leaderboard">
          <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:4px;">
            <div style="font-weight:600;">Live Leaderboard</div>
            <div style="display:flex;gap:6px;">
              <button class="btn-secondary btn-small" id="resetSimulationBtn">Reset simulation</button>
              <button class="btn-small btn-orange" id="resetLeaderboardBtn">Reset board</button>
            </div>
          </div>
          <table>
            <thead>
            <tr>
              <th>#</th>
              <th>Name</th>
              <th>Mode</th>
              <th>Scenario</th>
              <th>Score</th>
              <th>Time</th>
            </tr>
            </thead>
            <tbody id="leaderboardBody"></tbody>
          </table>
        </div>
      </section>
    </div>
  </main>
</div>

<script src="/socket.io/socket.io.js"></script>
<script>
  const socket = io();

  // ---- Scenario config ----
  const scenarios = [
    {
      id: "s1",
      label: "Scenario 1 ‚Äî Hajj Stampede (Red)",
      expectedSlots: ["id","conclevel","hr","rr","bp","injury1","injury2"],
      ai: {
        triage: "Red",
        hospital: "Mina Emergency Hospital",
        erTests: ["FAST ultrasound", "Serum lactate", "Blood typing and crossmatch"],
        timeSeconds: 1.2
      },
      bodyPartVitals: {
        id:       { vitalKey: "consciousness", value: "Unconscious, pale, shallow breathing" },
        conclevel:{ vitalKey: "consciousness", value: "Unconscious, pale, shallow breathing" },
        hr:       { vitalKey: "hr", value: "142 bpm" },
        rr:       { vitalKey: "rr", value: "34 / min" },
        bp:       { vitalKey: "bp", value: "78/45 mmHg" },
        injury1:  { vitalKey: "keyInjury", value: "Severe abdominal bleeding, suspected pelvic fracture" },
        injury2:  { vitalKey: "keyInjury", value: "Severe abdominal bleeding, suspected pelvic fracture" }
      },
      hospitals: [
        {
          name: "Mina Emergency Hospital",
          meta: "Closest high-emergency facility",
          testsAvailable: [
            "FAST ultrasound",
            "Serum lactate",
            "Blood typing and crossmatch",
            "Chest X-ray",
            "ECG"
          ]
        },
        {
          name: "King Fahad Medical City ‚Äî Trauma Centre",
          meta: "Level 1 trauma centre, Riyadh",
          testsAvailable: [
            "FAST ultrasound",
            "Serum lactate",
            "Blood typing and crossmatch",
            "CT scan",
            "ECG"
          ]
        },
        {
          name: "Dhahran Trauma Center",
          meta: "Highway critical care hub",
          testsAvailable: [
            "FAST ultrasound",
            "CT scan",
            "Serum lactate",
            "D-dimer"
          ]
        }
      ]
    },
    {
      id: "s2",
      label: "Scenario 2 ‚Äî Industrial Explosion (Yellow)",
      expectedSlots: ["id","conclevel","hr","rr","bp","injury1","injury2"],
      ai: {
        triage: "Yellow",
        hospital: "King Fahad Medical City ‚Äî Trauma Centre",
        erTests: ["Plain X-ray", "Carboxyhaemoglobin level (CO)", "Burn depth assessment"],
        timeSeconds: 1.4
      },
      bodyPartVitals: {
        id:       { vitalKey: "consciousness", value: "Alert but disoriented" },
        conclevel:{ vitalKey: "consciousness", value: "Alert but disoriented" },
        hr:       { vitalKey: "hr", value: "110 bpm" },
        rr:       { vitalKey: "rr", value: "26 / min" },
        bp:       { vitalKey: "bp", value: "100/70 mmHg" },
        injury1:  { vitalKey: "keyInjury", value: "Burns on arms and face, chest tightness" },
        injury2:  { vitalKey: "keyInjury", value: "Burns on arms and face, dizziness" }
      },
      hospitals: [
        {
          name: "King Fahad Medical City ‚Äî Trauma Centre",
          meta: "Level 1 trauma centre",
          testsAvailable: [
            "Plain X-ray",
            "Carboxyhaemoglobin level (CO)",
            "Burn depth assessment",
            "ECG",
            "FAST ultrasound"
          ]
        },
        {
          name: "Mina Emergency Hospital",
          meta: "Mass-casualty capable unit",
          testsAvailable: [
            "Plain X-ray",
            "Burn depth assessment",
            "ECG"
          ]
        },
        {
          name: "Dhahran Trauma Center",
          meta: "High-capacity burn and trauma",
          testsAvailable: [
            "Plain X-ray",
            "CT scan",
            "Burn depth assessment",
            "D-dimer"
          ]
        }
      ]
    },
    {
      id: "s3",
      label: "Scenario 3 ‚Äî Desert Rally (Green)",
      expectedSlots: ["id","conclevel","hr","rr","bp","injury1","injury2"],
      ai: {
        triage: "Green",
        hospital: "AlUla Field Medical Base",
        erTests: ["Plain X-ray", "Intravenous (IV) fluids", "FAST ultrasound"],
        timeSeconds: 1.5
      },
      bodyPartVitals: {
        id:       { vitalKey: "consciousness", value: "Walking, answering appropriately" },
        conclevel:{ vitalKey: "consciousness", value: "Walking, answering appropriately" },
        hr:       { vitalKey: "hr", value: "92 bpm" },
        rr:       { vitalKey: "rr", value: "18 / min" },
        bp:       { vitalKey: "bp", value: "118/78 mmHg" },
        injury1:  { vitalKey: "keyInjury", value: "Mild dehydration, heat stress" },
        injury2:  { vitalKey: "keyInjury", value: "Mild dehydration, heat stress" }
      },
      hospitals: [
        {
          name: "AlUla Field Medical Base",
          meta: "Desert response unit",
          testsAvailable: [
            "Plain X-ray",
            "Intravenous (IV) fluids",
            "FAST ultrasound",
            "Electrolyte panel"
          ]
        },
        {
          name: "King Fahad Medical City ‚Äî Trauma Centre",
          meta: "Definitive care (if required)",
          testsAvailable: [
            "Plain X-ray",
            "CT scan",
            "ECG",
            "FAST ultrasound"
          ]
        }
      ]
    },
    {
      id: "s4",
      label: "Scenario 4 ‚Äî Highway Collision (Black)",
      expectedSlots: ["id","conclevel","hr","rr","injury1","injury2"], // no BP
      ai: {
        triage: "Black",
        hospital: "Dhahran Trauma Center",
        erTests: ["FAST ultrasound", "CT scan", "Blood typing and crossmatch"],
        timeSeconds: 1.3
      },
      bodyPartVitals: {
        id:       { vitalKey: "consciousness", value: "Unresponsive, fixed dilated pupils" },
        conclevel:{ vitalKey: "consciousness", value: "Unresponsive, fixed dilated pupils" },
        hr:       { vitalKey: "hr", value: "No palpable pulse" },
        rr:       { vitalKey: "rr", value: "No respiratory effort" },
        injury1:  { vitalKey: "keyInjury", value: "Massive head and chest trauma" },
        injury2:  { vitalKey: "keyInjury", value: "Massive head and chest trauma" }
      },
      hospitals: [
        {
          name: "Dhahran Trauma Center",
          meta: "Highway critical care",
          testsAvailable: [
            "FAST ultrasound",
            "CT scan",
            "Blood typing and crossmatch",
            "Serum lactate"
          ]
        },
        {
          name: "King Fahad Medical City ‚Äî Trauma Centre",
          meta: "Level 1 trauma, tertiary review",
          testsAvailable: [
            "FAST ultrasound",
            "CT scan",
            "Serum lactate",
            "ECG"
          ]
        }
      ]
    }
  ];

  // silhouette mapping: slot -> layer index for normal scenarios
  const layerIndexNormal = {
    id: 0,
    conclevel: 1,
    hr: 2,
    rr: 3,
    bp: 4,
    injury1: 5,
    injury2: 6
  };

  const layerIndexS4 = { // no BP, 6 layers used
    id: 0,
    conclevel: 1,
    hr: 2,
    rr: 3,
    injury1: 4,
    injury2: 5
  };

  // ---- State ----
  let currentScenario = scenarios[0];
  let currentScenarioId = "s1";
  let scannedSlots = {};         // slot -> true
  let scanCount = 0;
  let phase = 1;                 // 1 = scanning, 2 = triage
  let triageTimerRunning = false;
  let triageStartMs = null;
  let triageFinalSeconds = null;
  let leaderboard = [];
  let currentOperator = { name: "Unknown", mode: "Solo" };

  const bodyRows = Array.from(document.querySelectorAll(".body-row"));
  const scenarioSelectEl = document.getElementById("scenarioSelect");
  const scanCountLabel = document.getElementById("scanCountLabel");
  const scanStatusText = document.getElementById("scanStatusText");
  const phaseLabel = document.getElementById("phaseLabel");
  const timerDisplayEl = document.getElementById("timerDisplay");
  const timerHintEl = document.getElementById("timerHint");
  const timerLabelEl = document.getElementById("timerLabel");
  const continueTriageBtn = document.getElementById("continueTriageBtn");

  const vConEl = document.getElementById("vConsciousness");
  const vRREl = document.getElementById("vRR");
  const vHREl = document.getElementById("vHR");
  const vBPEl = document.getElementById("vBP");
  const vKeyEl = document.getElementById("vKeyInjury");

  const triageCircles = Array.from(document.querySelectorAll(".triage-circle"));
  const hospitalListEl = document.getElementById("hospitalList");
  const testsListEl = document.getElementById("testsList");
  const submitDecisionBtn = document.getElementById("submitDecisionBtn");
  const decisionHintEl = document.getElementById("decisionHint");

  const resHumanTriage = document.getElementById("resHumanTriage");
  const resAITriage = document.getElementById("resAITriage");
  const resHumanHospital = document.getElementById("resHumanHospital");
  const resAIHospital = document.getElementById("resAIHospital");
  const resHumanTests = document.getElementById("resHumanTests");
  const resAITests = document.getElementById("resAITests");
  const resHumanTime = document.getElementById("resHumanTime");
  const resAITime = document.getElementById("resAITime");
  const matchTriage = document.getElementById("matchTriage");
  const matchHospital = document.getElementById("matchHospital");
  const matchTests = document.getElementById("matchTests");
  const matchTime = document.getElementById("matchTime");
  const scoreSummaryEl = document.getElementById("scoreSummary");
  const leaderboardBody = document.getElementById("leaderboardBody");
  const resetLeaderboardBtn = document.getElementById("resetLeaderboardBtn");
  const resetSimulationBtn = document.getElementById("resetSimulationBtn");
  const operatorLabelEl = document.getElementById("operatorLabel");

  const silhouetteLayersContainer = document.getElementById("silhouetteLayers");

  let selectedTriage = null;
  let selectedHospital = null;
  let selectedTests = new Set();

  // ---- Silhouette init ----
  const silhouetteLayers = [];
  for (let i = 0; i < 7; i++) {
    const layer = document.createElement("div");
    layer.className = "silhouette-layer";
    silhouetteLayersContainer.appendChild(layer);
    silhouetteLayers.push(layer);
  }

  function resetSilhouette() {
    silhouetteLayers.forEach(l => l.classList.remove("filled"));
  }

  function fillSilhouetteForSlot(slot) {
    const mapping = currentScenario.id === "s4" ? layerIndexS4 : layerIndexNormal;
    const index = mapping[slot];
    if (index === undefined || index < 0 || index >= silhouetteLayers.length) return;
    silhouetteLayers[index].classList.add("filled");
  }

  // ---- Scenario setup ----
  function populateScenarioDropdown() {
    scenarioSelectEl.innerHTML = "";
    scenarios.forEach((sc) => {
      const opt = document.createElement("option");
      opt.value = sc.id;
      opt.textContent = sc.label;
      scenarioSelectEl.appendChild(opt);
    });
  }

  function selectScenarioById(id) {
    const sc = scenarios.find(s => s.id === id) || scenarios[0];
    currentScenario = sc;
    currentScenarioId = sc.id;
    scenarioSelectEl.value = sc.id;
    resetSimulation(true);
  }

  scenarioSelectEl.addEventListener("change", () => {
    selectScenarioById(scenarioSelectEl.value);
  });

  // ---- Vitals ----
  let vitalsState = { consciousness:null, rr:null, hr:null, bp:null, keyInjury:null };

  function updateVitalsDisplay() {
    vConEl.textContent = vitalsState.consciousness || "‚Äî";
    vRREl.textContent = vitalsState.rr || "‚Äî";
    vHREl.textContent = vitalsState.hr || "‚Äî";
    vBPEl.textContent = vitalsState.bp || "‚Äî";
    vKeyEl.textContent = vitalsState.keyInjury || "‚Äî";
  }

  // ---- Timer (triage phase) ----
  function startTriageTimer() {
    triageTimerRunning = true;
    triageStartMs = performance.now();
    triageFinalSeconds = null;
    timerLabelEl.textContent = "TRIAGE TIMER ‚Ä¢ HUMAN DECISION";
    timerHintEl.textContent = "Timer running‚Ä¶ choose triage, hospital and ER tests, then submit.";
    requestAnimationFrame(updateTimerLoop);
  }

  function updateTimerLoop() {
    if (!triageTimerRunning) return;
    const now = performance.now();
    const elapsedMs = now - triageStartMs;
    const seconds = Math.floor(elapsedMs / 1000);
    const centis = Math.floor((elapsedMs % 1000) / 10);
    timerDisplayEl.textContent = `${seconds}.${String(centis).padStart(2, "0")} s`;
    requestAnimationFrame(updateTimerLoop);
  }

  function stopTriageTimer() {
    if (!triageTimerRunning) return;
    const now = performance.now();
    const elapsedMs = now - triageStartMs;
    triageFinalSeconds = elapsedMs / 1000;
    triageTimerRunning = false;
    const seconds = Math.floor(elapsedMs / 1000);
    const centis = Math.floor((elapsedMs % 1000) / 10);
    timerDisplayEl.textContent = `${seconds}.${String(centis).padStart(2, "0")} s (final)`;
    timerHintEl.textContent = "Triage decision submitted. Compare with AI results.";
  }

  // ---- QR parsing ----
  function parseScanFromUrl(url) {
    const lower = url.toLowerCase();
    const match = lower.match(/s([1-4])_/);
    if (!match) return null;
    const scenarioId = "s" + match[1];

    let slot = null;
    if (lower.includes("_id")) slot = "id";
    else if (lower.includes("conclevel")) slot = "conclevel";
    else if (lower.includes("_hr")) slot = "hr";
    else if (lower.includes("_bp")) slot = "bp";
    else if (lower.includes("_rr")) slot = "rr";
    else if (lower.includes("injury1")) slot = "injury1";
    else if (lower.includes("injury2")) slot = "injury2";

    if (!slot) return null;
    return { scenarioId, slot, url };
  }

  function expectedSlotCount() {
    return currentScenario.expectedSlots.length;
  }

  function updateScanUI() {
    scanCountLabel.textContent = `Scans: ${scanCount} / ${expectedSlotCount()}`;
    if (scanCount === 0) {
      scanStatusText.textContent = "Waiting for first QR scan‚Ä¶";
    } else if (scanCount < expectedSlotCount()) {
      scanStatusText.textContent = `Scans received: ${scanCount}. Keep scanning head to toe.`;
    } else {
      scanStatusText.textContent = "All scans done. Press Continue to triage.";
    }
    continueTriageBtn.disabled = !(scanCount === expectedSlotCount());
  }

  function resetScanState() {
    scannedSlots = {};
    scanCount = 0;
    bodyRows.forEach(row => {
      row.dataset.state = "waiting";
      const status = row.querySelector("[data-status]");
      status.textContent = "Waiting for scan‚Ä¶";
    });
    updateScanUI();
    resetSilhouette();
  }

  // ---- Socket handlers ----
  socket.on("operator-joined", ({ name, mode }) => {
    currentOperator = { name, mode };
    operatorLabelEl.innerHTML = `Operator: <span class="glow">${name || "Unknown"}</span> (${mode || "Solo"})`;
  });

  socket.on("qr-scanned", ({ url }) => {
    if (phase !== 1) return; // ignore scans during triage
    const parsed = parseScanFromUrl(url);
    if (!parsed) return;
    if (parsed.scenarioId !== currentScenarioId) return;

    const slot = parsed.slot;
    if (!currentScenario.expectedSlots.includes(slot)) return;
    if (scannedSlots[slot]) return; // already scanned

    scannedSlots[slot] = true;
    scanCount++;

    // update row
    const row = bodyRows.find(r => r.dataset.slot === slot);
    if (row) {
      row.dataset.state = "scanned";
      const status = row.querySelector("[data-status]");
      status.textContent = "Scan received";
    }

    // vitals for this scenario + slot
    const mapping = currentScenario.bodyPartVitals[slot];
    if (mapping) {
      const { vitalKey, value } = mapping;
      if (vitalsState.hasOwnProperty(vitalKey)) {
        vitalsState[vitalKey] = value;
      }
      updateVitalsDisplay();
    }

    // silhouette
    fillSilhouetteForSlot(slot);

    updateScanUI();
  });

  // ---- Phase control ----
  continueTriageBtn.addEventListener("click", () => {
    if (scanCount !== expectedSlotCount()) return;
    phase = 2;
    phaseLabel.innerHTML = '<span class="label">Phase 2:</span> Human triage decision';
    startTriageTimer();
    updateSubmitState();
  });

  // ---- Triage UI ----
  triageCircles.forEach(circle => {
    circle.addEventListener("click", () => {
      triageCircles.forEach(c => c.classList.remove("selected"));
      circle.classList.add("selected");
      selectedTriage = circle.dataset.level;
      updateSubmitState();
    });
  });

  function renderHospitalsAndTests() {
    // hospitals
    hospitalListEl.innerHTML = "";
    currentScenario.hospitals.forEach(h => {
      const card = document.createElement("div");
      card.className = "hospital-card";
      card.dataset.name = h.name;
      card.innerHTML = `
        <div class="hospital-name">${h.name}</div>
        <div class="hospital-meta">${h.meta}</div>
      `;
      card.addEventListener("click", () => {
        selectedHospital = h.name;
        Array.from(hospitalListEl.children).forEach(c => c.classList.remove("selected"));
        card.classList.add("selected");
        renderTests(h.testsAvailable);
        updateSubmitState();
      });
      hospitalListEl.appendChild(card);
    });

    // default to first hospital
    const first = currentScenario.hospitals[0];
    if (first) {
      selectedHospital = first.name;
      const firstCard = hospitalListEl.querySelector(`[data-name="${first.name}"]`);
      if (firstCard) firstCard.classList.add("selected");
      renderTests(first.testsAvailable);
    } else {
      testsListEl.innerHTML = "<div style='font-size:12px;color:var(--muted);'>No ER tests configured.</div>";
    }
  }

  function renderTests(list) {
    testsListEl.innerHTML = "";
    selectedTests = new Set();
    list.forEach(testName => {
      const row = document.createElement("label");
      row.className = "test-row";
      row.innerHTML = `<input type="checkbox" value="${testName}">
                       <span>${testName}</span>`;
      const checkbox = row.querySelector("input");
      checkbox.addEventListener("change", () => {
        if (checkbox.checked) selectedTests.add(testName);
        else selectedTests.delete(testName);
        updateSubmitState();
      });
      testsListEl.appendChild(row);
    });
  }

  function resetDecision() {
    selectedTriage = null;
    selectedHospital = null;
    selectedTests = new Set();
    triageCircles.forEach(c => c.classList.remove("selected"));
    decisionHintEl.textContent = "Complete triage, hospital and ER tests after you move to triage and the timer starts.";
    submitDecisionBtn.disabled = true;
    renderHospitalsAndTests();
  }

  function clearResultsOnly() {
    resHumanTriage.textContent = "‚Äî";
    resAITriage.textContent = "‚Äî";
    resHumanHospital.textContent = "‚Äî";
    resAIHospital.textContent = "‚Äî";
    resHumanTests.textContent = "‚Äî";
    resAITests.textContent = "‚Äî";
    resHumanTime.textContent = "‚Äî";
    resAITime.textContent = "‚Äî";
    [matchTriage,matchHospital,matchTests,matchTime].forEach(el => { el.textContent = "‚Äî"; el.className="match-cell"; });
    scoreSummaryEl.textContent = "Score: 0 / 12 points";
  }

  function updateSubmitState() {
    const coreReady = selectedTriage && selectedHospital && selectedTests.size > 0;
    const phaseReady = (phase === 2);
    const ready = coreReady && phaseReady;
    submitDecisionBtn.disabled = !ready;
    decisionHintEl.textContent = ready
      ? "Ready to submit. Compare your plan with the AI."
      : "Complete triage, hospital and ER tests after you move to triage and the timer starts.";
  }

  submitDecisionBtn.addEventListener("click", () => {
    if (submitDecisionBtn.disabled) return;
    if (triageTimerRunning) stopTriageTimer();
    const human = {
      triage: selectedTriage,
      hospital: selectedHospital,
      tests: Array.from(selectedTests),
      timeSeconds: triageFinalSeconds ?? 0
    };
    showResults(human);
    addToLeaderboard(human);
    socket.emit("triage-submitted", {
      operator: currentOperator,
      human,
      scenarioId: currentScenario.id
    });
  });

  // ---- Scoring ----
  function markMatch(cell, ok) {
    cell.className = "match-cell " + (ok ? "match-yes" : "match-no");
    cell.textContent = ok ? "‚úÖ" : "‚ùå";
  }

  function showResults(human) {
    const ai = currentScenario.ai;
    resHumanTriage.textContent = human.triage;
    resAITriage.textContent = ai.triage;
    resHumanHospital.textContent = human.hospital;
    resAIHospital.textContent = ai.hospital;
    resHumanTests.textContent = human.tests.join(", ");
    resAITests.textContent = ai.erTests.join(", ");

    const tHuman = human.timeSeconds ?? 0;
    resHumanTime.textContent = `${tHuman.toFixed(2)} s`;
    resAITime.textContent = `${ai.timeSeconds.toFixed(2)} s`;

    let score = 0;

    const triageMatch = human.triage === ai.triage;
    markMatch(matchTriage, triageMatch);
    if (triageMatch) score += 5;

    const hospMatch = human.hospital === ai.hospital;
    markMatch(matchHospital, hospMatch);
    if (hospMatch) score += 3;

    const aiSet = new Set(ai.erTests);
    const humanSet = new Set(human.tests);
    const testsMatch = ai.erTests.length === human.tests.length &&
      ai.erTests.every(t => humanSet.has(t));
    markMatch(matchTests, testsMatch);
    if (testsMatch) score += 2;

    const faster = human.timeSeconds && human.timeSeconds < ai.timeSeconds;
    markMatch(matchTime, faster);
    if (faster) score += 2;

    scoreSummaryEl.textContent = `Score: ${score} / 12 points`;
  }

  function addToLeaderboard(human) {
    const scoreText = scoreSummaryEl.textContent;
    const scoreMatch = /Score:\s+(\d+)\s+\/\s+12/.exec(scoreText);
    const score = scoreMatch ? parseInt(scoreMatch[1], 10) : 0;

    leaderboard.push({
      name: currentOperator.name || "Unknown",
      mode: currentOperator.mode || "Solo",
      scenario: currentScenario.label,
      score,
      time: human.timeSeconds ?? 0
    });

    leaderboard.sort((a,b) => {
      if (b.score !== a.score) return b.score - a.score;
      return a.time - b.time;
    });

    renderLeaderboard();
  }

  function renderLeaderboard() {
    leaderboardBody.innerHTML = "";
    leaderboard.forEach((entry, idx) => {
      const tr = document.createElement("tr");
      tr.innerHTML = `<td>${idx+1}</td>
                      <td>${entry.name}</td>
                      <td>${entry.mode}</td>
                      <td>${entry.scenario}</td>
                      <td>${entry.score}</td>
                      <td>${entry.time.toFixed(2)} s</td>`;
      leaderboardBody.appendChild(tr);
    });
  }

  resetLeaderboardBtn.addEventListener("click", () => {
    leaderboard = [];
    renderLeaderboard();
    socket.emit("reset-leaderboard");
  });

  socket.on("reset-leaderboard", () => {
    leaderboard = [];
    renderLeaderboard();
  });

  // ---- Reset simulation ----
  function resetSimulation(keepScenario=false) {
    phase = 1;
    phaseLabel.innerHTML = '<span class="label">Phase 1:</span> Drone scanning';
    triageTimerRunning = false;
    triageStartMs = null;
    triageFinalSeconds = null;
    timerLabelEl.textContent = "PATIENT LOADING ‚Ä¢ TRIAGE TIMER";
    timerDisplayEl.textContent = "0.00 s";
    timerHintEl.textContent = "Scan all QR tags on the mannequin. The timer will start when you continue to triage.";

    vitalsState = { consciousness:null, rr:null, hr:null, bp:null, keyInjury:null };
    updateVitalsDisplay();

    resetScanState();
    resetDecision();
    clearResultsOnly();
  }

  resetSimulationBtn.addEventListener("click", () => resetSimulation(false));

  // When another screen submits, just show them on leaderboard
  socket.on("triage-submitted", ({ operator, human, scenarioId }) => {
    if (!human || !operator) return;
    const sc = scenarios.find(s => s.id === scenarioId);
    if (!sc) return;
    const score = 0;
    leaderboard.push({
      name: operator.name || "Unknown",
      mode: operator.mode || "Solo",
      scenario: sc.label,
      score,
      time: human.timeSeconds ?? 0
    });
    leaderboard.sort((a,b)=> (b.score !== a.score ? b.score-a.score : a.time-b.time));
    renderLeaderboard();
  });

  // ---- Initial setup ----
  populateScenarioDropdown();
  selectScenarioById("s1");
</script>
</body>
</html>
