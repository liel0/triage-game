<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Emergency Drone Simulation ‚Äì Big Screen</title>
  <script src="/socket.io/socket.io.js"></script>
  <!-- QR code generator for team certificate -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>

  <style>
    body {
      font-family: system-ui, sans-serif;
      background: #020617;
      color: #e5e7eb;
      margin: 0;
      padding: 20px;
    }

    h1, h2, h3 { margin: 0.4rem 0; }

    .row {
      display: flex;
      gap: 20px;
      margin-top: 20px;
      flex-wrap: wrap;
    }

    .card {
      flex: 1;
      min-width: 320px;
      background: #0f172a;
      border-radius: 12px;
      padding: 16px;
      box-shadow: 0 0 20px rgba(15, 23, 42, 0.7);
    }

    .label {
      font-size: 0.8rem;
      text-transform: uppercase;
      color: #9ca3af;
      letter-spacing: 0.08em;
    }

    .value {
      font-size: 1rem;
      margin-bottom: 0.4rem;
    }

    .vital { margin-bottom: 0.4rem; }

    .timer-seconds {
      font-size: 2rem;
      font-weight: 700;
    }

    .timer-ms {
      font-size: 1.2rem;
      font-weight: 500;
      opacity: 0.9;
    }

    button {
      padding: 8px 16px;
      border-radius: 999px;
      border: none;
      cursor: pointer;
      margin-top: 8px;
      margin-right: 6px;
    }

    button.primary { background: #2563eb; color: white; }
    button.danger { background: #b91c1c; color: white; }

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.9rem;
      margin-top: 8px;
    }

    th, td {
      border-bottom: 1px solid #1f2937;
      padding: 6px 4px;
      text-align: left;
    }

    .small { font-size: 0.8rem; color: #9ca3af; }

    #certificateQr {
      margin-top: 10px;
    }

    #achievementsList li {
      margin-bottom: 4px;
    }
  </style>
</head>

<body>
  <h1>üö® Emergency Drone Simulation ‚Äì Human vs AI Triage</h1>
  <p class="small">
    Players scan QR codes on the mannequins ‚Üí vitals appear here ‚Üí humans race the AI.
  </p>

  <div class="row">
    <!-- CURRENT GAME -->
    <div class="card">
      <div class="label">Current Team</div>
      <div class="value" id="teamInfo">Waiting for player...</div>

      <div class="label">Patient</div>
      <div class="value" id="patientInfo">‚Äì</div>
      <div class="small" id="patientNarrative"></div>

      <div class="label" style="margin-top: 10px;">Vitals (collected)</div>
      <div id="vitalsList">
        <span class="small">No vitals scanned yet.</span>
      </div>

      <div id="timerDisplay" style="margin-top: 10px;">Timer: --</div>
      <div class="small" id="infoMessage"></div>

      <button class="danger" id="resetBtn">Reset Simulation</button>
      <button class="danger" id="resetLeaderboardBtn">Reset Leaderboard</button>
    </div>

    <!-- TRIAGE CONTROL -->
    <div class="card">
      <h2>üß© Human Triage</h2>

      <div class="label">Triage Category</div>
      <select id="triageSelect">
        <option value="">Select...</option>
        <option value="Red">üî¥ Red</option>
        <option value="Yellow">üü° Yellow</option>
        <option value="Green">üü¢ Green</option>
        <option value="Black">‚ö´ Black</option>
      </select>

      <div class="label" style="margin-top: 10px;">ER Tests</div>
      <label class="small"><input type="checkbox" class="testCheckbox" value="IV Fluids"> IV Fluids</label><br>
      <label class="small"><input type="checkbox" class="testCheckbox" value="X-ray"> X-ray</label><br>
      <label class="small"><input type="checkbox" class="testCheckbox" value="Oxygen"> Oxygen</label><br>
      <label class="small"><input type="checkbox" class="testCheckbox" value="CT Scan"> CT Scan</label><br>

      <div class="label" style="margin-top: 10px;">Primary Treatment</div>
      <select id="primarySelect">
        <option value="">Select...</option>
        <option value="Rapid IV Fluids + Oxygen">Rapid IV Fluids + Oxygen</option>
        <option value="Analgesia, basic monitoring">Analgesia, basic monitoring</option>
        <option value="RICE (rest, ice, compression, elevation)">RICE (rest, ice, compression, elevation)</option>
        <option value="Immediate high-quality CPR">Immediate high-quality CPR</option>
      </select>

      <div class="label" style="margin-top: 10px;">Secondary Treatment</div>
      <select id="secondarySelect">
        <option value="">Select...</option>
        <option value="Blood transfusion, analgesia">Blood transfusion, analgesia</option>
        <option value="Chest X-ray, repeat vitals">Chest X-ray, repeat vitals</option>
        <option value="Simple analgesia">Simple analgesia</option>
        <option value="Defibrillation / ACLS algorithm">Defibrillation / ACLS algorithm</option>
      </select>

      <div class="label" style="margin-top: 10px;">Disposition</div>
      <select id="dispositionSelect">
        <option value="">Select...</option>
        <option value="Emergency OR">Emergency OR</option>
        <option value="Observation ward">Observation ward</option>
        <option value="Discharge">Discharge</option>
        <option value="Resuscitation bay / consider termination per protocol">
          Resuscitation bay / consider termination per protocol
        </option>
      </select>

      <div class="label" style="margin-top: 10px;">Overall Treatment Tag</div>
      <select id="treatmentSelect">
        <option value="">Select...</option>
        <option value="Emergency Surgery">Emergency Surgery</option>
        <option value="Observation">Observation</option>
        <option value="Discharge with analgesia">Discharge with analgesia</option>
        <option value="CPR / ACLS as appropriate">CPR / ACLS as appropriate</option>
      </select>

      <button class="primary" id="submitDecisionBtn">Submit Decision</button>
      <div class="small" id="submitStatus"></div>
    </div>
  </div>

  <div class="row">
    <!-- RESULTS -->
    <div class="card">
      <h2>ü§ñ Human vs AI Results</h2>
      <table>
        <thead>
          <tr>
            <th>Category</th>
            <th>Human</th>
            <th>AI</th>
            <th>Match</th>
          </tr>
        </thead>
        <tbody id="resultsTableBody"></tbody>
      </table>

      <div class="label" style="margin-top: 10px;">Score</div>
      <div class="value" id="scoreDisplay">‚Äì</div>

      <div class="small" id="scoreBreakdown"></div>

      <h3 style="margin-top: 10px;">üß† Why the AI chose this plan</h3>
      <div class="small" id="explanationBox">
        <p><strong>Triage:</strong> <span id="explainTriage">‚Äì</span></p>
        <p><strong>Tests:</strong> <span id="explainTests">‚Äì</span></p>
        <p><strong>Treatment:</strong> <span id="explainTreatment">‚Äì</span></p>
      </div>

      <h3 style="margin-top: 10px;">üèÖ Achievements</h3>
      <ul id="achievementsList" class="small"></ul>

      <h3 style="margin-top: 10px;">üì∏ Team Certificate QR</h3>
      <p class="small">Scan this on a phone to open your digital certificate and take a team photo.</p>
      <div id="certificateQr"></div>
    </div>

    <!-- LEADERBOARD -->
    <div class="card">
      <h2>üèÜ Leaderboard</h2>
      <table>
        <thead>
          <tr>
            <th>#</th>
            <th>Team</th>
            <th>Mode</th>
            <th>Points</th>
            <th>Time (s)</th>
          </tr>
        </thead>
        <tbody id="leaderboardBody"></tbody>
      </table>
    </div>
  </div>

  <script>
    const socket = io();

    let currentGame = null;

    const teamInfoEl = document.getElementById("teamInfo");
    const patientInfoEl = document.getElementById("patientInfo");
    const patientNarrativeEl = document.getElementById("patientNarrative");
    const vitalsListEl = document.getElementById("vitalsList");
    const timerDisplayEl = document.getElementById("timerDisplay");
    const infoMessageEl = document.getElementById("infoMessage");
    const submitStatusEl = document.getElementById("submitStatus");
    const resultsTableBody = document.getElementById("resultsTableBody");
    const scoreDisplayEl = document.getElementById("scoreDisplay");
    const scoreBreakdownEl = document.getElementById("scoreBreakdown");
    const leaderboardBody = document.getElementById("leaderboardBody");
    const explainTriageEl = document.getElementById("explainTriage");
    const explainTestsEl = document.getElementById("explainTests");
    const explainTreatmentEl = document.getElementById("explainTreatment");
    const achievementsListEl = document.getElementById("achievementsList");
    const certificateQrEl = document.getElementById("certificateQr");

    const triageSelect = document.getElementById("triageSelect");
    const treatmentSelect = document.getElementById("treatmentSelect");
    const primarySelect = document.getElementById("primarySelect");
    const secondarySelect = document.getElementById("secondarySelect");
    const dispositionSelect = document.getElementById("dispositionSelect");
    const testCheckboxes = document.querySelectorAll(".testCheckbox");

    let timerInterval = null;
    let timerStart = null;
    let certificateQrInstance = null;

    // TIMER
    function startTimer(durationSeconds) {
      timerStart = performance.now();
      const endTime = timerStart + durationSeconds * 1000;

      if (timerInterval) clearInterval(timerInterval);

      timerInterval = setInterval(() => {
        const now = performance.now();
        let remaining = endTime - now;

        if (remaining <= 0) {
          remaining = 0;
          clearInterval(timerInterval);
          timerInterval = null;
        }

        const totalSeconds = remaining / 1000;
        const formatted = totalSeconds.toFixed(2);
        const [sec, ms] = formatted.split(".");

        timerDisplayEl.innerHTML =
          `<span class="timer-seconds">${sec}</span>` +
          `<span class="timer-ms">.${ms}</span> s`;
      }, 16);
    }

    function stopTimerAndFreeze() {
      if (timerInterval) {
        clearInterval(timerInterval);
        timerInterval = null;
      }

      if (timerStart !== null) {
        const elapsedSec = (performance.now() - timerStart) / 1000;
        const formatted = elapsedSec.toFixed(2);
        const [sec, ms] = formatted.split(".");

        timerDisplayEl.innerHTML =
          `<span class="timer-seconds">${sec}</span>` +
          `<span class="timer-ms">.${ms}</span> s (final)`;
      }
    }

    function resetTimerDisplay() {
      if (timerInterval) clearInterval(timerInterval);
      timerInterval = null;
      timerStart = null;
      timerDisplayEl.textContent = "Timer: --";
    }

    // STATE UPDATE
    socket.on("stateUpdate", (data) => {
      currentGame = data.currentGame || null;

      // Render leaderboard
      leaderboardBody.innerHTML = "";
      (data.leaderboard || []).forEach((entry, i) => {
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${i + 1}</td>
          <td>${entry.playerName}</td>
          <td>${entry.mode}</td>
          <td>${entry.points}</td>
          <td>${entry.timeSeconds.toFixed(2)}</td>
        `;
        leaderboardBody.appendChild(tr);
      });

      if (!currentGame) {
        teamInfoEl.textContent = "Waiting for player...";
        patientInfoEl.textContent = "‚Äì";
        patientNarrativeEl.textContent = "";
        vitalsListEl.innerHTML = "<span class='small'>No vitals scanned yet.</span>";
        resetTimerDisplay();
        return;
      }

      teamInfoEl.textContent = currentGame.playerName;
      patientInfoEl.textContent = currentGame.patientName;
      patientNarrativeEl.textContent = currentGame.patientNarrative || "";
    });

    // VITALS ‚Äì no duplicates
    socket.on("vitalScanned", (payload) => {
      if (
        vitalsListEl.firstChild &&
        vitalsListEl.firstChild.classList &&
        vitalsListEl.firstChild.classList.contains("small")
      ) {
        vitalsListEl.innerHTML = "";
      }

      let line = vitalsListEl.querySelector(`.vital[data-key="${payload.vitalKey}"]`);

      if (!line) {
        line = document.createElement("div");
        line.className = "vital";
        line.dataset.key = payload.vitalKey;
        vitalsListEl.appendChild(line);
      }

      line.textContent = `${payload.vitalKey}: ${payload.vitalValue}`;
    });

    socket.on("allVitalsCollected", (payload) => {
      infoMessageEl.textContent =
        "üö® Vitals complete! Make your triage decision!";
      startTimer(payload.triageTimerSeconds || 60);
    });

    // RESULTS
    socket.on("resultsReady", (result) => {
      stopTimerAndFreeze();

      resultsTableBody.innerHTML = "";
      const rows = [
        { category: "Triage", human: result.human.triage, ai: result.ai.triage },
        {
          category: "Tests",
          human: result.human.tests.join(", ") || "None",
          ai: result.ai.tests.join(", ") || "None"
        },
        {
          category: "Treatment Tag",
          human: result.human.treatment,
          ai: result.ai.treatment
        },
        {
          category: "Treatment Plan (Primary / Secondary / Disposition)",
          human: `${result.human.treatmentSteps.primary || "‚Äì"} / ${result.human.treatmentSteps.secondary || "‚Äì"} / ${result.human.treatmentSteps.disposition || "‚Äì"}`,
          ai: `${result.ai.treatmentSteps.primary} / ${result.ai.treatmentSteps.secondary} / ${result.ai.treatmentSteps.disposition}`
        },
        {
          category: "Time",
          human: `${result.human.timeSeconds.toFixed(2)} s`,
          ai: `${result.ai.aiTimeSeconds.toFixed(2)} s`
        }
      ];

      rows.forEach(r => {
        const tr = document.createElement("tr");
        let match = "‚Äì";

        if (r.category === "Triage" || r.category === "Treatment Tag" || r.category === "Tests") {
          match = r.human === r.ai ? "‚úÖ" : "‚ùå";
        } else if (r.category.startsWith("Treatment Plan")) {
          match =
            r.human === r.ai ? "‚úÖ" : "‚ùå";
        } else if (r.category === "Time") {
          match =
            parseFloat(result.human.timeSeconds) < parseFloat(result.ai.aiTimeSeconds)
              ? "‚ö°"
              : "‚è±";
        }

        tr.innerHTML = `
          <td>${r.category}</td>
          <td>${r.human}</td>
          <td>${r.ai}</td>
          <td>${match}</td>
        `;
        resultsTableBody.appendChild(tr);
      });

      const bd = result.scoreBreakdown;
      scoreDisplayEl.textContent = `${bd.total} / 12 points`;
      scoreBreakdownEl.innerHTML = `
        +${bd.triage} Triage &nbsp; | 
        +${bd.treatment} Treatment tag &nbsp; | 
        +${bd.tests} Tests &nbsp; | 
        +${bd.fasterThanAI} Faster than AI &nbsp; | 
        +${bd.under30} Under 30 s
      `;

      // Explanations
      explainTriageEl.textContent = result.explanations.triage;
      explainTestsEl.textContent = result.explanations.tests;
      explainTreatmentEl.textContent = result.explanations.treatment;

      // Achievements
      achievementsListEl.innerHTML = "";
      (result.achievements || []).forEach(a => {
        const li = document.createElement("li");
        li.textContent = a;
        achievementsListEl.appendChild(li);
      });

      // Certificate QR
      const certificateUrl =
        `${window.location.origin}/certificate.html` +
        `?team=${encodeURIComponent(result.playerName)}` +
        `&score=${encodeURIComponent(bd.total)}` +
        `&time=${encodeURIComponent(result.human.timeSeconds.toFixed(2))}` +
        `&patient=${encodeURIComponent(result.patientName)}`;

      certificateQrEl.innerHTML = "";
      certificateQrInstance = new QRCode(certificateQrEl, {
        text: certificateUrl,
        width: 120,
        height: 120
      });
    });

    // BUTTONS
    document.getElementById("resetBtn").onclick = () => {
      socket.emit("resetGame");
      resetTimerDisplay();
      vitalsListEl.innerHTML = "<span class='small'>No vitals scanned yet.</span>";
      resultsTableBody.innerHTML = "";
      scoreDisplayEl.textContent = "‚Äì";
      scoreBreakdownEl.textContent = "";
      explainTriageEl.textContent = "‚Äì";
      explainTestsEl.textContent = "‚Äì";
      explainTreatmentEl.textContent = "‚Äì";
      achievementsListEl.innerHTML = "";
      certificateQrEl.innerHTML = "";
    };

    document.getElementById("resetLeaderboardBtn").onclick = () => {
      socket.emit("resetLeaderboard");
    };

    document.getElementById("submitDecisionBtn").onclick = () => {
      const triage = triageSelect.value;
      const treatment = treatmentSelect.value;

      const tests = Array.from(testCheckboxes)
        .filter(c => c.checked)
        .map(c => c.value);

      const treatmentSteps = {
        primary: primarySelect.value || "",
        secondary: secondarySelect.value || "",
        disposition: dispositionSelect.value || ""
      };

      if (!triage || !treatment) {
        submitStatusEl.textContent = "Please select triage and overall treatment tag.";
        return;
      }

      socket.emit("submitHumanDecision", {
        triage,
        tests,
        treatment,
        treatmentSteps
      });

      submitStatusEl.textContent = "Decision sent. Comparing with AI...";
    };
  </script>
</body>
</html>
