<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>AI Triage Drone 2040 ‚Äì Control Screen</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    :root {
      --bg: #020617;
      --panel: #020617;
      --accent: #38bdf8;          /* cyan */
      --accent-soft: rgba(56, 189, 248, 0.18);
      --danger: #f97373;
      --warning: #facc15;
      --success: #4ade80;
      --muted: #9ca3af;
      --muted-strong: #cbd5f5;
      --text: #e5e7eb;
      --text-strong: #f9fafb;
      --card-radius: 18px;
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: radial-gradient(circle at top, #020617 0, #000 70%);
      color: var(--text);
      overflow: hidden;
    }

    .root {
      display: flex;
      flex-direction: column;
      height: 100vh;
      width: 100vw;
      padding: 12px 18px;
      gap: 10px;
    }

    header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 6px 14px;
      border-radius: 999px;
      background: linear-gradient(90deg, #020617, #020617);
      border: 1px solid rgba(148, 163, 184, 0.35);
      font-size: 14px;
    }

    header .title {
      display: flex;
      align-items: center;
      gap: 10px;
      font-size: 18px;
      font-weight: 700;
      color: var(--text-strong);
    }

    header .title span {
      font-size: 22px;
    }

    header .subtitle {
      font-size: 12px;
      color: var(--muted);
      font-weight: 500;
    }

    header .operator {
      font-size: 13px;
      color: var(--muted);
      font-weight: 600;
    }

    header .operator strong {
      color: var(--accent);
    }

    main {
      flex: 1;
      display: flex;
      flex-direction: column;
      gap: 8px;
      min-height: 0;
    }

    /* Global timer bar visible across all screens */

    .timer-global {
      padding: 8px 14px;
      border-radius: 999px;
      background: rgba(15, 23, 42, 0.96);
      border: 1px solid rgba(148, 163, 184, 0.6);
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 13px;
      font-weight: 600;
      color: var(--muted);
      box-shadow: 0 12px 30px rgba(15, 23, 42, 0.8);
    }

    .timer-global-label {
      text-transform: uppercase;
      letter-spacing: 0.08em;
      font-size: 11px;
      color: var(--muted-strong);
    }

    .timer-global span.time {
      font-weight: 800;
      font-size: 20px;
      color: var(--accent);
      text-shadow: 0 0 18px rgba(56, 189, 248, 0.8);
    }

    .timer-global-sub {
      font-size: 11px;
      color: var(--muted);
      margin-top: 2px;
    }

    .timer-global-sub span {
      color: var(--accent);
      font-weight: 600;
    }

    /* Screens */

    .screen {
      flex: 1;
      display: none;
      min-height: 0;
    }

    .screen.active {
      display: flex;
    }

    .screen-column {
      display: flex;
      flex-direction: column;
      gap: 10px;
      width: 100%;
      min-height: 0;
    }

    /* Panels */

    .panel {
      background: radial-gradient(circle at top left, #020617 0, #020617 55%);
      border-radius: var(--card-radius);
      border: 1px solid rgba(148, 163, 184, 0.35);
      padding: 14px 16px;
      box-shadow: 0 16px 40px rgba(15, 23, 42, 0.9);
      min-height: 0;
      overflow: hidden;
      color: var(--text);
    }

    .panel h2 {
      font-size: 18px;
      font-weight: 700;
      margin-bottom: 10px;
      display: flex;
      align-items: center;
      gap: 8px;
      color: var(--text-strong);
    }

    .panel h2::before {
      content: "";
      width: 6px;
      height: 18px;
      border-radius: 999px;
      background: linear-gradient(180deg, #38bdf8, #22c55e);
    }

    /* SCREEN 1 LAYOUT */

    .screen1-layout {
      display: grid;
      grid-template-columns: 55% 45%;
      gap: 10px;
      width: 100%;
      height: 100%;
      min-height: 0;
    }

    .scan-layout {
      display: grid;
      grid-template-columns: 55% 45%;
      gap: 12px;
      height: calc(100% - 40px);
      min-height: 0;
    }

    .scenario-select {
      width: 100%;
      margin-top: 4px;
      margin-bottom: 10px;
    }

    .scenario-select label {
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      color: var(--muted);
      font-weight: 600;
      margin-bottom: 4px;
      display: block;
    }

    .scenario-select select {
      width: 100%;
      padding: 8px 10px;
      border-radius: 999px;
      border: 1px solid rgba(148, 163, 184, 0.7);
      background: #020617;
      color: var(--accent);
      font-size: 14px;
      outline: none;
      font-weight: 600;
    }

    .scan-list {
      display: flex;
      flex-direction: column;
      gap: 8px;
      min-height: 0;
      max-width: 540px;
    }

    .scan-row {
      border-radius: 16px;
      padding: 8px 10px;
      border: 1px solid rgba(148, 163, 184, 0.45);
      background: rgba(15, 23, 42, 0.95);
      display: flex;
      flex-direction: column;
      gap: 2px;
      font-size: 13px;
      position: relative;
      overflow: hidden;
      color: var(--text);
      cursor: pointer; /* click to simulate scan */
    }

    .scan-row .scan-label {
      font-weight: 600;
      color: #e0f2fe;
    }

    .scan-row .scan-label span {
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      color: var(--muted);
      margin-left: 4px;
    }

    .scan-row .scan-status {
      font-size: 11px;
      color: var(--muted);
    }

    .scan-row::before {
      content: "";
      position: absolute;
      inset: 0;
      background: radial-gradient(circle at left, rgba(56, 189, 248, 0.15), transparent 65%);
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.18s ease-out;
    }

    .scan-row.filled {
      border-color: rgba(56, 189, 248, 0.95);
      box-shadow: 0 0 24px rgba(34, 197, 94, 0.35);
    }

    .scan-row.filled .scan-status {
      color: #bbf7d0;
    }

    .scan-row.filled .scan-label {
      color: var(--accent);
    }

    .scan-row.filled::before {
      opacity: 1;
    }

    .scan-instructions {
      margin-top: 4px;
      font-size: 11px;
      color: var(--muted);
      line-height: 1.5;
    }

    .scan-instructions strong {
      color: #f97373;
    }

    .scan-instructions ol {
      margin-left: 16px;
      margin-top: 4px;
    }

    .scan-instructions li {
      margin-bottom: 1px;
    }

    .scan-actions {
      margin-top: 8px;
      display: flex;
      justify-content: space-between;
      gap: 8px;
      align-items: center;
    }

    .scan-status-block {
      display: flex;
      flex-direction: column;
      gap: 2px;
      font-size: 11px;
    }

    #scanStatusLabel {
      color: var(--muted-strong);
    }

    #scanPercentLabel {
      color: var(--accent);
      font-weight: 700;
    }

    .btn-primary,
    .btn-secondary {
      padding: 6px 12px;
      border-radius: 999px;
      border: none;
      font-size: 12px;
      font-weight: 700;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
      white-space: nowrap;
    }

    .btn-primary {
      background: linear-gradient(135deg, #38bdf8, #22c55e);
      color: #f9fafb;
      box-shadow: 0 10px 25px rgba(56, 189, 248, 0.45);
    }

    .btn-primary:disabled {
      opacity: 0.35;
      cursor: default;
      box-shadow: none;
    }

    .btn-secondary {
      background: #020617;
      border: 1px solid rgba(148, 163, 184, 0.8);
      color: var(--muted);
      box-shadow: none;
    }

    /* Silhouette */

    .figure-wrapper {
      display: flex;
      flex-direction: column;
      gap: 6px;
      align-items: center;
      justify-content: space-between;
      color: var(--muted);
    }

    .figure-visual {
      position: relative;
      width: 100%;
      max-width: 340px;
      aspect-ratio: 9 / 20;
      margin: 0 auto;
      border-radius: 999px;
      background: radial-gradient(circle at top, rgba(15, 23, 42, 0.85) 0, #020617 60%, #000 100%);
      overflow: hidden;
      box-shadow: 0 18px 45px rgba(15, 23, 42, 0.95);
    }

    .figure-visual::before {
      content: "";
      position: absolute;
      inset: -10%;
      background: radial-gradient(circle at top, rgba(15, 23, 42, 0.6), transparent 55%);
      pointer-events: none;
      z-index: 0;
    }

    .figure-silhouette {
      position: absolute;
      inset: 4% 10% 0 10%;
      z-index: 1;
    }

    .figure-img-base,
    .figure-img-fill {
      position: absolute;
      inset: 0;
      width: 100%;
      height: 100%;
      object-fit: contain;
    }

    .figure-img-base {
      opacity: 0.22;
      filter: drop-shadow(0 0 15px rgba(15, 23, 42, 0.95));
    }

    .figure-img-fill {
      opacity: 0;
      filter: drop-shadow(0 0 26px rgba(56, 189, 248, 0.95));
      clip-path: inset(100% 0 0 0);
      transition:
        clip-path 0.6s cubic-bezier(0.16, 1, 0.3, 1),
        opacity 0.35s ease-out;
    }

    .figure-hotspot {
      position: absolute;
      width: 30px;
      height: 30px;
      border-radius: 999px;
      border: 1px solid rgba(148, 163, 184, 0.85);
      background: rgba(15, 23, 42, 0.96);
      color: var(--accent);
      font-size: 14px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      z-index: 3;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.18s ease-out, transform 0.12s ease-out, box-shadow 0.18s ease-out;
    }

    .figure-hotspot span {
      pointer-events: none;
    }

    .figure-hotspot.active {
      opacity: 1;
      pointer-events: auto;
      box-shadow: 0 0 18px rgba(56, 189, 248, 0.95);
    }

    .figure-hotspot:hover {
      transform: scale(1.05);
    }

    .hotspot-id      { top: 7%;  left: 50%; transform: translate(-50%, -50%); }
    .hotspot-conc    { top: 15%; left: 50%; transform: translate(-50%, -50%); }
    .hotspot-hr      { top: 25%; left: 52%; transform: translate(-50%, -50%); }
    .hotspot-rr      { top: 33%; left: 47%; transform: translate(-50%, -50%); }
    .hotspot-bp      { top: 42%; left: 18%; transform: translate(-50%, -50%); }
    .hotspot-inj1    { top: 55%; left: 50%; transform: translate(-50%, -50%); }
    .hotspot-inj2    { top: 75%; left: 50%; transform: translate(-50%, -50%); }

    .figure-caption {
      font-size: 11px;
      color: var(--muted);
      text-align: center;
    }

    .figure-caption span {
      color: var(--accent);
      font-weight: 600;
    }

    /* Vitals panel */

    .vitals-list {
      display: flex;
      flex-direction: column;
      gap: 6px;
      font-size: 13px;
    }

    .vital-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .vital-label {
      font-size: 13px;
      color: #94a3b8;
    }

    .vital-label span {
      font-size: 10px;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      color: #64748b;
      margin-left: 4px;
    }

    .vital-value {
      font-size: 13px;
      font-weight: 700;
      color: #f97373; /* vitals numeric look */
    }

    .vital-value.ok {
      color: var(--accent);
    }

    /* SCREEN 2 ‚Äî triage */

    .screen2-layout {
      width: 100%;
      height: 100%;
      min-height: 0;
      display: flex;
      flex-direction: column;
    }

    .triage-full-panel {
      flex: 1;
      display: flex;
      flex-direction: column;
    }

    .triage-controls {
      display: flex;
      flex-direction: column;
      gap: 8px;
      height: 100%;
    }

    .triage-steps-label {
      font-size: 12px;
      color: var(--muted);
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.08em;
    }

    .triage-circles {
      display: flex;
      gap: 16px;
      align-items: center;
      margin-top: 2px;
      margin-bottom: 8px;
    }

    .triage-circle {
      width: 42px;
      height: 42px;
      border-radius: 999px;
      border: 2px solid transparent;
      cursor: pointer;
      position: relative;
      box-shadow: 0 0 0 0 transparent;
      transition: transform 0.12s ease-out, box-shadow 0.12s ease-out, border-color 0.12s ease-out;
    }

    .triage-circle[data-level="Red"] {
      background: radial-gradient(circle at top, #fecaca, #ef4444);
    }
    .triage-circle[data-level="Yellow"] {
      background: radial-gradient(circle at top, #fef9c3, #eab308);
    }
    .triage-circle[data-level="Green"] {
      background: radial-gradient(circle at top, #bbf7d0, #22c55e);
    }
    .triage-circle[data-level="Black"] {
      background: #020617;
      border: 1px solid #6b7280;
    }

    .triage-circle span {
      position: absolute;
      bottom: -18px;
      left: 50%;
      transform: translateX(-50%);
      font-size: 11px;
      white-space: nowrap;
      font-weight: 600;
      color: var(--muted);
    }

    .triage-circle[data-level="Red"] span { color: #fecaca; }
    .triage-circle[data-level="Yellow"] span { color: #facc15; }
    .triage-circle[data-level="Green"] span { color: #bbf7d0; }
    .triage-circle[data-level="Black"] span { color: #e5e7eb; }

    .triage-circle.selected {
      transform: scale(1.08);
      box-shadow: 0 0 20px rgba(56, 189, 248, 0.85);
      border-color: #e5e7eb;
    }

    .hospital-tests {
      margin-top: 4px;
      display: grid;
      grid-template-columns: 55% 45%;
      gap: 8px;
      font-size: 13px;
      flex: 1;
      min-height: 0;
    }

    .hospital-card {
      border-radius: 16px;
      padding: 8px 10px;
      border: 1px solid rgba(148, 163, 184, 0.6);
      background: rgba(15, 23, 42, 0.98);
      cursor: pointer;
      margin-bottom: 6px;
      color: var(--text);
    }

    .hospital-card.selected {
      border-color: var(--accent);
      box-shadow: 0 0 18px rgba(59, 130, 246, 0.85);
    }

    .hospital-name {
      font-weight: 700;
      margin-bottom: 3px;
      color: #e0f2fe;
    }

    .hospital-meta {
      font-size: 11px;
      color: var(--muted);
    }

    .hospital-correct {
      font-size: 10px;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      color: #4ade80;
      font-weight: 600;
    }

    .tests-list {
      border-radius: 16px;
      border: 1px solid rgba(148, 163, 184, 0.5);
      background: rgba(15, 23, 42, 0.99);
      padding: 8px 10px;
      display: flex;
      flex-direction: column;
      gap: 4px;
      min-height: 0;
      color: var(--text);
    }

    .tests-list-title {
      font-size: 11px;
      color: var(--muted);
      margin-bottom: 2px;
      text-transform: uppercase;
      letter-spacing: 0.08em;
    }

    .test-row {
      display: flex;
      gap: 6px;
      align-items: center;
      font-size: 12px;
      color: var(--text);
    }

    .test-row input {
      accent-color: var(--accent);
    }

    .test-row span.meta {
      font-size: 10px;
      color: var(--muted);
    }

    .test-row.correct label {
      color: #bbf7d0;
    }

    .test-row.wrong label {
      color: #fecaca;
    }

    .submit-row {
      margin-top: 8px;
      display: flex;
      justify-content: space-between;
      gap: 8px;
      align-items: center;
      font-size: 11px;
      color: var(--muted);
    }

    #decisionHint span {
      color: var(--accent);
      font-weight: 600;
    }

    /* SCREEN 3 ‚Äî results + leaderboard */

    .screen3-layout {
      width: 100%;
      height: 100%;
      min-height: 0;
      display: grid;
      grid-template-columns: 55% 45%;
      gap: 10px;
    }

    .results-table {
      width: 100%;
      font-size: 12px;
      border-collapse: collapse;
      color: var(--text);
    }

    .results-table th,
    .results-table td {
      padding: 4px 6px;
      border-bottom: 1px solid rgba(30, 64, 175, 0.6);
      text-align: left;
    }

    .results-table thead th {
      font-weight: 700;
      color: var(--muted);
    }

    .match-cell {
      text-align: center;
      font-size: 14px;
    }

    .match-yes {
      color: #4ade80;
      font-weight: 700;
    }

    .match-no {
      color: #f97373;
      font-weight: 700;
    }

    .score-summary {
      margin-top: 6px;
      font-size: 13px;
      font-weight: 700;
      color: var(--accent);
    }

    .score-summary span {
      color: #f97373;
    }

    .leaderboard {
      margin-top: 8px;
      font-size: 12px;
      color: var(--text);
    }

    .leaderboard table {
      width: 100%;
      border-collapse: collapse;
    }

    .leaderboard th,
    .leaderboard td {
      padding: 3px 4px;
      border-bottom: 1px solid rgba(30, 64, 175, 0.5);
      text-align: left;
    }

    .leaderboard th {
      font-weight: 700;
      color: var(--muted);
    }

    .leaderboard tr:nth-child(odd) td {
      background: rgba(15, 23, 42, 0.7);
    }

    .badge {
      font-size: 10px;
      padding: 1px 6px;
      border-radius: 999px;
      background: rgba(56, 189, 248, 0.14);
      color: var(--accent);
    }

    /* Modal for images */

    .modal-backdrop {
      position: fixed;
      inset: 0;
      background: rgba(15, 23, 42, 0.88);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 40;
    }

    .modal-backdrop.open {
      display: flex;
    }

    .modal {
      background: #020617;
      border-radius: 18px;
      border: 1px solid rgba(148, 163, 184, 0.6);
      max-width: 80vw;
      max-height: 80vh;
      padding: 10px;
      box-shadow: 0 20px 40px rgba(15, 23, 42, 0.95);
      display: flex;
      flex-direction: column;
      gap: 6px;
      color: var(--text);
    }

    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 13px;
      color: var(--muted);
      font-weight: 600;
    }

    .modal-header span {
      color: var(--accent);
      font-weight: 700;
    }

    .modal-close {
      border: none;
      background: transparent;
      color: var(--muted);
      cursor: pointer;
      font-size: 16px;
    }

    .modal-body {
      border-radius: 12px;
      overflow: hidden;
      margin-top: 4px;
    }

    .modal-body img {
      max-width: 100%;
      max-height: 70vh;
      display: block;
    }
  </style>
</head>
<body>
<div class="root">
  <header>
    <div>
      <div class="title">
        <span>üöÅ</span>
        <div>
          AI Triage Drone 2040
        </div>
      </div>
      <div class="subtitle">Mass casualty triage training ‚Ä¢ Human vs AI</div>
    </div>
    <div class="operator" id="operatorLabel">
      Operator: <strong>Waiting for mobile operator‚Ä¶</strong>
    </div>
  </header>

  <main>
    <!-- Global timer bar -->
    <div>
      <div class="timer-global">
        <div class="timer-global-label">PATIENT LOADING ‚Ä¢ TRIAGE TIMER</div>
        <span class="time" id="timerDisplay">0.00 s</span>
      </div>
      <div class="timer-global-sub" id="timerHint">
        Scan all QR tags first. The timer will start when you <span>continue to triage</span>.
      </div>
    </div>

    <!-- SCREEN 1 ‚Äî Scan & Data Collection -->
    <div class="screen active" id="screen1">
      <div class="screen-column">
        <div class="screen1-layout">
          <section class="panel" id="bodyPanel">
            <h2>Patient Body Map &amp; Drone Scan Feed</h2>

            <div class="scenario-select">
              <label for="scenarioSelect">Active scenario</label>
              <select id="scenarioSelect"></select>
            </div>

            <div class="scan-layout">
              <div class="scan-list">
                <div class="scan-row" data-scan="id">
                  <div class="scan-label">Eyes / ID <span>Demographics</span></div>
                  <div class="scan-status">Waiting for scan‚Ä¶</div>
                </div>
                <div class="scan-row" data-scan="conclevel">
                  <div class="scan-label">Face ‚Äì Consciousness <span>AVPU / GCS</span></div>
                  <div class="scan-status">Waiting for scan‚Ä¶</div>
                </div>
                <div class="scan-row" data-scan="hr">
                  <div class="scan-label">Neck ‚Äì Heart rate <span>Perfusion</span></div>
                  <div class="scan-status">Waiting for scan‚Ä¶</div>
                </div>
                <div class="scan-row" data-scan="rr">
                  <div class="scan-label">Chest ‚Äì Respiratory rate <span>Airway / Breathing</span></div>
                  <div class="scan-status">Waiting for scan‚Ä¶</div>
                </div>
                <div class="scan-row" data-scan="bp">
                  <div class="scan-label">Arms ‚Äì Blood pressure <span>Circulation</span></div>
                  <div class="scan-status">Waiting for scan‚Ä¶</div>
                </div>
                <div class="scan-row" data-scan="injury1">
                  <div class="scan-label">Pelvis / Abdomen ‚Äì Injury 1 <span>Primary injury</span></div>
                  <div class="scan-status">Waiting for scan‚Ä¶</div>
                </div>
                <div class="scan-row" data-scan="injury2">
                  <div class="scan-label">Legs / Feet ‚Äì Injury 2 <span>Secondary injury</span></div>
                  <div class="scan-status">Waiting for scan‚Ä¶</div>
                </div>

                <div class="scan-instructions" id="scanHint">
                  <strong>How to scan:</strong> start at the head and move downwards.  
                  Each successful scan fills a region on the body silhouette.
                  You can tap any row to simulate a scan during testing.
                  <ol>
                    <li>Eyes ‚Äì ID / demographics</li>
                    <li>Face ‚Äì consciousness level</li>
                    <li>Neck ‚Äì heart rate</li>
                    <li>Chest ‚Äì respiratory rate</li>
                    <li>Arms ‚Äì blood pressure (not used in Scenario 4)</li>
                    <li>Pelvis / Abdomen ‚Äì main injury</li>
                    <li>Legs / Feet ‚Äì secondary injury</li>
                  </ol>
                </div>

                <div class="scan-actions">
                  <div class="scan-status-block">
                    <span id="scanStatusLabel">Waiting for scans‚Ä¶</span>
                    <span id="scanPercentLabel">Body scanned: 0%</span>
                  </div>
                  <button class="btn-primary" id="continueBtn" disabled>Continue to triage</button>
                </div>
              </div>

              <div class="figure-wrapper">
                <div class="figure-visual" id="figureVisual">
                  <div class="figure-silhouette">
                    <!-- base + fill use the same image -->
                    <img src="images/body_silhouette.png" alt="Patient silhouette" class="figure-img-base" />
                    <img src="images/body_silhouette.png" alt="" class="figure-img-fill" id="figureFill" />
                  </div>

                  <!-- clickable hotspots that open the images AFTER scanning -->
                  <button class="figure-hotspot hotspot-id" data-scan="id" title="Eyes / ID"><span>‚úâ</span></button>
                  <button class="figure-hotspot hotspot-conc" data-scan="conclevel" title="Consciousness"><span>‚úâ</span></button>
                  <button class="figure-hotspot hotspot-hr" data-scan="hr" title="Heart rate"><span>‚úâ</span></button>
                  <button class="figure-hotspot hotspot-rr" data-scan="rr" title="Respiratory rate"><span>‚úâ</span></button>
                  <button class="figure-hotspot hotspot-bp" data-scan="bp" title="Blood pressure"><span>‚úâ</span></button>
                  <button class="figure-hotspot hotspot-inj1" data-scan="injury1" title="Injury 1"><span>‚úâ</span></button>
                  <button class="figure-hotspot hotspot-inj2" data-scan="injury2" title="Injury 2"><span>‚úâ</span></button>
                </div>
                <div class="figure-caption">
                  <span>Head-to-toe scan:</span> the silhouette gradually fills as vitals and injuries are collected.
                  After all regions are scanned you can review each envelope before moving to the triage screen.
                </div>
              </div>
            </div>
          </section>

          <section class="panel">
            <h2>Live Vitals (from drone)</h2>
            <div class="vitals-list">
              <div class="vital-row">
                <div class="vital-label">Consciousness <span>AVPU / GCS</span></div>
                <div class="vital-value" id="vConsciousness">‚Äî</div>
              </div>
              <div class="vital-row">
                <div class="vital-label">Respiratory rate (RR) <span>breaths / min</span></div>
                <div class="vital-value" id="vRR" class="ok">‚Äî</div>
              </div>
              <div class="vital-row">
                <div class="vital-label">Heart rate (HR) <span>bpm</span></div>
                <div class="vital-value" id="vHR">‚Äî</div>
              </div>
              <div class="vital-row">
                <div class="vital-label">Blood pressure (BP) <span>mmHg</span></div>
                <div class="vital-value" id="vBP">‚Äî</div>
              </div>
              <div class="vital-row">
                <div class="vital-label">Key injury / problem <span>primary diagnosis</span></div>
                <div class="vital-value ok" id="vKeyInjury">‚Äî</div>
              </div>
            </div>

            <div style="margin-top:10px;font-size:11px;color:var(--muted);border-radius:14px;border:1px dashed rgba(148,163,184,0.55);padding:8px 10px;">
              <div style="font-weight:700;margin-bottom:4px;color:var(--accent);">COMING SOON</div>
              <div style="font-weight:700;color:var(--text-strong);">AI Paramedic Support Module</div>
              <div>Drone will recommend the exact medical tools and airway / haemorrhage kits paramedics should bring before ambulance arrival.</div>
            </div>
          </section>
        </div>
      </div>
    </div>

    <!-- SCREEN 2 ‚Äî Human triage decision -->
    <div class="screen" id="screen2">
      <div class="screen2-layout">
        <section class="panel triage-full-panel">
          <h2>Human Triage Decision</h2>
          <div class="triage-controls">
            <div class="triage-steps-label">Step 1 ‚Äî choose triage colour</div>
            <div class="triage-circles">
              <div class="triage-circle" data-level="Red">
                <span>Red ‚Äì Immediate</span>
              </div>
              <div class="triage-circle" data-level="Yellow">
                <span>Yellow ‚Äì Delayed</span>
              </div>
              <div class="triage-circle" data-level="Green">
                <span>Green ‚Äì Minimal</span>
              </div>
              <div class="triage-circle" data-level="Black">
                <span>Black ‚Äì Expectant</span>
              </div>
            </div>

            <div class="hospital-tests">
              <div>
                <div class="triage-steps-label" style="margin-bottom:4px;">Step 2 ‚Äî choose receiving hospital / destination</div>
                <div id="hospitalList"></div>
              </div>
              <div>
                <div class="triage-steps-label" style="margin-bottom:4px;">Step 3 ‚Äî choose ER tests / care actions</div>
                <div class="tests-list">
                  <div class="tests-list-title">Tick what you would order / perform</div>
                  <div id="testsList"></div>
                </div>
              </div>
            </div>

            <div class="submit-row">
              <span id="decisionHint">Complete all three steps then press <span>Submit decision</span> to see how you compare with the AI.</span>
              <button class="btn-primary" id="submitDecisionBtn" disabled>Submit decision</button>
            </div>
          </div>
        </section>
      </div>
    </div>

    <!-- SCREEN 3 ‚Äî Results + leaderboard -->
    <div class="screen" id="screen3">
      <div class="screen3-layout">
        <section class="panel">
          <h2>Human vs AI Final Results</h2>
          <table class="results-table">
            <thead>
            <tr>
              <th>Category</th>
              <th>Human</th>
              <th>AI</th>
              <th class="match-cell">Match</th>
            </tr>
            </thead>
            <tbody>
            <tr>
              <td>Triage</td>
              <td id="resHumanTriage">‚Äî</td>
              <td id="resAITriage">‚Äî</td>
              <td class="match-cell" id="matchTriage">‚Äî</td>
            </tr>
            <tr>
              <td>Hospital / destination</td>
              <td id="resHumanHospital">‚Äî</td>
              <td id="resAIHospital">‚Äî</td>
              <td class="match-cell" id="matchHospital">‚Äî</td>
            </tr>
            <tr>
              <td>ER tests / actions</td>
              <td id="resHumanTests">‚Äî</td>
              <td id="resAITests">‚Äî</td>
              <td class="match-cell" id="matchTests">‚Äî</td>
            </tr>
            <tr>
              <td>Total time</td>
              <td id="resHumanTime">‚Äî</td>
              <td id="resAITime">‚Äî</td>
              <td class="match-cell" id="matchTime">‚Äî</td>
            </tr>
            </tbody>
          </table>

          <div class="score-summary" id="scoreSummary">
            Score: <span>0</span> / 12 points
          </div>

          <div style="margin-top:12px;display:flex;gap:8px;">
            <button class="btn-primary" id="resetSimBtn">‚ñ∂ Play new game</button>
          </div>

          <div style="margin-top:12px;font-size:11px;color:var(--muted);border-radius:14px;border:1px dashed rgba(148,163,184,0.55);padding:8px 10px;">
            <div style="font-weight:700;margin-bottom:4px;color:var(--accent);">COMING SOON</div>
            <div style="font-weight:700;color:var(--text-strong);">AI Paramedic Support Module</div>
            <div>Drone will suggest airway kit, haemorrhage control, pelvic binders and blood products based on the remote scan before the ambulance departs.</div>
          </div>
        </section>

        <section class="panel">
          <h2>Live Leaderboard</h2>
          <div class="leaderboard">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:4px;">
              <div style="font-weight:700;">Top scores (persistent)</div>
              <div style="display:flex;gap:8px;align-items:center;">
                <button class="btn-secondary" style="padding:4px 10px;font-size:11px;" id="resetSimulationSoftBtn">
                  Reset simulation
                </button>
                <button class="btn-primary" style="padding:4px 10px;font-size:11px;background:linear-gradient(135deg,#ef4444,#f97316);" id="resetLeaderboardBtn">
                  Reset board
                </button>
              </div>
            </div>

            <!-- Mini (top 5) -->
            <div style="margin-bottom:4px;font-size:11px;color:var(--muted);">
              Stored locally in your browser ‚Äì survives refresh until you clear it.
            </div>
            <div style="margin-bottom:6px;font-size:12px;font-weight:600;color:var(--accent);">Top 5</div>
            <table>
              <thead>
              <tr>
                <th>#</th>
                <th>Name</th>
                <th>Mode</th>
                <th>Scenario</th>
                <th>Score</th>
                <th>Time</th>
              </tr>
              </thead>
              <tbody id="leaderboardMiniBody"></tbody>
            </table>
          </div>

          <!-- Full leaderboard -->
          <div class="leaderboard" style="margin-top:10px;">
            <div style="font-weight:700;margin-bottom:4px;">Full board</div>
            <table>
              <thead>
              <tr>
                <th>#</th>
                <th>Name</th>
                <th>Mode</th>
                <th>Scenario</th>
                <th>Score</th>
                <th>Time</th>
              </tr>
              </thead>
              <tbody id="leaderboardFullBody"></tbody>
            </table>
          </div>
        </section>
      </div>
    </div>
  </main>
</div>

<!-- IMAGE MODAL -->
<div class="modal-backdrop" id="imageModal">
  <div class="modal">
    <div class="modal-header">
      <span id="modalTitle">Scan image</span>
      <button class="modal-close" id="modalCloseBtn">‚úï</button>
    </div>
    <div class="modal-body">
      <img id="modalImage" src="" alt="Scan" />
    </div>
  </div>
</div>

<script src="/socket.io/socket.io.js"></script>
<script>
  // ---------- DATA MODELS ----------

  const SCAN_KEYS = ["id","conclevel","hr","rr","bp","injury1","injury2"];

  const scenarios = [
    {
      id: "s1",
      name: "Scenario 1 ‚Äî Hajj Stampede (Red)",
      triage: "Red",
      aiTime: 50, // seconds (for comparison)
      hospitals: [
        { id: "mina",    name: "Mina Emergency Hospital",           tagline: "Closest high-emergency facility", correct: true },
        { id: "kfh",     name: "King Fahad Medical City ‚Äî Trauma",  tagline: "Level 1 trauma centre, Riyadh", correct: false },
        { id: "dhahran", name: "Dhahran Trauma Center",             tagline: "Highway critical care hub", correct: false },
        { id: "hyd",     name: "Hydration & First Aid Station",     tagline: "Out-of-hospital care", correct: false },
      ],
      tests: [
        { id: "fast",   label: "FAST ultrasound",                   correct: true },
        { id: "lactate",label: "Serum lactate",                     correct: true },
        { id: "xmatch", label: "Blood typing & crossmatch",         correct: true },
        { id: "ct",     label: "Whole-body CT scan",                correct: false },
        { id: "oral",   label: "Oral rehydration only",             correct: false },
        { id: "obs",    label: "Observation only (no imaging)",     correct: false },
      ],
      scanKeys: ["id","conclevel","hr","rr","bp","injury1","injury2"],
      vitals: {
        consciousness: "Unconscious, pale",
        rr: "34 / min",
        hr: "142 bpm",
        bp: "78 / 45 mmHg",
        key: "Severe bleeding + suspected pelvic fracture"
      }
    },
    {
      id: "s2",
      name: "Scenario 2 ‚Äî Riyadh Industrial Explosion (Yellow)",
      triage: "Yellow",
      aiTime: 60,
      hospitals: [
        { id: "kfh",     name: "King Fahad Medical City ‚Äî Trauma",  tagline: "Level 1 trauma centre, Riyadh", correct: true },
        { id: "mina",    name: "Mina Emergency Hospital",           tagline: "Crowded mass-casualty zone", correct: false },
        { id: "dhahran", name: "Dhahran Trauma Center",             tagline: "Highway critical care hub", correct: false },
        { id: "hyd",     name: "Hydration & First Aid Station",     tagline: "Out-of-hospital care", correct: false },
      ],
      tests: [
        { id: "carboxy", label: "Carboxyhaemoglobin level",          correct: true },
        { id: "cxr",     label: "Chest X-ray",                       correct: true },
        { id: "burn",    label: "Burn depth assessment",             correct: true },
        { id: "ecg",     label: "ECG (rule out cardiac stress)",    correct: true },
        { id: "fast",    label: "FAST ultrasound",                   correct: false },
        { id: "xmatch",  label: "Blood crossmatch & transfusion",    correct: false },
      ],
      scanKeys: ["id","conclevel","hr","rr","bp","injury1","injury2"],
      vitals: {
        consciousness: "Alert but disoriented",
        rr: "26 / min",
        hr: "110 bpm",
        bp: "100 / 70 mmHg",
        key: "Burns + chest tightness, dizziness"
      }
    },
    {
      id: "s3",
      name: "Scenario 3 ‚Äî Desert Rally Dehydration (Green)",
      triage: "Green",
      aiTime: 40,
      hospitals: [
        { id: "hyd",     name: "Hydration & First Aid Station",     tagline: "Out-of-hospital care zone", correct: true },
        { id: "mina",    name: "Mina Emergency Hospital",           tagline: "Hajj emergency facility", correct: false },
        { id: "kfh",     name: "King Fahad Medical City ‚Äî Trauma",  tagline: "Level 1 trauma centre", correct: false },
        { id: "dhahran", name: "Dhahran Trauma Center",             tagline: "Highway critical care hub", correct: false },
      ],
      tests: [
        { id: "oral",   label: "Oral rehydration (ORS)",             correct: true },
        { id: "iv",     label: "IV fluids if symptomatic",          correct: true },
        { id: "obs",    label: "Observation only",                  correct: true },
        { id: "fast",   label: "FAST ultrasound",                   correct: false },
        { id: "ct",     label: "Abdominal CT scan",                 correct: false },
      ],
      scanKeys: ["id","conclevel","hr","rr","bp","injury1","injury2"],
      vitals: {
        consciousness: "Alert, walking",
        rr: "18 / min",
        hr: "92 bpm",
        bp: "118 / 78 mmHg",
        key: "Mild dehydration & heat stress"
      }
    },
    {
      id: "s4",
      name: "Scenario 4 ‚Äî Highway Collision (Black)",
      triage: "Black",
      aiTime: 35,
      hospitals: [
        { id: "morgue",  name: "Morgue / Forensic Services",         tagline: "Disaster victim management", correct: true },
        { id: "dvm",     name: "Disaster Victim Management Team",    tagline: "Field identification unit", correct: true },
        { id: "kfh",     name: "King Fahad Medical City ‚Äî Trauma",   tagline: "Acute resuscitation centre", correct: false },
        { id: "mina",    name: "Mina Emergency Hospital",            tagline: "Crowded ED", correct: false },
      ],
      tests: [
        { id: "id_doc", label: "Identification & documentation only", correct: true },
        { id: "fast",   label: "FAST ultrasound",                   correct: false },
        { id: "cpr",    label: "Full CPR & intubation",             correct: false },
        { id: "ct",     label: "CT scan",                           correct: false },
      ],
      // only 6 scans: no BP
      scanKeys: ["id","conclevel","hr","rr","injury1","injury2"],
      vitals: {
        consciousness: "No response, fixed dilated pupils",
        rr: "0 / min",
        hr: "0 bpm",
        bp: "‚Äî",
        key: "Signs of death confirmed"
      }
    }
  ];

  // ---------- STATE ----------

  let currentScenarioIndex = 0;
  let scanned = {};
  let timerStarted = false;
  let timerSeconds = 0;
  let timerInterval = null;

  let selectedTriage = null;
  let selectedHospitalId = null;
  let selectedTests = new Set();

  const leaderboardKey = "triage-leaderboard-v1";

  // ---------- DOM HELPERS ----------

  const screen1 = document.getElementById("screen1");
  const screen2 = document.getElementById("screen2");
  const screen3 = document.getElementById("screen3");

  const scenarioSelect = document.getElementById("scenarioSelect");
  const scanRows = Array.from(document.querySelectorAll(".scan-row"));
  const figureFill = document.getElementById("figureFill");
  const hotspots = Array.from(document.querySelectorAll(".figure-hotspot"));

  const scanStatusLabel = document.getElementById("scanStatusLabel");
  const scanPercentLabel = document.getElementById("scanPercentLabel");
  const continueBtn = document.getElementById("continueBtn");

  const vConsciousness = document.getElementById("vConsciousness");
  const vRR = document.getElementById("vRR");
  const vHR = document.getElementById("vHR");
  const vBP = document.getElementById("vBP");
  const vKeyInjury = document.getElementById("vKeyInjury");

  const timerDisplay = document.getElementById("timerDisplay");
  const timerHint = document.getElementById("timerHint");

  const hospitalListEl = document.getElementById("hospitalList");
  const testsListEl = document.getElementById("testsList");
  const submitDecisionBtn = document.getElementById("submitDecisionBtn");
  const decisionHint = document.getElementById("decisionHint");

  const resHumanTriage = document.getElementById("resHumanTriage");
  const resAITriage = document.getElementById("resAITriage");
  const matchTriage = document.getElementById("matchTriage");

  const resHumanHospital = document.getElementById("resHumanHospital");
  const resAIHospital = document.getElementById("resAIHospital");
  const matchHospital = document.getElementById("matchHospital");

  const resHumanTests = document.getElementById("resHumanTests");
  const resAITests = document.getElementById("resAITests");
  const matchTests = document.getElementById("matchTests");

  const resHumanTime = document.getElementById("resHumanTime");
  const resAITime = document.getElementById("resAITime");
  const matchTime = document.getElementById("matchTime");

  const scoreSummary = document.getElementById("scoreSummary");
  const resetSimBtn = document.getElementById("resetSimBtn");
  const resetSimulationSoftBtn = document.getElementById("resetSimulationSoftBtn");
  const resetLeaderboardBtn = document.getElementById("resetLeaderboardBtn");

  const leaderboardMiniBody = document.getElementById("leaderboardMiniBody");
  const leaderboardFullBody = document.getElementById("leaderboardFullBody");

  const modalBackdrop = document.getElementById("imageModal");
  const modalTitle = document.getElementById("modalTitle");
  const modalImage = document.getElementById("modalImage");
  const modalCloseBtn = document.getElementById("modalCloseBtn");

  // ---------- INITIALISATION ----------

  function initScenariosDropdown() {
    scenarios.forEach((s, i) => {
      const opt = document.createElement("option");
      opt.value = i;
      opt.textContent = s.name;
      scenarioSelect.appendChild(opt);
    });
  }

  function resetScans() {
    const scenario = scenarios[currentScenarioIndex];

    scanned = {};
    SCAN_KEYS.forEach(k => scanned[k] = false);

    scanRows.forEach(row => {
      const key = row.dataset.scan;
      if (!scenario.scanKeys.includes(key)) {
        row.style.display = "none";
      } else {
        row.style.display = "flex";
        row.classList.remove("filled");
        row.querySelector(".scan-status").textContent = "Waiting for scan‚Ä¶";
      }
    });

    hotspots.forEach(h => {
      const key = h.dataset.scan;
      if (!scenario.scanKeys.includes(key)) {
        h.style.display = "none";
      } else {
        h.style.display = "flex";
        h.classList.remove("active");
      }
    });

    updateFigureFill();
    updateScanProgress();
    continueBtn.disabled = true;

    // vitals baseline
    vConsciousness.textContent = "‚Äî";
    vRR.textContent = "‚Äî";
    vHR.textContent = "‚Äî";
    vBP.textContent = "‚Äî";
    vKeyInjury.textContent = "‚Äî";
  }

  function updateFigureFill() {
    const scenario = scenarios[currentScenarioIndex];
    const needed = scenario.scanKeys.length;
    const done = scenario.scanKeys.filter(k => scanned[k]).length;
    const frac = done / needed;

    if (frac > 0) {
      figureFill.style.opacity = 1;
      figureFill.style.clipPath = `inset(${(1 - frac) * 100}% 0 0 0)`;
    } else {
      figureFill.style.opacity = 0;
      figureFill.style.clipPath = "inset(100% 0 0 0)";
    }
  }

  function updateScanProgress() {
    const scenario = scenarios[currentScenarioIndex];
    const needed = scenario.scanKeys.length;
    const done = scenario.scanKeys.filter(k => scanned[k]).length;
    const percent = Math.round((done / needed) * 100);

    scanPercentLabel.textContent = `Body scanned: ${percent}%`;
    if (done === 0) {
      scanStatusLabel.textContent = "Waiting for scans‚Ä¶";
    } else if (done < needed) {
      scanStatusLabel.textContent = "Scanning in progress‚Ä¶";
    } else {
      scanStatusLabel.textContent = "All scans done. You may review images or continue to triage.";
    }

    continueBtn.disabled = done < needed;
  }

  function populateHospitalsAndTests() {
    const scenario = scenarios[currentScenarioIndex];

    hospitalListEl.innerHTML = "";
    testsListEl.innerHTML = "";

    scenario.hospitals.forEach(h => {
      const el = document.createElement("div");
      el.className = "hospital-card";
      el.dataset.id = h.id;
      el.innerHTML = `
        <div class="hospital-name">${h.name}</div>
        <div class="hospital-meta">${h.tagline}</div>
        ${h.correct ? '<div class="hospital-correct">AI preferred destination</div>' : ""}
      `;
      el.addEventListener("click", () => {
        selectedHospitalId = h.id;
        updateHospitalSelection();
        updateSubmitState();
      });
      hospitalListEl.appendChild(el);
    });

    scenario.tests.forEach(t => {
      const row = document.createElement("div");
      row.className = "test-row " + (t.correct ? "correct" : "wrong");
      row.innerHTML = `
        <input type="checkbox" id="test_${t.id}">
        <label for="test_${t.id}">${t.label}</label>
      `;
      const input = row.querySelector("input");
      input.addEventListener("change", () => {
        if (input.checked) selectedTests.add(t.id);
        else selectedTests.delete(t.id);
        updateSubmitState();
      });
      testsListEl.appendChild(row);
    });
  }

  function updateHospitalSelection() {
    Array.from(hospitalListEl.querySelectorAll(".hospital-card")).forEach(card => {
      card.classList.toggle("selected", card.dataset.id === selectedHospitalId);
    });
  }

  function resetTriageChoices() {
    selectedTriage = null;
    selectedHospitalId = null;
    selectedTests.clear();

    document.querySelectorAll(".triage-circle").forEach(c => c.classList.remove("selected"));
    Array.from(hospitalListEl.querySelectorAll(".hospital-card")).forEach(card => card.classList.remove("selected"));
    Array.from(testsListEl.querySelectorAll("input")).forEach(input => input.checked = false);

    updateSubmitState();
  }

  function updateSubmitState() {
    const scenario = scenarios[currentScenarioIndex];

    const triageOk = !!selectedTriage;
    const hospitalOk = !!selectedHospitalId;
    const testsOk = selectedTests.size > 0 || scenario.tests.length === 0;

    const enabled = triageOk && hospitalOk && testsOk;
    submitDecisionBtn.disabled = !enabled;

    decisionHint.style.color = enabled ? "#cbd5f5" : "#9ca3af";
  }

  function switchScreen(index) {
    screen1.classList.remove("active");
    screen2.classList.remove("active");
    screen3.classList.remove("active");

    [screen1, screen2, screen3][index].classList.add("active");
  }

  function startTimerIfNeeded() {
    if (timerStarted) return;
    timerStarted = true;
    timerSeconds = 0;
    timerHint.textContent = "Timer running ‚Äî complete triage as quickly and safely as possible.";
    timerHint.style.color = "#cbd5f5";

    timerInterval = setInterval(() => {
      timerSeconds += 0.1;
      timerDisplay.textContent = timerSeconds.toFixed(2) + " s";
    }, 100);
  }

  function stopTimer() {
    if (timerInterval) clearInterval(timerInterval);
    timerInterval = null;
  }

  function formatSeconds(sec) {
    return sec.toFixed(2) + " s";
  }

  // ---------- SCAN HANDLING ----------

  function applyVitalsForScenario() {
    const s = scenarios[currentScenarioIndex];
    vConsciousness.textContent = s.vitals.consciousness;
    vRR.textContent = s.vitals.rr;
    vHR.textContent = s.vitals.hr;
    vBP.textContent = s.vitals.bp;
    vKeyInjury.textContent = s.vitals.key;
  }

  function handleScan(scanKey) {
    const scenario = scenarios[currentScenarioIndex];
    if (!scenario.scanKeys.includes(scanKey)) return;

    scanned[scanKey] = true;

    const row = scanRows.find(r => r.dataset.scan === scanKey);
    if (row) {
      row.classList.add("filled");
      row.querySelector(".scan-status").textContent = "Scan received";
    }

    const hotspot = hotspots.find(h => h.dataset.scan === scanKey);
    if (hotspot) {
      hotspot.classList.add("active");
    }

    applyVitalsForScenario();
    updateFigureFill();
    updateScanProgress();
  }

  // expose for backend if needed
  window.handleScan = handleScan;

  // ---------- RESULTS & SCORING ----------

  function calculateScore() {
    const scenario = scenarios[currentScenarioIndex];
    let score = 0;

    // triage
    const triageMatch = selectedTriage === scenario.triage;
    if (triageMatch) score += 4;

    const correctHospitalIds = scenario.hospitals.filter(h => h.correct).map(h => h.id);
    const hospitalMatch = correctHospitalIds.includes(selectedHospitalId);
    if (hospitalMatch) score += 4;

    const correctTests = scenario.tests.filter(t => t.correct).map(t => t.id);
    const wrongTests = scenario.tests.filter(t => !t.correct).map(t => t.id);

    const humanTests = Array.from(selectedTests);
    const allNeededSelected = correctTests.every(id => humanTests.includes(id));
    const noExtraWrong = humanTests.every(id => !wrongTests.includes(id));
    const testsMatch = allNeededSelected && noExtraWrong;
    if (testsMatch) score += 4;

    // time comparison (for match only)
    const timeMatch = timerSeconds <= scenario.aiTime * 1.2; // within 20%
    return { score, triageMatch, hospitalMatch, testsMatch, timeMatch };
  }

  function updateResultsAndLeaderboard() {
    const scenario = scenarios[currentScenarioIndex];
    const { score, triageMatch, hospitalMatch, testsMatch, timeMatch } = calculateScore();

    // Populate results table
    resHumanTriage.textContent = selectedTriage || "‚Äî";
    resAITriage.textContent = scenario.triage;
    matchTriage.textContent = triageMatch ? "‚úî" : "‚úñ";
    matchTriage.className = "match-cell " + (triageMatch ? "match-yes" : "match-no");

    const hospitalLabel = scenario.hospitals.find(h => h.id === selectedHospitalId)?.name || "‚Äî";
    const aiHospitals = scenario.hospitals.filter(h => h.correct).map(h => h.name).join(" or ");

    resHumanHospital.textContent = hospitalLabel;
    resAIHospital.textContent = aiHospitals || "‚Äî";
    matchHospital.textContent = hospitalMatch ? "‚úî" : "‚úñ";
    matchHospital.className = "match-cell " + (hospitalMatch ? "match-yes" : "match-no");

    const humanTestsLabels = scenario.tests
      .filter(t => selectedTests.has(t.id))
      .map(t => t.label);
    const aiTestsLabels = scenario.tests
      .filter(t => t.correct)
      .map(t => t.label);

    resHumanTests.textContent = humanTestsLabels.join(", ") || "‚Äî";
    resAITests.textContent = aiTestsLabels.join(", ") || "‚Äî";
    matchTests.textContent = testsMatch ? "‚úî" : "‚úñ";
    matchTests.className = "match-cell " + (testsMatch ? "match-yes" : "match-no");

    resHumanTime.textContent = formatSeconds(timerSeconds);
    resAITime.textContent = formatSeconds(scenario.aiTime);
    matchTime.textContent = timeMatch ? "‚úî" : "‚úñ";
    matchTime.className = "match-cell " + (timeMatch ? "match-yes" : "match-no");

    scoreSummary.innerHTML = `Score: <span>${score}</span> / 12 points`;

    // leaderboard entry
    const name = getPlayerName();
    const entry = {
      name,
      mode: "Solo",
      scenario: scenario.name,
      score,
      time: timerSeconds,
      createdAt: Date.now(),
    };

    const board = loadLeaderboard();
    board.push(entry);
    saveLeaderboard(board);
    renderLeaderboard();
  }

  // ---------- LEADERBOARD PERSISTENCE ----------

  function loadLeaderboard() {
    try {
      const raw = localStorage.getItem(leaderboardKey);
      if (!raw) return [];
      const arr = JSON.parse(raw);
      if (!Array.isArray(arr)) return [];
      return arr;
    } catch {
      return [];
    }
  }

  function saveLeaderboard(arr) {
    localStorage.setItem(leaderboardKey, JSON.stringify(arr));
  }

  function renderLeaderboard() {
    const board = loadLeaderboard().sort((a,b) => {
      if (b.score !== a.score) return b.score - a.score;
      return a.time - b.time;
    });

    leaderboardMiniBody.innerHTML = "";
    leaderboardFullBody.innerHTML = "";

    board.forEach((entry, idx) => {
      const trFull = document.createElement("tr");
      trFull.innerHTML = `
        <td>${idx + 1}</td>
        <td>${entry.name}</td>
        <td>${entry.mode}</td>
        <td>${entry.scenario}</td>
        <td>${entry.score}</td>
        <td>${entry.time.toFixed(2)} s</td>
      `;
      leaderboardFullBody.appendChild(trFull);

      if (idx < 5) {
        const trMini = document.createElement("tr");
        trMini.innerHTML = `
          <td>${idx + 1}</td>
          <td>${entry.name}</td>
          <td>${entry.mode}</td>
          <td>${entry.scenario}</td>
          <td>${entry.score}</td>
          <td>${entry.time.toFixed(2)} s</td>
        `;
        leaderboardMiniBody.appendChild(trMini);
      }
    });
  }

  function getPlayerName() {
    const key = "triage-player-name";
    let name = sessionStorage.getItem(key);
    if (!name) {
      name = prompt("Enter your name for the leaderboard:", "You");
      if (!name) name = "You";
      sessionStorage.setItem(key, name);
    }
    return name;
  }

  // ---------- IMAGE MODAL ----------

  function openImageModal(scanKey) {
    const scenario = scenarios[currentScenarioIndex];
    if (!scenario.scanKeys.includes(scanKey)) return;
    if (!scanned[scanKey]) return;

    const scenarioNumber = currentScenarioIndex + 1;
    const src = `images/s${scenarioNumber}_${scanKey}.jpg`;

    modalTitle.textContent = `Scan ‚Äì ${scanKey.toUpperCase()}`;
    modalImage.src = src;

    modalBackdrop.classList.add("open");
  }

  function closeImageModal() {
    modalBackdrop.classList.remove("open");
    modalImage.src = "";
  }

  // ---------- EVENT WIRING ----------

  function attachEvents() {
    // scenario change
    scenarioSelect.addEventListener("change", () => {
      currentScenarioIndex = parseInt(scenarioSelect.value, 10) || 0;
      resetScans();
      populateHospitalsAndTests();
      resetTriageChoices();
    });

    // scan rows simulate scan
    scanRows.forEach(row => {
      row.addEventListener("click", () => {
        handleScan(row.dataset.scan);
      });
    });

    // hotspots ‚Üí open image
    hotspots.forEach(h => {
      h.addEventListener("click", () => openImageModal(h.dataset.scan));
    });

    modalCloseBtn.addEventListener("click", closeImageModal);
    modalBackdrop.addEventListener("click", e => {
      if (e.target === modalBackdrop) closeImageModal();
    });

    // triage circles
    document.querySelectorAll(".triage-circle").forEach(circle => {
      circle.addEventListener("click", () => {
        document.querySelectorAll(".triage-circle").forEach(c => c.classList.remove("selected"));
        circle.classList.add("selected");
        selectedTriage = circle.dataset.level;
        updateSubmitState();
      });
    });

    continueBtn.addEventListener("click", () => {
      // allow some time on silhouette page; timer starts now
      startTimerIfNeeded();
      switchScreen(1); // screen2 index
    });

    submitDecisionBtn.addEventListener("click", () => {
      stopTimer();
      updateResultsAndLeaderboard();
      switchScreen(2); // results
    });

    resetSimBtn.addEventListener("click", () => {
      // hard reset current run but keep leaderboard
      timerStarted = false;
      stopTimer();
      timerDisplay.textContent = "0.00 s";
      timerHint.textContent = "Scan all QR tags first. The timer will start when you continue to triage.";
      timerHint.style.color = "#9ca3af";

      resetScans();
      populateHospitalsAndTests();
      resetTriageChoices();
      switchScreen(0);
    });

    resetSimulationSoftBtn.addEventListener("click", () => {
      // soft reset from leaderboard screen back to screen1
      resetSimBtn.click();
    });

    resetLeaderboardBtn.addEventListener("click", () => {
      if (!confirm("Clear leaderboard stored in this browser?")) return;
      saveLeaderboard([]);
      renderLeaderboard();
    });
  }

  // ---------- SOCKET.IO INTEGRATION (optional) ----------

  const socket = window.io ? io() : null;

  if (socket) {
    socket.on("connect", () => {
      document.getElementById("operatorLabel").innerHTML =
        'Operator: <strong>Mobile operator connected</strong>';
    });

    socket.on("disconnect", () => {
      document.getElementById("operatorLabel").innerHTML =
        'Operator: <strong>Waiting for mobile operator‚Ä¶</strong>';
    });

    // Generic scan event from mobile device (adjust event name if your backend uses a different one)
    socket.on("scan", payload => {
      // expected payload: { scenarioIndex, scanKey }
      const { scenarioIndex, scanKey } = payload || {};
      if (typeof scenarioIndex === "number" && scenarioIndex !== currentScenarioIndex) {
        currentScenarioIndex = scenarioIndex;
        scenarioSelect.value = String(scenarioIndex);
        resetScans();
        populateHospitalsAndTests();
        resetTriageChoices();
      }
      if (scanKey) {
        handleScan(scanKey);
      }
    });
  }

  // ---------- BOOT ----------

  function boot() {
    initScenariosDropdown();
    scenarioSelect.value = "0";
    resetScans();
    populateHospitalsAndTests();
    resetTriageChoices();
    renderLeaderboard();
    attachEvents();
  }

  boot();
</script>
</body>
</html>
