<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>AI Triage Drone 2040 ‚Äì Main Screen</title>
  <script src="/socket.io/socket.io.js"></script>
  <style>
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: radial-gradient(circle at top, #111827 0, #020617 50%, #000 100%);
      color: #e5e7eb;
      margin: 0;
      padding: 20px;
    }
    h1, h2, h3 { margin: 0.4rem 0; }

    .row {
      display: flex;
      gap: 20px;
      margin-top: 20px;
      flex-wrap: wrap;
    }

    .card {
      flex: 1;
      min-width: 340px;
      background: rgba(15, 23, 42, 0.96);
      border-radius: 16px;
      padding: 18px 20px;
      box-shadow: 0 0 30px rgba(15, 23, 42, 0.9);
      border: 1px solid rgba(148, 163, 184, 0.4);
    }

    .label {
      font-size: 0.85rem;
      text-transform: uppercase;
      color: #9ca3af;
      letter-spacing: 0.1em;
      margin-top: 10px;
      margin-bottom: 4px;
    }

    .value {
      font-size: 1.05rem;
      margin-bottom: 0.4rem;
    }

    .small { font-size: 0.8rem; color: #9ca3af; }

    .btn {
      padding: 8px 16px;
      border-radius: 999px;
      border: none;
      cursor: pointer;
      margin-top: 10px;
      margin-right: 8px;
      font-size: 0.95rem;
      font-weight: 500;
    }
    .btn-primary { background: #2563eb; color: #fff; }
    .btn-danger  { background: #b91c1c; color: #fff; }
    .btn-ghost   { background: transparent; color: #e5e7eb; border: 1px solid #4b5563; }

    .input, select {
      width: 100%;
      padding: 6px 8px;
      border-radius: 8px;
      border: 1px solid #4b5563;
      background: #020617;
      color: #e5e7eb;
      margin-top: 4px;
    }

    .operator-banner {
      margin-top: 6px;
      padding: 10px 16px;
      border-radius: 999px;
      display: inline-flex;
      align-items: center;
      gap: 10px;
      background: radial-gradient(circle at left, #22c55e33, #020617);
      border: 1px solid rgba(34, 197, 94, 0.7);
      font-size: 1.1rem;
      font-weight: 600;
    }

    .main-layout {
      display: grid;
      grid-template-columns: minmax(320px, 420px) minmax(420px, 1fr);
      gap: 20px;
      align-items: flex-start;
    }

    /* LEFT: body map & vitals */

    .body-map {
      display: flex;
      flex-direction: column;
      gap: 6px;
      margin-top: 4px;
    }

    .body-row {
      display: grid;
      grid-template-columns: 30% 40% 30%;
      gap: 8px;
      align-items: center;
    }

    .body-label {
      font-size: 0.85rem;
      color: #9ca3af;
    }

    .body-photo {
      width: 100%;
      aspect-ratio: 4 / 3;
      border-radius: 12px;
      background: #020617;
      border: 1px solid #1f2937;
      overflow: hidden;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 0.75rem;
      color: #6b7280;
    }
    .body-photo img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    .drone-chip {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      padding: 6px 8px;
      border-radius: 999px;
      border: 1px solid #1f2937;
      background: #020617;
      font-size: 0.78rem;
      opacity: 0.35;
      transition: opacity 0.3s ease, border-color 0.3s ease, transform 0.2s ease;
      white-space: nowrap;
    }
    .drone-chip.active {
      opacity: 1;
      border-color: #22c55e;
      transform: translateY(-1px);
    }

    .vital-slot {
      display: flex;
      justify-content: space-between;
      padding: 6px 8px;
      margin-bottom: 4px;
      border-radius: 8px;
      background: #020617;
      border: 1px solid #111827;
      font-size: 1.05rem;
    }
    .vital-label { color: #9ca3af; }
    .vital-value { font-weight: 600; color: #f9fafb; }
    .vital-value.empty { color: #4b5563; }

    .vital-highlight {
      animation: glow 900ms ease-out;
    }
    @keyframes glow {
      from { box-shadow: 0 0 0 rgba(248, 250, 252, 0.0); }
      50% { box-shadow: 0 0 18px rgba(248, 250, 252, 0.7); }
      to { box-shadow: 0 0 0 rgba(248, 250, 252, 0.0); }
    }

    .status-pill {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 4px 10px;
      border-radius: 999px;
      font-size: 0.8rem;
      background: rgba(37, 99, 235, 0.1);
      border: 1px solid rgba(59, 130, 246, 0.5);
      color: #bfdbfe;
      margin-top: 6px;
    }

    .timer-big { font-size: 1.8rem; font-weight: 700; }
    .timer-ms  { font-size: 1rem; opacity: 0.9; }

    /* TRIAGE CIRCLES */

    .triage-row {
      display: flex;
      gap: 18px;
      justify-content: center;
      margin-top: 12px;
      flex-wrap: wrap;
    }

    .triage-circle {
      width: 90px;
      height: 90px;
      border-radius: 999px;
      border: none;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      flex-direction: column;
      font-size: 1rem;
      font-weight: 700;
      color: #020617;
      box-shadow: 0 0 0 rgba(0,0,0,0);
      transition: transform 0.2s ease, box-shadow 0.2s ease, opacity 0.2s ease;
    }
    .triage-circle span.sub {
      font-size: 0.65rem;
      font-weight: 500;
      opacity: 0.9;
    }
    .triage-circle.red    { background: #ef4444; }
    .triage-circle.yellow { background: #eab308; }
    .triage-circle.green  { background: #22c55e; }
    .triage-circle.black  { background: #111827; color: #f9fafb; }

    .triage-circle.selected {
      transform: translateY(-2px) scale(1.03);
      box-shadow: 0 0 20px rgba(250, 250, 250, 0.6);
    }

    .triage-underlights {
      display: flex;
      justify-content: center;
      gap: 18px;
      margin-top: 4px;
    }
    .light-dot {
      width: 10px;
      height: 10px;
      border-radius: 999px;
      background: #1f2937;
      box-shadow: 0 0 0 rgba(0,0,0,0);
    }
    .light-dot.active.red    { background: #fecaca; box-shadow: 0 0 10px #fecaca; }
    .light-dot.active.yellow { background: #fef08a; box-shadow: 0 0 10px #fef08a; }
    .light-dot.active.green  { background: #bbf7d0; box-shadow: 0 0 10px #bbf7d0; }
    .light-dot.active.black  { background: #9ca3af; box-shadow: 0 0 10px #9ca3af; }

    .choice-grid {
      display: grid;
      grid-template-columns: 1.1fr 1fr;
      gap: 20px;
      margin-top: 14px;
    }

    .hospital-card {
      border-radius: 12px;
      padding: 10px 12px;
      background: #020617;
      border: 1px solid #1f2937;
      margin-bottom: 8px;
      cursor: pointer;
      display: flex;
      flex-direction: column;
      gap: 4px;
    }
    .hospital-card.selected {
      border-color: #22c55e;
      box-shadow: 0 0 16px rgba(34, 197, 94, 0.5);
    }
    .hospital-name { font-weight: 600; }
    .hospital-meta { font-size: 0.8rem; color: #9ca3af; }

    .tests-list label {
      display: block;
      margin-bottom: 4px;
      font-size: 0.9rem;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.95rem;
      margin-top: 8px;
    }
    th, td {
      border-bottom: 1px solid #111827;
      padding: 6px 4px;
      text-align: left;
    }

    .score-highlight {
      font-size: 1.4rem;
      font-weight: 700;
    }

    .future-box {
      margin-top: 10px;
      padding: 10px 12px;
      border-radius: 12px;
      border: 1px dashed #4b5563;
      background: rgba(15, 23, 42, 0.85);
      font-size: 0.85rem;
      color: #e5e7eb;
    }
  </style>
</head>
<body>
  <h1>üöÅ AI Triage Drone 2040 ‚Äì Human vs AI Triage</h1>
  <div id="operatorBanner" class="operator-banner">
    <span>üßë‚Äç‚úàÔ∏è DRONE OPERATOR:&nbsp;</span>
    <span id="operatorName">Waiting for visitor‚Ä¶</span>
  </div>
  <p class="small">
    The visitor plays the role of a triage drone: scan the QR tags on the mannequin,
    watch the body map build in real time, then choose triage, hospital and ER tests.
  </p>

  <!-- SETUP -->
  <div class="card">
    <h2>üß≠ Scenario Setup</h2>
    <div class="row" style="margin-top:6px;">
      <div style="flex: 1; min-width: 240px;">
        <div class="label">Visitor / team name</div>
        <input id="teamNameInput" class="input" placeholder="Example: Hajj Medics A" />

        <div class="label">Mode</div>
        <select id="modeSelect">
          <option value="Group">Group</option>
          <option value="Solo">Solo</option>
        </select>
      </div>

      <div style="flex: 1; min-width: 260px;">
        <div class="label">Scenario</div>
        <select id="scenarioSelect"></select>

        <button class="btn btn-primary" id="startScenarioBtn">Start Scenario</button>
        <button class="btn btn-ghost" id="resetGameBtn">Reset Scenario</button>
        <button class="btn btn-danger" id="resetLeaderboardBtn">Reset Leaderboard</button>
        <div class="small" id="setupStatus" style="margin-top:6px;"></div>
      </div>
    </div>
  </div>

  <div class="row">
    <!-- LEFT: body map & vitals -->
    <div class="card">
      <h2>üßë‚Äç‚öïÔ∏è Patient Body Map & Drone Feed</h2>

      <div class="main-layout">
        <div>
          <div class="label">Scenario</div>
          <div class="value" id="scenarioNameDisplay">No active scenario.</div>

          <div class="label">Body map (head ‚Üí toes)</div>
          <div id="bodyMap" class="body-map"></div>

          <div id="droneStatus" class="status-pill" style="display:none;">
            <span>üõ∞Ô∏è Drone ready.</span>
          </div>
        </div>

        <div>
          <div class="label">Live vitals (from drone)</div>
          <div id="vitalsPanel"></div>

          <div class="label">Triage timer</div>
          <div id="timerDisplay" class="timer-big">--</div>
          <div class="small" id="infoMessage" style="margin-top:4px;"></div>
        </div>
      </div>
    </div>

    <!-- RIGHT: triage, hospital, results -->
    <div class="card" id="rightPanel">
      <h2 id="rightPanelTitle">üß© Human Triage</h2>
      <div id="rightPanelContent">
        <p class="small">
          Start a scenario above, then ask the visitor to scan QR tags on the mannequin
          with the mobile scanner. Photos and vitals will appear here automatically.
        </p>
      </div>
    </div>
  </div>

  <!-- LEADERBOARD -->
  <div class="card" style="margin-top:20px;">
    <h2>üèÜ Live Leaderboard</h2>
    <table>
      <thead>
        <tr>
          <th>#</th>
          <th>Drone operator</th>
          <th>Mode</th>
          <th>Scenario</th>
          <th>Score</th>
          <th>Time (s)</th>
        </tr>
      </thead>
      <tbody id="leaderboardBody"></tbody>
    </table>

    <div class="future-box">
      <strong>üîÆ Coming soon: AI Paramedic Support Module</strong><br />
      In the full 2040 system, the drone will also recommend the exact equipment
      paramedics should bring from the ambulance or hospital based on the patient‚Äôs
      vitals and injuries. (Concept feature ‚Äì not active in this exhibition demo.)
    </div>
  </div>

  <script>
    const socket = io();

    let scenarios = [];
    let hospitalsMap = {};
    let hospitalTestsMap = {};
    let currentGame = null;
    let timerInterval = null;
    let timerStart = null;
    let triageLocked = false;
    let hospitalSelection = null;
    let testSelection = new Set();
    let chosenTriage = null;

    const teamNameInput = document.getElementById("teamNameInput");
    const modeSelect = document.getElementById("modeSelect");
    const scenarioSelect = document.getElementById("scenarioSelect");
    const startScenarioBtn = document.getElementById("startScenarioBtn");
    const resetGameBtn = document.getElementById("resetGameBtn");
    const resetLeaderboardBtn = document.getElementById("resetLeaderboardBtn");
    const setupStatus = document.getElementById("setupStatus");

    const operatorNameDisplay = document.getElementById("operatorName");
    const scenarioNameDisplay = document.getElementById("scenarioNameDisplay");
    const bodyMap = document.getElementById("bodyMap");
    const droneStatus = document.getElementById("droneStatus");
    const vitalsPanel = document.getElementById("vitalsPanel");
    const timerDisplayEl = document.getElementById("timerDisplay");
    const infoMessageEl = document.getElementById("infoMessage");
    const rightPanelTitle = document.getElementById("rightPanelTitle");
    const rightPanelContent = document.getElementById("rightPanelContent");
    const leaderboardBody = document.getElementById("leaderboardBody");

    const BODY_REGIONS = ["Head", "Chest", "Abdomen", "Arms", "Legs"];

    const VITAL_LABELS = {
      hr: "Heart rate (HR)",
      bp: "Blood pressure (BP)",
      rr: "Respiratory rate (RR)",
      consciousness: "Consciousness",
      injury: "Key injury / problem"
    };

    const TESTS = {
      fast: "FAST ultrasound",
      lactate: "Serum lactate",
      crossmatch: "Blood typing and crossmatch",
      co: "Carboxyhaemoglobin level (CO)",
      xray: "Plain X-ray",
      burn: "Burn assessment",
      iv: "Intravenous (IV) fluids",
      ct: "CT scan"
    };

    function resetBodyMap() {
      bodyMap.innerHTML = "";
      BODY_REGIONS.forEach((region, idx) => {
        const row = document.createElement("div");
        row.className = "body-row";
        row.dataset.index = idx;
        row.innerHTML = `
          <div class="body-label">${region}</div>
          <div class="body-photo">
            <span class="small">Scan tag for ${region.toLowerCase()}</span>
          </div>
          <div class="drone-chip" data-drone-index="${idx}">
            üõ∞Ô∏è Drone tool idle
          </div>
        `;
        bodyMap.appendChild(row);
      });
    }

    function resetVitalsPanel() {
      vitalsPanel.innerHTML = "";
      ["consciousness", "rr", "hr", "bp", "injury"].forEach(key => {
        const slot = document.createElement("div");
        slot.className = "vital-slot";
        slot.dataset.key = key;
        slot.innerHTML = `
          <span class="vital-label">${VITAL_LABELS[key]}</span>
          <span class="vital-value empty">‚Äî ‚Äî</span>
        `;
        vitalsPanel.appendChild(slot);
      });
    }

    function resetTimerDisplay() {
      if (timerInterval) clearInterval(timerInterval);
      timerInterval = null;
      timerStart = null;
      timerDisplayEl.textContent = "--";
    }

    function startCountdown(seconds) {
      timerStart = performance.now();
      const endTime = timerStart + seconds * 1000;

      if (timerInterval) clearInterval(timerInterval);
      timerInterval = setInterval(() => {
        const now = performance.now();
        let remaining = endTime - now;
        if (remaining <= 0) {
          remaining = 0;
          clearInterval(timerInterval);
          timerInterval = null;
        }
        const secFloat = remaining / 1000;
        const formatted = secFloat.toFixed(2);
        const [sec, ms] = formatted.split(".");
        timerDisplayEl.innerHTML =
          `<span class="timer-big">${sec}</span>` +
          `<span class="timer-ms">.${ms} s</span>`;
      }, 40);
    }

    function stopTimerFreezeFinal() {
      if (timerInterval) {
        clearInterval(timerInterval);
        timerInterval = null;
      }
      if (timerStart !== null) {
        const elapsed = (performance.now() - timerStart) / 1000;
        const formatted = elapsed.toFixed(2);
        const [sec, ms] = formatted.split(".");
        timerDisplayEl.innerHTML =
          `<span class="timer-big">${sec}</span>` +
          `<span class="timer-ms">.${ms} s (final)</span>`;
      }
    }

    function activateDroneChip(index, labelText) {
      const row = bodyMap.querySelector(`.body-row[data-index="${index}"]`);
      if (!row) return;
      const chip = row.querySelector(".drone-chip");
      if (!chip) return;
      chip.classList.add("active");
      if (labelText) chip.textContent = labelText;
    }

    function showTriageCircles() {
      rightPanelTitle.textContent = "üö® Step 4 ‚Äî Choose triage category";
      rightPanelContent.innerHTML = `
        <p class="small">
          Use the body map and vitals on the left to decide how urgent this patient is.
        </p>
        <div class="triage-row">
          <button class="triage-circle red" data-triage="Red">
            <span>üü•</span>
            <span class="sub">Immediate</span>
          </button>
          <button class="triage-circle yellow" data-triage="Yellow">
            <span>üü®</span>
            <span class="sub">Delayed</span>
          </button>
          <button class="triage-circle green" data-triage="Green">
            <span>üü©</span>
            <span class="sub">Minimal</span>
          </button>
          <button class="triage-circle black" data-triage="Black">
            <span>‚¨õ</span>
            <span class="sub">Expectant</span>
          </button>
        </div>
        <div class="triage-underlights">
          <div class="light-dot" data-light="Red"></div>
          <div class="light-dot" data-light="Yellow"></div>
          <div class="light-dot" data-light="Green"></div>
          <div class="light-dot" data-light="Black"></div>
        </div>
      `;

      document.querySelectorAll(".triage-circle").forEach(btn => {
        btn.onclick = () => {
          if (triageLocked) return;
          chosenTriage = btn.dataset.triage;
          triageLocked = true;

          document.querySelectorAll(".triage-circle")
            .forEach(b => b.classList.remove("selected"));
          btn.classList.add("selected");

          document.querySelectorAll(".light-dot")
            .forEach(dot => dot.classList.remove("active"));
          const active = document.querySelector(
            `.light-dot[data-light="${chosenTriage}"]`
          );
          if (active) active.classList.add("active", chosenTriage.toLowerCase());

          showHospitalAndTests();
        };
      });
    }

    function showHospitalAndTests() {
      rightPanelTitle.textContent = "üè• Step 5 ‚Äî Choose hospital & ER tests";
      rightPanelContent.innerHTML = `
        <div class="choice-grid">
          <div>
            <div class="label">Recommended hospitals</div>
            <div id="hospitalList"></div>
          </div>
          <div>
            <div class="label">Tests available at this hospital</div>
            <div class="tests-list" id="testsList"></div>
          </div>
        </div>
        <button class="btn btn-primary" id="confirmChoicesBtn" style="margin-top:12px;">
          Confirm choices
        </button>
        <div class="small" id="choiceStatus" style="margin-top:4px;"></div>
      `;

      const hospitalList = document.getElementById("hospitalList");
      const testsList = document.getElementById("testsList");
      const choiceStatus = document.getElementById("choiceStatus");

      // Build hospital cards
      hospitalList.innerHTML = "";
      Object.entries(hospitalsMap).forEach(([id, label]) => {
        const card = document.createElement("div");
        card.className = "hospital-card";
        card.dataset.hospitalId = id;
        const testsOffered = (hospitalTestsMap[id] || [])
          .map(tid => TESTS[tid])
          .join(", ");
        card.innerHTML = `
          <div class="hospital-name">${label}</div>
          <div class="hospital-meta">
            ER capabilities: ${testsOffered || "Standard emergency care"}
          </div>
        `;
        card.onclick = () => {
          hospitalSelection = id;
          document.querySelectorAll(".hospital-card")
            .forEach(c => c.classList.remove("selected"));
          card.classList.add("selected");
          renderTestsForHospital(id, testsList);
        };
        hospitalList.appendChild(card);
      });

      // Initial tests blank
      testsList.innerHTML =
        "<p class='small'>Select a hospital to see which tests it can perform.</p>";

      document.getElementById("confirmChoicesBtn").onclick = () => {
        if (!hospitalSelection) {
          choiceStatus.textContent = "Please select a receiving hospital.";
          return;
        }
        if (!chosenTriage) {
          choiceStatus.textContent = "Triage selection is missing.";
          return;
        }
        socket.emit("submitHumanDecision", {
          triage: chosenTriage,
          hospitalId: hospitalSelection,
          testIds: Array.from(testSelection)
        });
        choiceStatus.textContent = "Decisions sent. Comparing with AI‚Ä¶";
      };
    }

    function renderTestsForHospital(hospitalId, container) {
      testSelection = new Set(); // reset when hospital changes
      container.innerHTML = "";
      const testIds = hospitalTestsMap[hospitalId] || [];
      if (!testIds.length) {
        container.innerHTML =
          "<p class='small'>This hospital has basic emergency tests only.</p>";
        return;
      }
      testIds.forEach(id => {
        const lab = document.createElement("label");
        lab.innerHTML = `<input type="checkbox" data-test-id="${id}"> ${TESTS[id]}`;
        container.appendChild(lab);
      });
      container.querySelectorAll('input[data-test-id]').forEach(box => {
        box.onchange = () => {
          const id = box.dataset.testId;
          if (box.checked) testSelection.add(id);
          else testSelection.delete(id);
        };
      });
    }

    function showResults(result) {
      rightPanelTitle.textContent = "ü§ñ Step 6 ‚Äî Human vs AI comparison";

      const rows = [
        {
          label: "Triage category",
          human: result.human.triage,
          ai: result.ai.triage,
          match: result.human.triage === result.ai.triage ? "‚úÖ" : "‚ùå"
        },
        {
          label: "Receiving hospital",
          human: result.human.hospitalLabel,
          ai: result.ai.hospitalLabel,
          match: result.human.hospitalLabel === result.ai.hospitalLabel ? "‚úÖ" : "‚ùå"
        },
        {
          label: "ER tests",
          human: result.human.testLabels.join(", ") || "None selected",
          ai: result.ai.testLabels.join(", ") || "None",
          match:
            result.human.testLabels.length === result.ai.testLabels.length &&
            result.human.testLabels.every(t => result.ai.testLabels.includes(t))
              ? "‚úÖ"
              : "‚ùå"
        },
        {
          label: "Decision time",
          human: `${result.human.timeSeconds.toFixed(2)} s`,
          ai: `${result.ai.aiTimeSeconds.toFixed(2)} s`,
          match:
            result.human.timeSeconds < result.ai.aiTimeSeconds
              ? "‚ö° Faster than AI"
              : "‚è± AI faster"
        }
      ];

      rightPanelContent.innerHTML = `
        <table>
          <thead>
            <tr>
              <th>Category</th>
              <th>Human drone operator</th>
              <th>AI triage drone</th>
              <th>Match</th>
            </tr>
          </thead>
          <tbody>
            ${rows
              .map(
                r => `<tr>
                  <td>${r.label}</td>
                  <td>${r.human}</td>
                  <td>${r.ai}</td>
                  <td>${r.match}</td>
                </tr>`
              )
              .join("")}
          </tbody>
        </table>

        <div class="label" style="margin-top:10px;">Score summary</div>
        <div class="score-highlight">${result.scoreBreakdown.total} / 12 points</div>
        <p class="small">
          Correct triage <strong>+5</strong> ‚Ä¢ Correct hospital <strong>+3</strong> ‚Ä¢
          Correct ER tests <strong>+3</strong> ‚Ä¢ Faster than AI <strong>+1</strong>
        </p>

        <h3 style="margin-top:12px;">üß† Why the AI chose this plan</h3>
        <p><strong>Triage:</strong> ${result.explanations.triage}</p>
        <p><strong>Tests:</strong> ${result.explanations.tests}</p>
        <p><strong>Treatment logic:</strong> ${result.explanations.treatment}</p>
      `;
    }

    // ---------- SOCKET HANDLERS ----------

    socket.on("stateUpdate", data => {
      scenarios = data.scenarios || [];
      hospitalsMap = data.hospitals || hospitalsMap;
      hospitalTestsMap = data.hospitalTests || hospitalTestsMap;
      currentGame = data.currentGame;

      // scenario dropdown
      scenarioSelect.innerHTML = "";
      scenarios.forEach(s => {
        const opt = document.createElement("option");
        opt.value = s.id;
        opt.textContent = `${s.id}. ${s.name}`;
        scenarioSelect.appendChild(opt);
      });

      // leaderboard
      leaderboardBody.innerHTML = "";
      (data.leaderboard || []).forEach((entry, idx) => {
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${idx + 1}</td>
          <td>${entry.playerName}</td>
          <td>${entry.mode}</td>
          <td>${entry.scenarioShort}</td>
          <td>${entry.points}</td>
          <td>${entry.timeSeconds.toFixed(2)}</td>
        `;
        leaderboardBody.appendChild(tr);
      });

      if (!currentGame) {
        operatorNameDisplay.textContent = "Waiting for visitor‚Ä¶";
        scenarioNameDisplay.textContent = "No active scenario.";
        resetBodyMap();
        resetVitalsPanel();
        droneStatus.style.display = "none";
        resetTimerDisplay();
        rightPanelTitle.textContent = "üß© Human Triage";
        rightPanelContent.innerHTML =
          "<p class='small'>Start a scenario above, then ask visitors to scan QR tags with their phones.</p>";
        return;
      }

      operatorNameDisplay.textContent = currentGame.playerName;
      scenarioNameDisplay.textContent = currentGame.scenarioName;
      resetBodyMap();
      resetVitalsPanel();
      droneStatus.style.display = "inline-flex";
      droneStatus.textContent = "üõ∞Ô∏è Waiting for first scan‚Ä¶";
      infoMessageEl.textContent = "Scan any patient tag to begin.";
    });

    socket.on("droneLoading", payload => {
      if (!currentGame || !payload || payload.scenarioId !== currentGame.scenarioId) return;
      droneStatus.style.display = "inline-flex";
      droneStatus.textContent = "üõ∞Ô∏è Drone identifying patient‚Ä¶";

      setTimeout(() => { droneStatus.textContent = "üì° Receiving visual feeds‚Ä¶"; }, 800);
      setTimeout(() => { droneStatus.textContent = "üß© Assembling body map‚Ä¶"; }, 1600);
      setTimeout(() => {
        droneStatus.textContent = `‚úÖ Operator: ${currentGame.playerName}`;
      }, 2400);
    });

    socket.on("photoScanned", payload => {
      const row = bodyMap.querySelector(`.body-row[data-index="${payload.index}"]`);
      if (!row) return;
      const photoBox = row.querySelector(".body-photo");
      photoBox.innerHTML = "";
      if (payload.imageUrl) {
        const img = document.createElement("img");
        img.src = payload.imageUrl;
        img.alt = payload.bodyLabel;
        photoBox.appendChild(img);
      } else {
        photoBox.textContent = "Image received";
      }

      // Activate corresponding drone chip with friendly label
      const chipLabelMap = [
        "üî∂ Head scan online",
        "üü¶ Chest & breathing scan",
        "üü™ Abdomen & circulation scan",
        "üü© Limb injury scan",
        "üü´ Leg injury scan"
      ];
      activateDroneChip(payload.index, chipLabelMap[payload.index] || "üõ∞Ô∏è Drone tool active");
    });

    socket.on("vitalScanned", payload => {
      const slot = vitalsPanel.querySelector(`.vital-slot[data-key="${payload.vitalKey}"]`);
      if (slot) {
        const valSpan = slot.querySelector(".vital-value");
        valSpan.textContent = payload.vitalValue;
        valSpan.classList.remove("empty");
        slot.classList.add("vital-highlight");
        setTimeout(() => slot.classList.remove("vital-highlight"), 900);
      }

      const phrases = [
        "Consciousness received ‚Äî continue scanning.",
        "Breathing data received ‚Äî keep going.",
        "Circulation data received ‚Äî almost done.",
        "Body map updating ‚Äî scan remaining tags.",
        "All vitals scanned ‚Äî make your triage decision!"
      ];
      infoMessageEl.textContent =
        phrases[Math.min(payload.count - 1, phrases.length - 1)];
    });

    socket.on("allVitalsCollected", payload => {
      infoMessageEl.textContent =
        "üö® All vitals received. Choose triage, hospital and ER tests.";
      startCountdown(payload.triageTimerSeconds || 60);
      triageLocked = false;
      chosenTriage = null;
      hospitalSelection = null;
      testSelection = new Set();
      showTriageCircles();
    });

    socket.on("resultsReady", result => {
      stopTimerFreezeFinal();
      showResults(result);
    });

    // ----- BUTTONS -----

    startScenarioBtn.onclick = () => {
      const teamName = teamNameInput.value.trim() || "Guest Operator";
      const mode = modeSelect.value;
      const scenarioId = parseInt(scenarioSelect.value, 10);

      if (!scenarioId) {
        setupStatus.textContent = "Please select a scenario.";
        return;
      }

      socket.emit("registerPlayer", { playerName: teamName, mode, scenarioId });
      setupStatus.textContent =
        "Scenario started. Ask the visitor to scan the patient tags with their phone.";
    };

    resetGameBtn.onclick = () => {
      socket.emit("resetGame");
    };

    resetLeaderboardBtn.onclick = () => {
      socket.emit("resetLeaderboard");
    };
  </script>
</body>
</html>
