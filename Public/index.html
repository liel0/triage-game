<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Emergency Drone Simulation ‚Äì Big Screen</title>
  <script src="/socket.io/socket.io.js"></script>

  <style>
    body {
      font-family: system-ui, sans-serif;
      background: #020617;
      color: #e5e7eb;
      margin: 0;
      padding: 20px;
    }

    h1, h2, h3 { margin: 0.4rem 0; }

    .row {
      display: flex;
      gap: 20px;
      margin-top: 20px;
      flex-wrap: wrap;
    }

    .card {
      flex: 1;
      min-width: 320px;
      background: #0f172a;
      border-radius: 12px;
      padding: 16px;
      box-shadow: 0 0 20px rgba(15, 23, 42, 0.7);
    }

    .label {
      font-size: 0.8rem;
      text-transform: uppercase;
      color: #9ca3af;
      letter-spacing: 0.08em;
    }

    .value {
      font-size: 1rem;
      margin-bottom: 0.4rem;
    }

    .vital { margin-bottom: 0.4rem; }

    /* TIMER STYLING */
    .timer-seconds {
      font-size: 2rem;
      font-weight: 700;
    }

    .timer-ms {
      font-size: 1.2rem;
      font-weight: 500;
      opacity: 0.9;
    }

    button {
      padding: 8px 16px;
      border-radius: 999px;
      border: none;
      cursor: pointer;
      margin-top: 8px;
      margin-right: 6px;
    }

    button.primary { background: #2563eb; color: white; }
    button.danger { background: #b91c1c; color: white; }

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.9rem;
      margin-top: 8px;
    }

    th, td {
      border-bottom: 1px solid #1f2937;
      padding: 6px 4px;
      text-align: left;
    }

    .small { font-size: 0.8rem; color: #9ca3af; }
  </style>
</head>

<body>
  <h1>üö® Emergency Drone Simulation ‚Äì Human vs AI Triage</h1>
  <p class="small">
    Players scan QR codes on the mannequins ‚Üí vitals appear here ‚Üí players race the AI.
  </p>

  <div class="row">
    <!-- CURRENT GAME BOX -->
    <div class="card">
      <div class="label">Current Team</div>
      <div class="value" id="teamInfo">Waiting for player...</div>

      <div class="label">Patient</div>
      <div class="value" id="patientInfo">‚Äì</div>

      <div class="label">Vitals (collected)</div>
      <div id="vitalsList">
        <span class="small">No vitals scanned yet.</span>
      </div>

      <div id="timerDisplay" style="margin-top: 10px;">Timer: --</div>
      <div class="small" id="infoMessage"></div>

      <button class="danger" id="resetBtn">Reset Simulation</button>
      <button class="danger" id="resetLeaderboardBtn">Reset Leaderboard</button>
    </div>

    <!-- TRIAGE CONTROL -->
    <div class="card">
      <h2>üß© Human Triage</h2>

      <div class="label">Triage Category</div>
      <select id="triageSelect">
        <option value="">Select...</option>
        <option value="Red">üî¥ Red</option>
        <option value="Yellow">üü° Yellow</option>
        <option value="Green">üü¢ Green</option>
        <option value="Black">‚ö´ Black</option>
      </select>

      <div class="label" style="margin-top: 10px;">ER Tests</div>
      <label class="small"><input type="checkbox" class="testCheckbox" value="IV Fluids"> IV Fluids</label><br>
      <label class="small"><input type="checkbox" class="testCheckbox" value="X-ray"> X-ray</label><br>
      <label class="small"><input type="checkbox" class="testCheckbox" value="Oxygen"> Oxygen</label><br>
      <label class="small"><input type="checkbox" class="testCheckbox" value="CT Scan"> CT Scan</label><br>

      <div class="label" style="margin-top: 10px;">Treatment</div>
      <select id="treatmentSelect">
        <option value="">Select...</option>
        <option value="Emergency Surgery">Emergency Surgery</option>
        <option value="Observation">Observation</option>
        <option value="Discharge with analgesia">Discharge with analgesia</option>
        <option value="CPR / ACLS as appropriate">CPR / ACLS as appropriate</option>
      </select>

      <button class="primary" id="submitDecisionBtn">Submit Decision</button>
      <div class="small" id="submitStatus"></div>
    </div>
  </div>

  <!-- RESULTS & LEADERBOARD -->
  <div class="row">
    <div class="card">
      <h2>ü§ñ Human vs AI Results</h2>
      <table>
        <thead>
          <tr>
            <th>Category</th>
            <th>Human</th>
            <th>AI</th>
            <th>Match</th>
          </tr>
        </thead>
        <tbody id="resultsTableBody"></tbody>
      </table>

      <div class="label" style="margin-top: 10px;">Score</div>
      <div class="value" id="scoreDisplay">‚Äì</div>
    </div>

    <div class="card">
      <h2>üèÜ Leaderboard</h2>
      <table>
        <thead>
          <tr>
            <th>#</th>
            <th>Team</th>
            <th>Mode</th>
            <th>Points</th>
            <th>Time (s)</th>
          </tr>
        </thead>
        <tbody id="leaderboardBody"></tbody>
      </table>
    </div>
  </div>

  <script>
    const socket = io();

    // ===============================
    // GLOBAL REFERENCES
    // ===============================
    let currentGame = null;

    const teamInfoEl = document.getElementById("teamInfo");
    const patientInfoEl = document.getElementById("patientInfo");
    const vitalsListEl = document.getElementById("vitalsList");
    const timerDisplayEl = document.getElementById("timerDisplay");
    const infoMessageEl = document.getElementById("infoMessage");
    const submitStatusEl = document.getElementById("submitStatus");
    const resultsTableBody = document.getElementById("resultsTableBody");
    const scoreDisplayEl = document.getElementById("scoreDisplay");
    const leaderboardBody = document.getElementById("leaderboardBody");

    // ===============================
    // TIMER WITH 2 DECIMALS + STYLING
    // ===============================
    let timerInterval = null;
    let timerStart = null;

    function startTimer(durationSeconds) {
      timerStart = performance.now();
      const endTime = timerStart + durationSeconds * 1000;

      if (timerInterval) clearInterval(timerInterval);

      timerInterval = setInterval(() => {
        const now = performance.now();
        let remaining = endTime - now;

        if (remaining <= 0) {
          remaining = 0;
          clearInterval(timerInterval);
          timerInterval = null;
        }

        const totalSeconds = remaining / 1000;
        const formatted = totalSeconds.toFixed(2); // SS.mm
        const [sec, ms] = formatted.split(".");

        timerDisplayEl.innerHTML =
          `<span class="timer-seconds">${sec}</span>` +
          `<span class="timer-ms">.${ms}</span> s`;
      }, 16);
    }

    function stopTimerAndFreeze() {
      if (timerInterval) {
        clearInterval(timerInterval);
        timerInterval = null;
      }

      if (timerStart !== null) {
        const elapsedSec = (performance.now() - timerStart) / 1000;
        const formatted = elapsedSec.toFixed(2);
        const [sec, ms] = formatted.split(".");

        timerDisplayEl.innerHTML =
          `<span class="timer-seconds">${sec}</span>` +
          `<span class="timer-ms">.${ms}</span> s (final)`;
      }
    }

    function resetTimerDisplay() {
      if (timerInterval) clearInterval(timerInterval);
      timerInterval = null;
      timerStart = null;
      timerDisplayEl.textContent = "Timer: --";
    }

    // ===============================
    // HANDLE SERVER STATE
    // ===============================
    socket.on("stateUpdate", (data) => {
      currentGame = data.currentGame || null;
      leaderboardBody.innerHTML = "";

      // RENDER LEADERBOARD
      (data.leaderboard || []).forEach((entry, i) => {
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${i + 1}</td>
          <td>${entry.playerName}</td>
          <td>${entry.mode}</td>
          <td>${entry.points}</td>
          <td>${entry.timeSeconds.toFixed(2)}</td>
        `;
        leaderboardBody.appendChild(tr);
      });

      // RENDER GAME STATUS
      if (!currentGame) {
        teamInfoEl.textContent = "Waiting for player...";
        patientInfoEl.textContent = "‚Äì";
        vitalsListEl.innerHTML = "<span class='small'>No vitals scanned yet.</span>";
        resetTimerDisplay();
        return;
      }

      teamInfoEl.textContent = currentGame.playerName;
      patientInfoEl.textContent = currentGame.patientName;
    });

    // ===============================
    // VITALS ‚Äî NO DUPLICATES
    // ===============================
    socket.on("vitalScanned", (payload) => {
      // Remove placeholder
      if (
        vitalsListEl.firstChild &&
        vitalsListEl.firstChild.classList &&
        vitalsListEl.firstChild.classList.contains("small")
      ) {
        vitalsListEl.innerHTML = "";
      }

      // Find existing element
      let line = vitalsListEl.querySelector(`.vital[data-key="${payload.vitalKey}"]`);

      // Create if missing
      if (!line) {
        line = document.createElement("div");
        line.className = "vital";
        line.dataset.key = payload.vitalKey;
        vitalsListEl.appendChild(line);
      }

      // Always update text
      line.textContent = `${payload.vitalKey}: ${payload.vitalValue}`;
    });

    socket.on("allVitalsCollected", (payload) => {
      infoMessageEl.textContent = "üö® Vitals complete! Make your triage decision!";
      startTimer(payload.triageTimerSeconds || 60);
    });

    // ===============================
    // RESULTS
    // ===============================
    socket.on("resultsReady", (result) => {
      stopTimerAndFreeze();

      resultsTableBody.innerHTML = "";
      const rows = [
        { category: "Triage", human: result.human.triage, ai: result.ai.triage },
        { category: "Tests", human: result.human.tests.join(", ") || "None", ai: result.ai.tests.join(", ") || "None" },
        { category: "Treatment", human: result.human.treatment, ai: result.ai.treatment },
        { category: "Time", human: `${result.human.timeSeconds.toFixed(2)} s`, ai: `${result.ai.aiTimeSeconds.toFixed(2)} s` }
      ];

      rows.forEach(r => {
        const tr = document.createElement("tr");

        let match = "‚Äì";
        if (r.category !== "Time") {
          match = r.human === r.ai ? "‚úÖ" : "‚ùå";
        } else {
          match = parseFloat(result.human.timeSeconds) < parseFloat(result.ai.aiTimeSeconds) ? "‚ö°" : "‚è±";
        }

        tr.innerHTML = `
          <td>${r.category}</td>
          <td>${r.human}</td>
          <td>${r.ai}</td>
          <td>${match}</td>
        `;
        resultsTableBody.appendChild(tr);
      });

      scoreDisplayEl.textContent = `${result.points} / 12 points`;
    });

    // ===============================
    // RESET BUTTONS
    // ===============================
    document.getElementById("resetBtn").onclick = () => {
      socket.emit("resetGame");
      resetTimerDisplay();
      vitalsListEl.innerHTML = "<span class='small'>No vitals scanned yet.</span>";
      resultsTableBody.innerHTML = "";
      scoreDisplayEl.textContent = "‚Äì";
    };

    document.getElementById("resetLeaderboardBtn").onclick = () => {
      socket.emit("resetLeaderboard");
    };

    // ===============================
    // SUBMIT DECISION
    // ===============================
    document.getElementById("submitDecisionBtn").onclick = () => {
      const triage = document.getElementById("triageSelect").value;
      const treatment = document.getElementById("treatmentSelect").value;

      const tests = Array.from(document.querySelectorAll(".testCheckbox"))
        .filter(c => c.checked)
        .map(c => c.value);

      if (!triage || !treatment) {
        submitStatusEl.textContent = "Please select triage and treatment.";
        return;
      }

      socket.emit("submitHumanDecision", { triage, tests, treatment });
      submitStatusEl.textContent = "Sending decision...";
    };
  </script>
</body>
</html>
