<!-- Public/public-mobile.html -->
<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <title>AI Triage Drone 2040 ‚Äì Mobile Scanner</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <style>
      :root {
        color-scheme: dark;
        --bg: #020617;
        --card: #020617;
        --accent: #22c55e;
        --border: #1f2937;
        --muted: #94a3b8;
      }

      * {
        box-sizing: border-box;
      }

      body {
        margin: 0;
        font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI",
          sans-serif;
        background: radial-gradient(circle at top, #020617 0, #000 60%);
        color: #e5e7eb;
        min-height: 100vh;
        display: flex;
        justify-content: center;
      }

      .shell {
        width: 100%;
        max-width: 480px;
        padding: 16px 14px 24px;
      }

      h1 {
        font-size: 20px;
        margin: 0 0 4px;
        display: flex;
        align-items: center;
        gap: 6px;
      }

      h1 span {
        font-size: 22px;
      }

      .sub {
        font-size: 12px;
        color: var(--muted);
        margin-bottom: 12px;
      }

      .card {
        background: rgba(15, 23, 42, 0.97);
        border-radius: 16px;
        padding: 12px 12px 16px;
        border: 1px solid var(--border);
        box-shadow: 0 14px 35px rgba(0, 0, 0, 0.6);
      }

      label {
        font-size: 13px;
        display: block;
        margin-bottom: 4px;
      }

      input[type="text"] {
        width: 100%;
        padding: 7px 9px;
        border-radius: 999px;
        border: 1px solid var(--border);
        background: #020617;
        color: #e5e7eb;
        font-size: 13px;
      }

      .mode-row {
        display: flex;
        gap: 10px;
        margin: 8px 0 10px;
        font-size: 13px;
      }

      .mode-row label {
        display: flex;
        align-items: center;
        gap: 4px;
        margin-bottom: 0;
      }

      .btn {
        width: 100%;
        margin-top: 8px;
        padding: 9px 12px;
        border-radius: 999px;
        border: 1px solid transparent;
        background: linear-gradient(to right, #22c55e, #0ea5e9);
        color: #022c22;
        font-weight: 600;
        font-size: 14px;
        text-align: center;
      }

      .btn-secondary {
        margin-top: 6px;
        background: #020617;
        border-color: var(--border);
        color: #e5e7eb;
        font-weight: 500;
      }

      #videoContainer {
        margin-top: 14px;
        border-radius: 14px;
        overflow: hidden;
        border: 1px solid var(--border);
        background: #020617;
        position: relative;
      }

      video {
        width: 100%;
        display: block;
        background: #000;
      }

      #scanOverlay {
        position: absolute;
        top: 50%;
        left: 50%;
        width: 65%;
        height: 45%;
        transform: translate(-50%, -50%);
        border: 2px solid rgba(34, 197, 94, 0.9);
        border-radius: 16px;
      }

      #status {
        margin-top: 8px;
        font-size: 13px;
        color: var(--muted);
      }

      #lastTag {
        margin-top: 4px;
        font-size: 11px;
        color: #64748b;
        word-break: break-all;
      }

      #thumb {
        margin-top: 10px;
        width: 100%;
        border-radius: 12px;
        display: none;
      }
    </style>
  </head>
  <body>
    <div class="shell">
      <h1><span>üì±</span>Drone QR Scanner</h1>
      <div class="sub">
        Phone = drone. Point at the mannequin tags to send images and vitals to
        the big screen.
      </div>

      <div class="card">
        <label for="nameInput">Visitor or team name</label>
        <input
          id="nameInput"
          type="text"
          placeholder="Example: Team Alpha or Sara"
        />

        <div class="mode-row">
          <label>
            <input type="radio" name="mode" value="solo" checked />
            Solo
          </label>
          <label>
            <input type="radio" name="mode" value="group" />
            Group
          </label>
        </div>

        <button class="btn" id="startBtn">Save & start scanning</button>
        <button class="btn btn-secondary" id="stopBtn" disabled>
          Stop camera
        </button>

        <div id="videoContainer" style="display: none">
          <video id="preview" playsinline></video>
          <div id="scanOverlay"></div>
        </div>

        <div id="status">Ready. Enter a name and tap ‚ÄúSave & start scanning‚Äù.</div>
        <div id="lastTag"></div>
        <img id="thumb" alt="Last QR image preview" />
      </div>
    </div>

    <canvas id="qrCanvas" style="display: none"></canvas>

    <script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.js"></script>
    <script>
      const startBtn = document.getElementById("startBtn");
      const stopBtn = document.getElementById("stopBtn");
      const video = document.getElementById("preview");
      const canvas = document.getElementById("qrCanvas");
      const ctx = canvas.getContext("2d");
      const statusEl = document.getElementById("status");
      const lastTagEl = document.getElementById("lastTag");
      const thumb = document.getElementById("thumb");
      const videoContainer = document.getElementById("videoContainer");

      let stream = null;
      let scanTimer = null;
      let operatorSet = false;

      function logStatus(msg) {
        statusEl.textContent = msg;
      }

      async function setOperator() {
        const nameInput = document.getElementById("nameInput");
        const modeInput = document.querySelector('input[name="mode"]:checked');
        const name = nameInput.value.trim() || "Visitor";
        const mode = modeInput ? modeInput.value : "solo";

        await fetch("/api/operator", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ name, mode }),
        });

        operatorSet = true;
      }

      async function startCamera() {
        if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
          logStatus(
            "Camera access not supported in this browser. Try Chrome or Safari."
          );
          return;
        }

        try {
          stream = await navigator.mediaDevices.getUserMedia({
            video: { facingMode: "environment" },
          });
          video.srcObject = stream;
          await video.play();
          videoContainer.style.display = "block";
          stopBtn.disabled = false;
          startScanLoop();
          logStatus("Camera active. Hold a QR tag inside the green box.");
        } catch (err) {
          console.error(err);
          logStatus(
            "Could not access camera. Check browser permissions and HTTPS."
          );
        }
      }

      function stopCamera() {
        if (scanTimer) {
          clearInterval(scanTimer);
          scanTimer = null;
        }
        if (stream) {
          stream.getTracks().forEach((t) => t.stop());
          stream = null;
        }
        videoContainer.style.display = "none";
        stopBtn.disabled = true;
        logStatus("Camera stopped. Tap ‚ÄúSave & start scanning‚Äù to resume.");
      }

      function startScanLoop() {
        const scan = () => {
          if (!video.videoWidth) return;
          canvas.width = video.videoWidth;
          canvas.height = video.videoHeight;
          ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
          const imageData = ctx.getImageData(
            0,
            0,
            canvas.width,
            canvas.height
          );
          const code = jsQR(imageData.data, canvas.width, canvas.height, {
            inversionAttempts: "dontInvert",
          });
          if (code && code.data) {
            handleDecoded(code.data);
          }
        };
        if (scanTimer) clearInterval(scanTimer);
        scanTimer = setInterval(scan, 250);
      }

      async function handleDecoded(data) {
        // Do NOT open the URL on the phone ‚Äì just send to server
        lastTagEl.textContent = data;

        if (!operatorSet) {
          await setOperator();
        }

        try {
          const res = await fetch("/api/scan", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ payload: data }),
          });
          const out = await res.json();
          if (out.ok) {
            logStatus(out.message || "Tag received.");
          } else {
            logStatus(out.message || "Tag not recognised.");
          }
        } catch (err) {
          console.error(err);
          logStatus("Error sending tag to server.");
        }

        // If QR contains an image URL, show a thumbnail on the phone for fun
        if (/^https?:\/\//i.test(data) && /\.(png|jpe?g|gif|webp)$/i.test(data)) {
          thumb.src = data;
          thumb.style.display = "block";
        } else {
          thumb.style.display = "none";
        }
      }

      startBtn.addEventListener("click", async () => {
        await setOperator();
        logStatus("Operator saved. Opening camera‚Ä¶");
        await startCamera();
      });

      stopBtn.addEventListener("click", stopCamera);

      window.addEventListener("beforeunload", () => {
        stopCamera();
      });
    </script>
  </body>
</html>
