<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>AI Triage Drone 2040 – Mobile Scanner</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="stylesheet"
        href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" />
  <style>
    :root {
      --bg: #020617;
      --card: #020b1f;
      --accent: #22c55e;
      --accent-soft: rgba(34, 197, 94, 0.15);
      --text-main: #e5e7eb;
      --text-soft: #9ca3af;
      --border-subtle: #111827;
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI",
        sans-serif;
      background: radial-gradient(circle at top, #020617 0, #000 70%);
      color: var(--text-main);
      min-height: 100vh;
      display: flex;
      align-items: stretch;
      justify-content: center;
      padding: 12px;
    }

    .shell {
      width: 100%;
      max-width: 480px;
      background: radial-gradient(circle at top left, #020b1f 0, #020617 60%, #000 100%);
      border-radius: 20px;
      border: 1px solid rgba(148, 163, 184, 0.35);
      padding: 14px 16px 18px;
      box-shadow: 0 20px 40px rgba(0, 0, 0, 0.8);
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 10px;
    }

    header h1 {
      font-size: 16px;
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    header h1 span.icon {
      background: linear-gradient(135deg, #22c55e, #0ea5e9);
      width: 28px;
      height: 28px;
      border-radius: 999px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      color: #020617;
    }

    header p {
      font-size: 11px;
      color: var(--text-soft);
      text-align: right;
    }

    .card {
      background: rgba(15, 23, 42, 0.7);
      border-radius: 16px;
      padding: 10px 12px;
      border: 1px solid rgba(148, 163, 184, 0.3);
    }

    .card h2 {
      font-size: 13px;
      font-weight: 600;
      margin-bottom: 8px;
      display: flex;
      align-items: center;
      gap: 6px;
      color: var(--text-soft);
      text-transform: uppercase;
      letter-spacing: 0.08em;
    }

    .card h2 i {
      color: var(--accent);
    }

    label {
      font-size: 12px;
      color: var(--text-soft);
      margin-bottom: 4px;
      display: block;
    }

    input[type="text"] {
      width: 100%;
      border-radius: 999px;
      padding: 7px 10px;
      border: 1px solid rgba(148, 163, 184, 0.6);
      background: #020617;
      color: var(--text-main);
      font-size: 13px;
    }

    .mode-row {
      display: flex;
      gap: 10px;
      margin-top: 6px;
    }

    .mode-pill {
      flex: 1;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 4px;
      font-size: 12px;
      border-radius: 999px;
      border: 1px solid rgba(148, 163, 184, 0.6);
      padding: 6px 0;
      cursor: pointer;
      color: var(--text-soft);
    }

    .mode-pill.active {
      background: var(--accent-soft);
      border-color: var(--accent);
      color: var(--accent);
    }

    .primary-btn {
      margin-top: 8px;
      width: 100%;
      border-radius: 999px;
      border: none;
      background: linear-gradient(135deg, #22c55e, #0ea5e9);
      color: #020617;
      padding: 8px 14px;
      font-size: 13px;
      font-weight: 600;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
    }

    .primary-btn:disabled {
      opacity: 0.6;
      cursor: default;
    }

    .status-line {
      margin-top: 6px;
      font-size: 11px;
      color: var(--text-soft);
    }

    .status-line span {
      color: var(--accent);
    }

    .scanner-card {
      flex: 1;
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    #qr-reader {
      width: 100%;
      border-radius: 12px;
      overflow: hidden;
    }

    .hint-text {
      font-size: 11px;
      color: var(--text-soft);
      margin-top: 4px;
    }

    .hint-text strong {
      color: var(--accent);
    }

    footer {
      font-size: 10px;
      color: var(--text-soft);
      text-align: center;
      margin-top: 2px;
    }
  </style>
</head>
<body>
  <div class="shell">
    <header>
      <div>
        <h1>
          <span class="icon"><i class="fa-solid fa-qrcode"></i></span>
          Drone Operator
        </h1>
        <p>Use this phone as the <strong>AI triage drone</strong>. Scan only the tags on the mannequin.</p>
      </div>
      <div style="font-size:11px;color:var(--accent);text-align:right;">
        Connected to<br /><span id="connectionLabel">main screen…</span>
      </div>
    </header>

    <!-- Operator info -->
    <div class="card">
      <h2><i class="fa-solid fa-user"></i>Operator details</h2>
      <label for="nameInput">Name or team</label>
      <input id="nameInput" type="text" placeholder="Example: Riyadh EMS Team" />

      <div class="mode-row">
        <div class="mode-pill active" data-mode="Solo">
          <i class="fa-solid fa-user"></i> Solo
        </div>
        <div class="mode-pill" data-mode="Group">
          <i class="fa-solid fa-users"></i> Group
        </div>
      </div>

      <button id="startSessionBtn" class="primary-btn">
        <i class="fa-solid fa-plug-circle-bolt"></i> Connect &amp; start scanning
      </button>

      <div class="status-line">
        Status: <span id="statusText">Not connected yet.</span>
      </div>
    </div>

    <!-- Scanner -->
    <div class="card scanner-card">
      <h2><i class="fa-solid fa-qrcode"></i>Scan patient tags</h2>
      <div id="qr-reader" style="display:none;"></div>
      <button id="startScanBtn" class="primary-btn" disabled>
        <i class="fa-solid fa-camera"></i> Start QR camera
      </button>
      <div class="hint-text">
        Scan the tags on: <strong>head, chest, abdomen, arms, legs / ID</strong>.  
        Each tag loads a different drone view and vital on the big screen.
      </div>
    </div>

    <footer>
      If camera does not open, check browser permissions for camera access.
    </footer>
  </div>

  <script src="/socket.io/socket.io.js"></script>
  <script src="https://unpkg.com/html5-qrcode@2.3.10/html5-qrcode.min.js"></script>
  <script>
    const socket = io();

    const nameInput = document.getElementById("nameInput");
    const modePills = document.querySelectorAll(".mode-pill");
    const startSessionBtn = document.getElementById("startSessionBtn");
    const startScanBtn = document.getElementById("startScanBtn");
    const statusText = document.getElementById("statusText");
    const connectionLabel = document.getElementById("connectionLabel");
    const qrReaderContainer = document.getElementById("qr-reader");

    let currentMode = "Solo";
    let sessionStarted = false;
    let scanner = null;

    modePills.forEach((pill) => {
      pill.addEventListener("click", () => {
        modePills.forEach((p) => p.classList.remove("active"));
        pill.classList.add("active");
        currentMode = pill.dataset.mode || "Solo";
      });
    });

    socket.on("connect", () => {
      connectionLabel.textContent = "main screen ready";
    });

    socket.on("disconnect", () => {
      connectionLabel.textContent = "disconnected";
      statusText.textContent = "Lost connection. Try refreshing the page.";
    });

    startSessionBtn.addEventListener("click", () => {
      const name = nameInput.value.trim() || "Visitor";
      const payload = { name, mode: currentMode };
      socket.emit("operatorInfo", payload);
      sessionStarted = true;
      statusText.textContent = `Connected as ${name} (${currentMode}). You can start scanning.`;
      startScanBtn.disabled = false;
    });

    startScanBtn.addEventListener("click", () => {
      if (!sessionStarted) {
        statusText.textContent = "Connect first, then start scanning.";
        return;
      }
      startScanBtn.style.display = "none";
      qrReaderContainer.style.display = "block";
      initScanner();
    });

    function parseQr(decodedText) {
      // We accept full URLs or just filenames.
      let pathname = decodedText;
      try {
        const url = new URL(decodedText);
        pathname = url.pathname;
      } catch (e) {
        // not a full URL, that's fine
      }
      const fileName = pathname.split("/").pop() || "";
      const m = fileName.match(/s([1-4])_(head|chest|abdomen|arms|legs)\.(jpg|jpeg|png)$/i);
      if (!m) return null;
      return {
        scenarioId: "s" + m[1],
        bodyPart: m[2].toLowerCase(),
        imageUrl: decodedText,
      };
    }

    function initScanner() {
      const html5QrcodeScanner = new Html5Qrcode("qr-reader");

      function onScanSuccess(decodedText) {
        const parsed = parseQr(decodedText);
        if (!parsed) {
          statusText.textContent =
            "Tag scanned but format not recognised. Confirm image name like s1_head.jpg.";
          return;
        }
        socket.emit("scanVital", parsed);
        statusText.textContent =
          "Tag accepted: " +
          parsed.scenarioId.toUpperCase() +
          " " +
          parsed.bodyPart +
          ". Check the big screen.";
      }

      function onScanFailure(error) {
        // ignore continuous errors, we only care about successes
      }

      html5QrcodeScanner.start(
        { facingMode: "environment" },
        {
          fps: 8,
          qrbox: { width: 240, height: 240 },
        },
        onScanSuccess,
        onScanFailure
      );
      scanner = html5QrcodeScanner;
    }
  </script>
</body>
</html>
